<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUET by BCAG</title>

    <!-- Google Fonts: ä¸­æ–‡é‹¼ç­†å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Noto+Serif+TC:wght@400;500;600&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: #000;
            /* å…ˆè¨­å®šé»‘è‰²èƒŒæ™¯ï¼Œé¿å…ç™½è‰²é–ƒçˆ */
            background-image: url('https://raw.githubusercontent.com/brendon-create/duet-openscad/main/images/background1.png?v=1');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px) saturate(100%);
            -webkit-backdrop-filter: blur(10px) saturate(100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }

        #control-panel {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            padding: 24px;
            border-radius: 20px;
            z-index: 100;
        }

        #control-panel::-webkit-scrollbar {
            width: 4px;
        }

        #control-panel::-webkit-scrollbar-track {
            margin: 20px 0;
        }

        #control-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .panel-header .subtitle {
            font-size: 11px;
            color: #d4af37;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 300;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #d4af37;
            margin-bottom: 16px;
        }

        .control-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-row>div:first-child {
            flex: 1;
        }

        .flex-row>div:last-child {
            flex: 2;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #d4af37;
        }

        .font-select-btn {
            width: 100%;
            padding: 12px 16px;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: #d4af37;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        /* å­—é«”ä¸‹æ‹‰é¸å–®ä¸­çš„é¸é …ä»¥å„è‡ªå­—é«”é¡¯ç¤º */
        select.font-select-btn {
            font-family: inherit;
        }

        select.font-select-btn option {
            background: #1a1a2e;
            color: #fff;
            padding: 8px;
            font-size: 14px;
        }

        .font-select-btn:hover {
            background: rgba(212, 175, 55, 0.25);
            border-color: #d4af37;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }

        .slider-value {
            float: right;
            color: #d4af37;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #000;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.3);
            display: flex;
            align-items: center;
        }

        #addToCartBtn {
            justify-content: space-between;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .view-cart-section {
            width: 70px;
            border-left: 1px solid rgba(0, 0, 0, 0.2);
            padding-left: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 9px;
            cursor: pointer;
        }

        .view-cart-section:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .info-value {
            color: #d4af37;
            font-weight: 600;
            text-align: right;
        }

        #saved-versions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .version-slot {
            width: 160px;
            height: 160px;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .version-slot:hover {
            transform: scale(1.05);
        }

        .version-slot.empty {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px) saturate(100%);
            -webkit-backdrop-filter: blur(10px) saturate(100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .version-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            font-size: 10px;
            text-align: center;
            color: #d4af37;
        }

        #viewport {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }

        /* Font Selector Modal */
        #font-selector-modal {
            display: none;
            position: fixed;
            top: 20px;
            left: 360px;
            right: 20px;
            max-height: calc(100vh - 40px);
            border-radius: 16px;
            z-index: 2000;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }

        #font-selector-modal.active {
            display: block;
        }

        .close-modal-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
            width: auto;
            padding: 0;
            line-height: 1;
        }

        .close-modal-btn:hover {
            color: #d4af37;
        }

        .modal-layout {
            display: flex;
            height: calc(100vh - 40px);
        }

        .font-sidebar {
            width: 20%;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .font-sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .font-sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        .char-input-group {
            margin-bottom: 20px;
        }

        .char-input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            text-align: center;
            font-size: 18px;
            border-radius: 8px;
        }

        .select-all-group {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .select-all-group input {
            margin-right: 10px;
            cursor: pointer;
        }

        .font-list-item {
            display: flex;
            align-items: center;
            padding: 10px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: background 0.2s;
        }

        .font-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .font-list-item input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .font-list-item span {
            font-size: 13px;
            color: #ccc;
        }

        .font-display-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            align-content: start;
        }

        .font-display-area::-webkit-scrollbar {
            width: 6px;
        }

        .font-display-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .font-preview-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid transparent;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 140px;
        }

        .font-preview-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .font-preview-card.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.15);
        }

        .preview-char {
            font-size: 48px;
            margin-bottom: 8px;
            color: #fff;
        }

        .preview-name {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        .confirm-container {
            position: absolute;
            /* æ”¹ç‚º absoluteï¼Œç›¸å°æ–¼ font-selector-modal */
            bottom: 30px;
            right: 30px;
            z-index: 2002;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #000;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.3);
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        /* Cart Modal */
        #cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #cart-modal.active {
            display: flex;
        }

        .cart-container {
            width: 80%;
            max-width: 900px;
            height: 80%;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .cart-items {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .cart-item {
            padding: 20px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .cart-item-details {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }

        .cart-item-price {
            font-size: 20px;
            font-weight: 700;
            color: #d4af37;
            margin-right: 20px;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-input {
            width: 60px;
            padding: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            -moz-appearance: textfield;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-btns {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .qty-btn {
            width: 24px;
            height: 20px;
            padding: 0;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .delete-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4444;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 0.3);
        }

        .cart-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #d4af37;
        }

        .cart-actions {
            display: flex;
            gap: 12px;
        }

        .cart-actions button {
            flex: 1;
            text-align: center;
            justify-content: center;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            letter-spacing: 3px;
        }

        /* å„ªæƒ ç¢¼æ¬„ä½æ¨£å¼ */
        #promo-code-input:focus {
            border-color: #d4af37;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3);
        }

        #promo-code-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }

        #apply-promo-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.3), inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        #apply-promo-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #apply-promo-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal æ»¾å‹•æ¢æ¨£å¼ */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.7);
        }

        /* ========== AI è«®è©¢é€£çµæ¨£å¼ (æ–°å¢) ========== */
        .ai-consultant-link {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .ai-consultant-link a {
            color: #d4af37;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            cursor: pointer;
        }

        .ai-consultant-link a:hover {
            color: #f4d03f;
        }

        /* éš±è—è¨­è¨ˆç†å¿µå¡ç‰‡çš„æ»¾è»¸ */
        #story-content::-webkit-scrollbar {
            display: none;
        }

        /* é»é»å‹•ç•« */
        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .dots-animation::after {
            content: '';
            animation: dots 1.5s infinite;
        }
    </style>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text">LOADING STUDIO...</div>
    </div>

    <div id="viewport"></div>

    <div id="control-panel" class="glass">
        <div class="panel-header">
            <h1>DUET</h1>
            <div class="subtitle">BY BCAG</div>
        </div>

        <div class="section">
            <div class="control-group">
                <label>Letter 1</label>
                <div class="flex-row">
                    <div><select id="letter1"></select></div>
                    <div><button class="font-select-btn" id="font1-btn">Choose Fonts</button></div>
                </div>
            </div>

            <div class="control-group">
                <label>Letter 2</label>
                <div class="flex-row">
                    <div><select id="letter2"></select></div>
                    <div><button class="font-select-btn" id="font2-btn">Choose Fonts</button></div>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="control-group">
            <label>æè³ª (Material)</label>
            <select id="material">
                <option value="silver925">925 éŠ€</option>
                <option value="brass">é»ƒéŠ…</option>
            </select>
        </div>

        <div class="control-group">
            <label>è¡¨é¢é›»é (Plating)</label>
            <select id="plating">
                <option value="none">ç„¡</option>
                <option value="gold18k">18K é‡‘</option>
                <option value="whitegold18k">18K ç™½Ké‡‘</option>
                <option value="rosegold18k">18K ç«ç‘°é‡‘</option>
            </select>
        </div>

        <div class="control-group">
            <label>è¡¨é¢è³ªåœ° (Finish)</label>
            <select id="finish">
                <option value="glossy">äº®é¢</option>
                <option value="matte">éœ§é¢</option>
            </select>
        </div>

        <div class="control-group">
            <label>Size (Height)</label>
            <select id="size">
                <option value="8">8 mm</option>
                <option value="10">10 mm</option>
                <option value="12">12 mm</option>
                <option value="15" selected>15 mm</option>
                <option value="18">18 mm</option>
            </select>
        </div>

        <div class="divider"></div>

        <div class="section-title">Bail Position</div>

        <div class="control-group">
            <label>X (Left/Right) <span class="slider-value" id="bailX-val">0.0</span></label>
            <input type="range" id="bailX" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Y (Front/Back) <span class="slider-value" id="bailY-val">0.0</span></label>
            <input type="range" id="bailY" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Z (Up/Down) <span class="slider-value" id="bailZ-val">0.0</span></label>
            <input type="range" id="bailZ" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Rotation <span class="slider-value" id="bailRotation-val">0Â°</span></label>
            <input type="range" id="bailRotation" min="0" max="90" step="1" value="0">
        </div>

        <div class="divider"></div>

        <div class="info-box">
            <div class="info-row">
                <span class="info-label">åƒ¹æ ¼</span>
                <span class="info-value" id="price-display">NT$ 3,850</span>
            </div>
            <!-- é«”ç©é‡é‡è³‡è¨Šéš±è—ï¼Œä½†ä¿ç•™åœ¨ DOM ä¸­ä¾›å¾Œç«¯ä½¿ç”¨ -->
            <input type="hidden" id="volume-display" value="- mmÂ³">
            <input type="hidden" id="weight-display" value="- g">
        </div>

        <!-- å­—é«”é è¼‰å…¥é€²åº¦æç¤º -->
        <div id="font-preload-status"
            style="display: none; margin-top: 12px; padding: 12px; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 12px; font-size: 11px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #d4af37;">
                <div
                    style="width: 12px; height: 12px; border: 2px solid rgba(212, 175, 55, 0.3); border-top-color: #d4af37; border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
                <span id="preload-text">é è¼‰å…¥å­—é«”ä¸­...</span>
            </div>
            <div style="margin-top: 6px; font-size: 10px; color: rgba(255, 255, 255, 0.5);" id="preload-progress">0 / 0
            </div>
        </div>

        <button class="btn-secondary" id="save-slot-1">Save to Slot 1</button>
        <button class="btn-secondary" id="save-slot-2">Save to Slot 2</button>

        <!-- 3D æ¨¡å‹é‡å»ºæç¤º -->
        <div id="model-rebuilding-indicator" style="
            display: none;
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 6px;
            font-size: 10px;
            color: rgba(212, 175, 55, 0.6);
            text-align: center;
            font-style: italic;
        ">
            âš™ï¸ Re-constructing 3D model<span class="dots-animation"></span>
        </div>

        <button class="btn-primary" id="addToCartBtn">
            <span style="flex: 1;">Add to Cart</span>
            <div class="view-cart-section" id="viewCartBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="margin-bottom: 2px;">
                    <circle cx="9" cy="21" r="1" />
                    <circle cx="20" cy="21" r="1" />
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                </svg>
                <span style="margin-top: 2px;">View Cart</span>
            </div>
        </button>

        <!-- AI è«®è©¢é€£çµ -->
        <div class="ai-consultant-link">
            <a onclick="openDesignConsultant()">
                <span>ğŸ’</span>
                <span>é‡æ–°é–‹å§‹ AI è¨­è¨ˆè«®è©¢</span>
            </a>
        </div>
    </div>

    <div id="saved-versions">
        <div class="version-slot empty" data-slot="1">
            <div class="version-label">SLOT 1</div>
        </div>
        <div class="version-slot empty" data-slot="2">
            <div class="version-label">SLOT 2</div>
        </div>
    </div>

    <!-- ä½©æˆ´æ¨¡æ“¬é è¦½ -->
    <!-- Wearing Preview - Temporarily Disabled -->
    <!-- 
    <div id="wearing-preview-container" class="glass" style="
        position: absolute;
        top: 200px;
        right: 20px;
        width: 332px;
        bottom: 20px;
        z-index: 50;
        border-radius: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
    ">
    </div>
    -->

    <!-- Font Selector Modal -->
    <div id="font-selector-modal">
        <button class="close-modal-btn" id="close-modal">Ã—</button>

        <div class="modal-layout">
            <aside class="font-sidebar">
                <div class="char-input-group">
                    <input type="text" id="char-input" maxlength="2" placeholder="type in 2 letters" value="">
                </div>

                <div class="select-all-group">
                    <input type="checkbox" id="select-all-checkbox">
                    <label for="select-all-checkbox">å…¨é¸ / å…¨éƒ¨å–æ¶ˆ</label>
                </div>

                <div id="font-list-container"></div>
            </aside>

            <section class="font-display-area" id="font-display-area"></section>
        </div>

        <div class="confirm-container">
            <button class="confirm-btn" id="confirm-btn">Confirm Selection</button>
        </div>
    </div>

    <!-- Design Story Card Modal -->
    <div id="design-story-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            width: 560px;
            height: 400px;
            position: relative;
            padding: 60px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        " id="story-card" data-style="classic">
            <!-- è¨­è¨ˆç†å¿µå…§å®¹ -->
            <div id="story-content" contenteditable="true" style="
                font-family: 'Noto Serif TC', serif;
                font-size: 15px;
                line-height: 1.8;
                letter-spacing: 0.3px;
                flex: 1;
                text-align: justify;
                padding: 0;
                overflow-y: auto;
                max-height: 100%;
                outline: none;
                scrollbar-width: none;
                -ms-overflow-style: none;
            " placeholder="æ‚¨çš„è¨­è¨ˆç†å¿µå°‡é¡¯ç¤ºåœ¨é€™è£¡...">
                é€™æ˜¯ä¸€å€‹é—œæ–¼å…©å€‹å­—æ¯çš„æ•…äº‹...
            </div>

            <!-- ç°½åæ¬„ä½ -->
            <div style="
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 30px;
            ">
                <span style="font-size: 14px; opacity: 0.6;">è¨­è¨ˆå¸«</span>
                <div style="
                    width: 120px;
                    height: 1px;
                    background: currentColor;
                    opacity: 0.3;
                "></div>
            </div>
        </div>

        <!-- å¡ç‰‡åˆ‡æ›æ§åˆ¶ï¼ˆç§»åˆ°ä¸Šæ–¹ï¼‰ -->
        <div style="
            position: absolute;
            bottom: 125px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        ">
            <button id="prev-card-style" style="
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            " onmouseover="this.style.color='rgba(255,255,255,1)'"
                onmouseout="this.style.color='rgba(255,255,255,0.6)'">
                â†
            </button>
            <span id="card-style-name" style="
                font-size: 13px;
                color: rgba(255, 255, 255, 0.8);
                min-width: 80px;
                text-align: center;
            ">ç¶“å…¸é¢¨æ ¼</span>
            <button id="next-card-style" style="
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            " onmouseover="this.style.color='rgba(255,255,255,1)'"
                onmouseout="this.style.color='rgba(255,255,255,0.6)'">
                â†’
            </button>
        </div>

        <!-- ç·¨è¼¯æç¤ºï¼ˆåœ¨å¡ç‰‡å¤–ï¼Œé è¿‘å¡ç‰‡ï¼‰ -->
        <div style="
            position: absolute;
            bottom: 195px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        ">
            ğŸ’¡ é»æ“Šå¡ç‰‡å…§æ–‡å­—å¯ç·¨è¼¯
        </div>

        <!-- ç¢ºå®šæŒ‰éˆ•ï¼ˆç§»åˆ°æœ€ä¸‹æ–¹ï¼Œæ”¹å°ï¼‰ -->
        <button id="confirm-story-card" style="
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: rgba(212, 175, 55, 0.9);
            padding: 8px 32px;
            border-radius: 18px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        " onmouseover="this.style.background='rgba(212, 175, 55, 0.25)'; this.style.borderColor='rgba(212, 175, 55, 0.5)'"
            onmouseout="this.style.background='rgba(212, 175, 55, 0.15)'; this.style.borderColor='rgba(212, 175, 55, 0.3)'">
            ç¢ºå®š
        </button>
    </div>

    <!-- Cart Modal -->
    <!-- Checkout Reminder Modal (ç»ç’ƒæ“¬æ…‹ç²¾ç·»å½ˆçª—) -->
    <div id="checkout-reminder-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(15px);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 32px;
            padding: 50px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            position: relative;
        ">
            <!-- æ¨™é¡Œ -->
            <div style="text-align: center; margin-bottom: 35px;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ’</div>
                <h2 style="
                    font-size: 28px;
                    font-weight: 600;
                    color: #fff;
                    margin: 0 0 12px 0;
                    letter-spacing: 0.5px;
                ">å³å°‡å®Œæˆæ‚¨çš„å°ˆå±¬ä½œå“</h2>
                <p style="
                    font-size: 15px;
                    color: rgba(255, 255, 255, 0.7);
                    margin: 0;
                ">é‚„æœ‰ä¸€å€‹ç‰¹åˆ¥çš„æ­¥é©Ÿåœ¨ç­‰è‘—æ‚¨...</p>
            </div>

            <!-- å…§å®¹ -->
            <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
            ">
                <ul style="
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    color: #fff;
                    line-height: 2;
                ">
                    <li style="margin-bottom: 18px; font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">âœ¨</span>
                        ç³»çµ±å°‡ç‚ºæ‚¨ç”Ÿæˆå°ˆå±¬è¨­è¨ˆç†å¿µ
                    </li>
                    <li style="margin-bottom: 18px; font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">ğŸ“</span>
                        æˆ‘å€‘æœƒè©¢å•æ‚¨å¹¾å€‹é—œæ–¼å­—é«”çš„å•é¡Œ
                    </li>
                    <li style="font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">ğŸ¨</span>
                        æœ€å¾Œå‘ˆç¾ç²¾ç¾çš„è¨­è¨ˆç†å¿µå¡ç‰‡
                    </li>
                </ul>
            </div>

            <!-- æé†’æ–‡å­— -->
            <div style="
                text-align: center;
                padding: 20px;
                background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
                border-radius: 16px;
                border: 1px solid rgba(212, 175, 55, 0.3);
                margin-bottom: 35px;
            ">
                <p style="
                    color: #d4af37;
                    font-size: 15px;
                    font-weight: 500;
                    margin: 0;
                    line-height: 1.8;
                ">
                    â³ è«‹åœ¨ä»˜æ¬¾å®Œæˆå¾Œï¼Œç¨å€™ç‰‡åˆ»ä¸è¦é—œé–‰è¦–çª—
                </p>
            </div>

            <!-- æŒ‰éˆ• -->
            <button id="proceed-to-checkout-btn" style="
                width: 100%;
                padding: 18px;
                background: linear-gradient(135deg, #d4af37, #f4d03f);
                border: none;
                border-radius: 16px;
                color: #000;
                font-size: 17px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(212, 175, 55, 0.5)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(212, 175, 55, 0.4)'">
                æˆ‘çŸ¥é“äº†ï¼Œå‰å¾€çµå¸³
            </button>
        </div>
    </div>

    <div id="cart-modal">
        <div class="cart-container">
            <div class="cart-header">
                <h2>Shopping Cart</h2>
            </div>
            <div class="cart-items" id="cart-items"></div>

            <div class="cart-footer">
                <!-- å„ªæƒ ç¢¼å€å¡Š -->
                <div
                    style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: bold; color: #d4af37; font-size: 14px;">
                        ğŸ å„ªæƒ ç¢¼
                    </label>
                    <div style="display: flex; align-items: stretch; gap: 10px; width: 100%;">
                        <input type="text" id="promo-code-input" placeholder="è¼¸å…¥å„ªæƒ ç¢¼" maxlength="20" style="flex: 1; 
                                      min-width: 0;
                                      padding: 10px 12px; 
                                      border: 1px solid rgba(255,255,255,0.3); 
                                      background: rgba(255,255,255,0.1); 
                                      color: white; 
                                      border-radius: 5px; 
                                      font-size: 14px; 
                                      text-transform: uppercase;
                                      outline: none;
                                      transition: all 0.3s;">
                        <button id="apply-promo-btn" type="button" onclick="applyPromoCode()" class="glass" style="flex-shrink: 0;
                                       width: 70px;
                                       padding: 10px 12px; 
                                       background: rgba(255, 255, 255, 0.08);
                                       backdrop-filter: blur(10px) saturate(100%);
                                       -webkit-backdrop-filter: blur(10px) saturate(100%);
                                       border: 1px solid rgba(255, 255, 255, 0.2);
                                       box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2), inset 0 1px 0 0 rgba(255, 255, 255, 0.15);
                                       color: white; 
                                       border-radius: 8px; 
                                       cursor: pointer; 
                                       font-weight: bold; 
                                       font-size: 14px; 
                                       white-space: nowrap; 
                                       transition: all 0.3s;">
                            å¥—ç”¨
                        </button>
                    </div>
                    <div id="promo-message" style="margin-top: 8px; font-size: 13px; min-height: 18px;"></div>
                </div>

                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cart-total">NT$ 0</span>
                </div>
                <div class="cart-actions">
                    <button class="btn-secondary" id="continue-shopping">Continue Shopping</button>
                    <button class="btn-primary" id="checkout">Checkout</button>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://esm.sh/three@0.160.0",
            "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
            "three-mesh-bvh": "https://esm.sh/three-mesh-bvh@0.7.3",
            "three-bvh-csg": "https://esm.sh/three-bvh-csg@0.0.16?deps=three@0.160.0,three-mesh-bvh@0.7.3",
            "opentype": "https://esm.sh/opentype.js@1.3.4"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { STLExporter } from 'three/addons/exporters/STLExporter.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { Evaluator, Brush, INTERSECTION } from 'three-bvh-csg';
        import opentype from 'opentype';

        // ä¾›é module è…³æœ¬ï¼ˆwearing-preview.jsï¼‰ä½¿ç”¨ three.js é¡åˆ¥
        // ï¼ˆä¾‹å¦‚ Box3 / Vector3 æŠ•å½±è¨ˆç®—ï¼Œä»¥ä¾¿æˆªå–å¢œé£¾å€åŸŸï¼‰
        window.THREE = THREE;

        // ============================================================
        // DUET å¾Œç«¯æ•´åˆ - æ·»åŠ æ–¼ 2024
        // ============================================================
        // ========== AI è«®è©¢æ•´åˆç¨‹å¼ç¢¼ (æ–°å¢) ==========

        // é¡¯ç¤º AI æ­¡è¿è¨Šæ¯
        function showAIWelcomeMessage() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #d4af37, #f4d03f);
                color: #000;
                padding: 15px 30px;
                border-radius: 50px;
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            `;
            notification.textContent = 'âœ¨ AI å·²ç‚ºæ‚¨æº–å‚™å¥½æ¨è–¦å­—é«”';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        // è¼‰å…¥æ¨è–¦å­—é«”
        function loadRecommendedFonts(recommendations) {
            const fonts = [
                ...recommendations.letter1.map(r => r.font),
                ...recommendations.letter2.map(r => r.font)
            ];

            const uniqueFonts = [...new Set(fonts)];

            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?${uniqueFonts.map(f => `family=${f.replace(/ /g, '+')}`).join('&')}&display=swap`;
            document.head.appendChild(link);
        }
        // é¡¯ç¤º AI æ¨è–¦æç¤ºï¼ˆåœ¨å­—é«”é¸æ“‡è¦–çª—ä¸­ï¼‰
        function showAINotification() {
            // âœ… å·²åœç”¨æ­¤æç¤º
            return;
        }
        // é¡¯ç¤º AI ä»‹ç´¹ Modal
        function showAIIntroModal() {
            console.log('ğŸ”” æº–å‚™é¡¯ç¤º AI ä»‹ç´¹ Modal');
            // ç¢ºä¿æ²’æœ‰ç¾æœ‰çš„ modal
            const existingModal = document.getElementById('ai-intro-modal');
            if (existingModal) {
                existingModal.remove();
            }
            const modal = document.createElement('div');
            modal.id = 'ai-intro-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.75); backdrop-filter: blur(20px); 
                            display: flex; justify-content: center; align-items: center; z-index: 10000;
                            animation: fadeIn 0.5s ease-out;">
                    <div style="background: rgba(26, 26, 26, 0.85);
                                backdrop-filter: blur(10px) saturate(100%);
                                border: 1px solid rgba(212, 175, 55, 0.3); 
                                border-radius: 24px;
                                padding: 45px 55px; 
                                max-width: 580px; 
                                color: #fff;
                                box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                                animation: scaleIn 0.5s ease-out;
                                font-family: 'Cormorant Garamond', serif;">
                        <div style="text-align: center; font-size: 34px; color: #d4af37; 
                                    font-weight: 300; letter-spacing: 8px; margin-bottom: 25px;
                                    font-family: 'Cormorant Garamond', serif;">
                            DUET
                        </div>
                        <h2 style="color: #d4af37; text-align: center; font-size: 24px; 
                                   font-weight: 400; letter-spacing: 2px; margin-bottom: 25px;
                                   font-family: 'Cormorant Garamond', serif;">
                            é–‹å•Ÿæ‚¨çš„å°ˆå±¬è¨­è¨ˆæ—…ç¨‹
                        </h2>
                        <p style="text-align: center; line-height: 1.9; color: #ccc; 
                                  margin-bottom: 30px; font-size: 15px;">
                            BCAG è¨‚è£½ç å¯¶çš„è¨­è¨ˆç¸½ç›£ï¼Œç‚º DUET ç³»åˆ—çš„ AI æ ¸å¿ƒ<br>
                            æ¤å…¥äº†è¶…é 20 å¹´è¨‚è£½ç å¯¶çš„è«®è©¢ç¶“é©—ã€‚
                        </p>
                        <ul style="list-style: none; margin-bottom: 35px;">
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; 
                                       font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">ğŸ’</span>
                                <span>é€éç°¡å–®çš„å¹¾å€‹å•ç­”ï¼Œå¼•å°æ‚¨ç™¼æ˜è¨­è¨ˆçš„ç¨ç‰¹æ„ç¾©</span>
                            </li>
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">âœ¨</span>
                                <span>åœ¨ä¸Šç™¾æ¬¾å¯é¸å­—é«”ä¸­ï¼Œç‚ºæ‚¨æ¨è–¦å¯èƒ½é©åˆæ‚¨çš„å­—é«”</span>
                            </li>
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">ğŸ</span>
                                <span>çµå¸³å¾Œé‚„æœ‰å°ˆå±¬å°é©šå–œ</span>
                            </li>
                        </ul>
                        <button onclick="startAIConsultation()" 
                                style="width: 100%; background: linear-gradient(135deg, #8E795E, #a89276);
                                       color: #fff; border: none; padding: 15px 35px; border-radius: 50px;
                                       font-size: 15px; font-weight: 500; cursor: pointer; margin-bottom: 10px;
                                       transition: 0.3s; letter-spacing: 1px;
                                       font-family: 'Cormorant Garamond', serif;">
                            é–‹å§‹æˆ‘çš„è¨­è¨ˆæ—…ç¨‹
                        </button>
                        <button onclick="skipAIConsultation()"
                                style="width: 100%; background: transparent; color: #888; border: none;
                                       padding: 10px; font-size: 13px; cursor: pointer;
                                       font-family: 'Cormorant Garamond', serif;">
                            ä¸éœ€è¦ï¼Œæˆ‘æƒ³è‡ªå·±é¸æ“‡å­—æ¯èˆ‡å­—é«”ï¼Œç›´æ¥é–‹å§‹
                        </button>
                    </div>
                </div>
                <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes scaleIn {
                    from { opacity: 0; transform: scale(0.9); }
                    to { opacity: 1; transform: scale(1); }
                }
                </style>
            `;
            document.body.appendChild(modal);
            console.log('âœ… AI ä»‹ç´¹ Modal å·²å‰µå»ºä¸¦æ·»åŠ åˆ° DOM');
            // ç¢ºä¿ modal åœ¨æœ€é«˜å±¤ç´š
            const modalElement = document.getElementById('ai-intro-modal');
            if (modalElement) {
                const overlay = modalElement.querySelector('div');
                if (overlay) {
                    overlay.style.zIndex = '10000';
                }
            }
        }

        window.startAIConsultation = function () {
            window.location.href = 'https://duet.brendonchen.com/ai-consultant';
        }

        window.skipAIConsultation = function () {
            localStorage.setItem('duet_skip_ai', 'true');
            document.getElementById('ai-intro-modal')?.remove();
        }

        window.openDesignConsultant = function () {
            const existingData = localStorage.getItem('duet_ai_consultation');
            if (existingData) {
                if (confirm('é‡æ–°é–‹å§‹ AI è¨­è¨ˆè«®è©¢ï¼Ÿé€™å°‡æ¸…é™¤ä¹‹å‰çš„æ¨è–¦ã€‚')) {
                    localStorage.removeItem('duet_ai_consultation');
                    window.location.href = 'https://duet.brendonchen.com/ai-consultant';
                }
            } else {
                window.location.href = 'https://duet.brendonchen.com/ai-consultant';
            }
        }

        // æª¢æŸ¥ AI è«®è©¢æ•¸æ“š
        // ========== é€šç”¨é€šçŸ¥å‡½æ•¸ (æ–°å¢) ==========
        // å¾Œç«¯ URL é…ç½®ï¼ˆæå‰å®šç¾©ï¼Œä¾›ä»˜æ¬¾æª¢æ¸¬ä½¿ç”¨ï¼‰
        const BACKEND_URL = 'https://duet-backend-wlw8.onrender.com';
        // é‡è¦ï¼šè®“å…¶ä»–æª”æ¡ˆï¼ˆå¦‚ wearing-preview.jsï¼‰å¯è®€å–
        window.BACKEND_URL = BACKEND_URL;

        /**
         * é¡¯ç¤ºé€šçŸ¥è¨Šæ¯
         * @param {string} message - é€šçŸ¥è¨Šæ¯
         * @param {string} type - é€šçŸ¥é¡å‹: 'success', 'error', 'info'
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');

            // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
            const colors = {
                'success': {
                    bg: 'linear-gradient(135deg, #10b981, #059669)',
                    shadow: 'rgba(16, 185, 129, 0.4)'
                },
                'error': {
                    bg: 'linear-gradient(135deg, #ef4444, #dc2626)',
                    shadow: 'rgba(239, 68, 68, 0.4)'
                },
                'info': {
                    bg: 'linear-gradient(135deg, #d4af37, #f4d03f)',
                    shadow: 'rgba(212, 175, 55, 0.4)'
                }
            };

            const color = colors[type] || colors.info;

            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color.bg};
                color: #fff;
                padding: 16px 32px;
                border-radius: 50px;
                font-weight: 600;
                font-size: 15px;
                z-index: 10000;
                box-shadow: 0 8px 24px ${color.shadow};
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // æ·¡å…¥æ•ˆæœ
            setTimeout(() => notification.style.opacity = '1', 10);

            // 3 ç§’å¾Œæ·¡å‡ºä¸¦ç§»é™¤
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        // ========== é€šç”¨é€šçŸ¥å‡½æ•¸çµæŸ ==========

        // ========== ä»˜æ¬¾æˆåŠŸæª¢æ¸¬ (æ–°å¢) ==========
        /**
         * æª¢æ¸¬ä»˜æ¬¾æˆåŠŸç‹€æ…‹ï¼ˆå¾ URL åƒæ•¸è®€å–ï¼‰
         * GitHub Pages ä¸æœƒéæ¿¾ URL åƒæ•¸ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨
         */
        function checkPaymentStatusImmediate() {
            console.log('ğŸ” ç«‹å³æª¢æ¸¬ä»˜æ¬¾ç‹€æ…‹...');

            // å¾ URL åƒæ•¸è®€å–
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success') === 'true';
            const paymentFailed = urlParams.get('payment_failed') === 'true';
            const orderId = urlParams.get('order');

            console.log('ğŸ” URL åƒæ•¸æª¢æ¸¬:', {
                paymentSuccess,
                paymentFailed,
                orderId
            });

            // ä»˜æ¬¾æˆåŠŸ
            if (paymentSuccess && orderId) {
                console.log(`âœ… æª¢æ¸¬åˆ°ä»˜æ¬¾æˆåŠŸ: ${orderId}`);

                // æ¸…é™¤ URL åƒæ•¸ï¼ˆé¿å…é‡è¤‡è§¸ç™¼ï¼‰
                window.history.replaceState({}, document.title, window.location.pathname);

                // è¨­å®šæ¨™è¨˜ï¼šä»˜æ¬¾æˆåŠŸå¾Œé€²å…¥è¨­è¨ˆç†å¿µæµç¨‹
                window.isPostPayment = true;

                // é¡¯ç¤ºä»˜æ¬¾æˆåŠŸé€šçŸ¥
                showNotification('ä»˜æ¬¾æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨æº–å‚™è¨­è¨ˆè«®è©¢...', 'success');

                // å»¶é² 1.5 ç§’å¾Œè¼‰å…¥è¨‚å–®ä¸¦è§¸ç™¼è¨­è¨ˆç†å¿µæ”¶é›†æµç¨‹
                setTimeout(async () => {
                    console.log('ğŸ¨ æº–å‚™è¨­è¨ˆç†å¿µæ”¶é›†æµç¨‹');
                    console.log('ğŸ” è¨‚å–®ID:', orderId);
                    console.log('ğŸ” BACKEND_URL:', BACKEND_URL);
                    console.log('ğŸ” å®Œæ•´ API URL:', `${BACKEND_URL}/api/order/${orderId}`);

                    // å…ˆå¾å¾Œç«¯è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œæ¢å¾©è³¼ç‰©è»Š
                    try {
                        const apiUrl = `${BACKEND_URL}/api/order/${orderId}`;
                        console.log('ğŸ“¡ æ­£åœ¨å‘¼å« API:', apiUrl);

                        const response = await fetch(apiUrl);
                        console.log('ğŸ“¡ Response status:', response.status);
                        console.log('ğŸ“¡ Response ok:', response.ok);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('ğŸ“¦ æ”¶åˆ°è³‡æ–™:', data);

                        if (data.success && data.items) {
                            // æ¢å¾©è³¼ç‰©è»Šè³‡æ–™å’Œ AI è«®è©¢è³‡æ–™
                            window.cartItems = data.items;
                            window.lastOrderId = orderId;
                            window.aiConsultationData = data.ai_data;  // âœ… å„²å­˜ AI è«®è©¢è³‡æ–™

                            console.log('âœ… è¨‚å–®è³‡æ–™å·²è¼‰å…¥');
                            console.log('  - å•†å“æ•¸é‡:', data.items.length);
                            console.log('  - AI è«®è©¢:', data.ai_data ? 'æœ‰' : 'ç„¡');

                            // è§¸ç™¼è¨­è¨ˆç†å¿µæ”¶é›†
                            if (typeof collectDesignStories === 'function') {
                                collectDesignStories();
                            } else {
                                console.error('âŒ collectDesignStories å‡½æ•¸ä¸å­˜åœ¨');
                            }
                        } else {
                            console.error('âŒ ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡æ–™');
                            console.error('  - success:', data.success);
                            console.error('  - items:', data.items);
                            console.error('  - error:', data.error);
                            showNotification('è¼‰å…¥è¨‚å–®è³‡æ–™å¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                        }
                    } catch (error) {
                        console.error('âŒ è¼‰å…¥è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        console.error('  - Error name:', error.name);
                        console.error('  - Error message:', error.message);
                        console.error('  - Error stack:', error.stack);
                        showNotification('è¼‰å…¥è¨‚å–®è³‡æ–™å¤±æ•—: ' + error.message, 'error');
                    }
                }, 1500);

                return true;
            }

            // æª¢æ¸¬ä»˜æ¬¾å¤±æ•—
            if (paymentFailed && orderId) {
                console.log('âŒ æª¢æ¸¬åˆ°ä»˜æ¬¾å¤±æ•—');
                showNotification('ä»˜æ¬¾å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦', 'error');
                return true;
            }

            console.log('â„¹ï¸ éä»˜æ¬¾æˆåŠŸé é¢');
            return false;
        }

        /**
         * æŸ¥è©¢è¨‚å–®ç‹€æ…‹ï¼ˆç•¶é©—è­‰å¤±æ•—æ™‚ä½¿ç”¨ï¼‰
         */
        async function queryOrderStatus(orderId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/order/status/${orderId}`);
                const data = await response.json();

                if (data.success && data.paid) {
                    console.log('âœ… å¾Œç«¯ç¢ºèªè¨‚å–®å·²ä»˜æ¬¾');
                    showNotification('ä»˜æ¬¾æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨æº–å‚™è¨­è¨ˆè«®è©¢...', 'success');
                    setTimeout(() => {
                        if (typeof showAIIntroModal === 'function') {
                            showAIIntroModal();
                        }
                    }, 1500);
                } else {
                    console.log('âš ï¸ è¨‚å–®å°šæœªå®Œæˆä»˜æ¬¾');
                    showNotification('è¨‚å–®è™•ç†ä¸­ï¼Œè«‹ç¨å€™...', 'info');
                }
            } catch (error) {
                console.error('âŒ æŸ¥è©¢è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æ¸¬ä»˜æ¬¾ç‹€æ…‹
        checkPaymentStatusImmediate();
        // ========== ä»˜æ¬¾æˆåŠŸæª¢æ¸¬çµæŸ ==========

        window.addEventListener('DOMContentLoaded', function () {
            // å¦‚æœæ˜¯ä»˜æ¬¾æˆåŠŸå¾Œï¼Œä¸åŸ·è¡Œé€™æ®µï¼ˆæœƒç”± collectDesignStories æ¥æ‰‹ï¼‰
            if (window.isPostPayment) {
                console.log('â„¹ï¸ ä»˜æ¬¾æˆåŠŸæµç¨‹ï¼Œè·³é AI æ¨è–¦è¼‰å…¥');
                return;
            }

            const aiDataStr = localStorage.getItem('duet_ai_consultation');

            if (aiDataStr) {
                const aiData = JSON.parse(aiDataStr);
                window.hasAIRecommendation = true;
                window.aiRecommendation = aiData.recommendedFonts;
                window.aiConversation = aiData.conversationHistory;
                window.aiLetters = aiData.selectedLetters;

                console.log('âœ… è¼‰å…¥ AI æ¨è–¦è³‡æ–™:', aiData);

                // è‡ªå‹•å¡«å…¥å­—æ¯
                setTimeout(() => {
                    const letter1Select = document.getElementById('letter1');
                    const letter2Select = document.getElementById('letter2');

                    if (aiData.selectedLetters) {
                        letter1Select.value = aiData.selectedLetters.letter1;
                        letter2Select.value = aiData.selectedLetters.letter2;
                        console.log('âœ… å·²å¡«å…¥å­—æ¯:', aiData.selectedLetters);
                    }

                    // è‡ªå‹•å‹¾é¸æ¨è–¦å­—é«”
                    if (aiData.recommendedFonts) {
                        const allFonts = [
                            ...aiData.recommendedFonts.letter1,
                            ...aiData.recommendedFonts.letter2
                        ];

                        // å»é‡
                        const uniqueFonts = [...new Set(allFonts)];
                        console.log('âœ… æ¨è–¦å­—é«”:', uniqueFonts);

                        // è‡ªå‹•å‹¾é¸é€™äº›å­—é«”
                        uniqueFonts.forEach(font => {
                            checkedFonts.add(font);
                        });

                        // è‡ªå‹•æ‰“é–‹å­—é«”é¸æ“‡è¦–çª—
                        openFontSelector();

                        // æ›´æ–°å­—é«”é¸æ“‡è¦–çª—çš„å‹¾é¸ç‹€æ…‹
                        setTimeout(() => {
                            updateFontDisplay();

                            // é¡¯ç¤ºæç¤ºè¨Šæ¯
                            showAINotification();
                        }, 500);
                    }
                }, 1000);
            }

            const skipAI = localStorage.getItem('duet_skip_ai');
            if (!skipAI && !aiDataStr) {
                // ç­‰å¾…ä¸»ç•«é¢å®Œå…¨è¼‰å…¥ï¼ˆåŒ…æ‹¬ 3D çƒé«”ï¼‰å¾Œ 2 ç§’æ‰é¡¯ç¤º
                function showAIAfterDelay() {
                    setTimeout(() => {
                        console.log('ğŸ”” 2 ç§’å»¶é²çµæŸï¼Œé¡¯ç¤º AI ä»‹ç´¹');
                        showAIIntroModal();
                    }, 2000);
                }

                // æª¢æŸ¥é é¢æ˜¯å¦å·²ç¶“è¼‰å…¥å®Œæˆ
                if (document.readyState === 'complete') {
                    console.log('ğŸ”” é é¢å·²è¼‰å…¥å®Œæˆï¼Œ2 ç§’å¾Œé¡¯ç¤º AI ä»‹ç´¹');
                    showAIAfterDelay();
                } else {
                    window.addEventListener('load', () => {
                        console.log('ğŸ”” é é¢è¼‰å…¥å®Œæˆï¼Œ2 ç§’å¾Œé¡¯ç¤º AI ä»‹ç´¹');
                        showAIAfterDelay();
                    });
                }
            }
        });
        // ========== AI è«®è©¢æ•´åˆç¨‹å¼ç¢¼çµæŸ ==========

        // === å¾Œç«¯ API è¨­å®š ===
        // ===== é…ç½®å€å¡Š =====
        const TESTING_MODE = false;  // âš ï¸ æ¸¬è©¦æ¨¡å¼é—œé–‰ï¼Œä½¿ç”¨çœŸå¯¦é‡‘æµï¼ˆç¶ ç•Œæ¸¬è©¦ç«™ï¼‰
        // BACKEND_URL å·²åœ¨å‰é¢å®šç¾©ï¼ˆä¾›ä»˜æ¬¾æª¢æ¸¬ä½¿ç”¨ï¼‰

        console.log('ğŸ”§ ç•¶å‰é…ç½®:', {
            æ¸¬è©¦æ¨¡å¼: TESTING_MODE ? 'âœ… å•Ÿç”¨' : 'âŒ é—œé–‰',
            å¾Œç«¯URL: BACKEND_URL
        });

        console.log('ğŸ”§ å¾Œç«¯ URL:', BACKEND_URL);

        // === æ¸¬è©¦å¾Œç«¯é€£æ¥ ===
        async function testBackendConnection() {
            try {
                console.log('ğŸ” æ¸¬è©¦å¾Œç«¯é€£æ¥...');
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… å¾Œç«¯é€£æ¥æˆåŠŸ:', data);

                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆé¸ç”¨ï¼‰
                if (data.engine === 'OpenSCAD') {
                    console.log('âœ… OpenSCAD å¼•æ“å·²å°±ç·’');
                }

                return true;
            } catch (error) {
                console.error('âŒ å¾Œç«¯é€£æ¥å¤±æ•—:', error);
                console.error('è«‹ç¢ºèªï¼š');
                console.error('1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸');
                console.error('2. å¾Œç«¯ URL æ˜¯å¦æ­£ç¢º:', BACKEND_URL);
                return false;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        window.addEventListener('load', async () => {
            console.log('ğŸ“± é é¢å·²è¼‰å…¥ï¼Œåˆå§‹åŒ–...');

            // å…ˆåˆå§‹åŒ–å¯ç”¨å­—é«”æ¸…å–®
            await initAvailableFonts();

            // ç„¶å¾Œæ¸¬è©¦å¾Œç«¯é€£æ¥
            testBackendConnection();
        });

        // ============================================================
        // ä»¥ä¸‹æ˜¯åŸå§‹ç¨‹å¼ç¢¼
        // ============================================================

        // å…¨åŸŸè®Šæ•¸
        let scene, camera, renderer, controls, envMap;
        let mainMesh = null, bailMesh = null;
        let loadedFonts = {};
        let checkedFonts = new Set();
        let cartItems = [];
        let savedVersions = [null, null];
        let slot1Scene, slot2Scene, slot1Renderer, slot2Renderer, slot1Camera, slot2Camera;
        let modelTopZ = 0;
        let modelCenter = new THREE.Vector3();

        // å„ªæƒ ç¢¼ç›¸é—œè®Šæ•¸
        let appliedPromoCode = '';
        let promoDiscount = 0;
        let originalTotal = 0;

        // 120 ç¨®å­—é«”æ¸…å–®ï¼ˆä¾†è‡ª font-selector.htmï¼‰
        // å¯ç”¨å­—é«”æ¸…å–®ï¼ˆå¾å¤–éƒ¨ JSON è¼‰å…¥ï¼‰
        let availableFonts = [];

        // å¾å¤–éƒ¨ JSON æª”æ¡ˆè¼‰å…¥å­—é«”åº«
        async function loadFontsFromJSON() {
            try {
                const response = await fetch('fonts.json');
                const data = await response.json();
                return data.fonts || [];
            } catch (error) {
                console.error('âŒ è¼‰å…¥å­—é«”åº«å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºåˆ—è¡¨:', error);
                // Fallback: ä½¿ç”¨å…§å»ºå­—é«”åˆ—è¡¨
                return [
                    "Abel", "Abril Fatface", "Advent Pro", "Alegreya", "Alex Brush",
                    "Alfa Slab One", "Alice", "Allura", "Amatic SC", "Amiri",
                    "Anton", "Arapey", "Archivo", "Armata", "Artifika",
                    "Arvo", "Audiowide", "Average", "Baloo 2", "Bangers",
                    "Bebas Neue", "Belgrano", "Bentham", "Bitter", "Bree Serif",
                    "Bubblegum Sans", "Bungee", "Cabin", "Cantata One", "Caudex",
                    "Caveat", "Chivo", "Cinzel", "Comfortaa", "Commissioner",
                    "Cookie", "Copse", "Cormorant Garamond", "Courier Prime", "Coustard",
                    "Creepster", "Cutive Mono", "DM Serif Text", "Dancing Script", "Dosis",
                    "EB Garamond", "Eczar", "Encode Sans", "Fauna One", "Fira Code",
                    "Fira Sans", "Fjalla One", "Fugaz One", "Gelasio", "Gloria Hallelujah",
                    "Great Vibes", "Handlee", "Hind", "Holtwood One SC", "Inconsolata",
                    "Indie Flower", "Jost", "Kalam", "Kanit", "Karla",
                    "Lexend", "Lobster", "Merriweather", "Neuton", "Nunito",
                    "Old Standard TT", "Orbitron", "Oswald", "Outfit", "Pacifico",
                    "Passion One", "Pathway Gothic One", "Patrick Hand", "Paytone One", "Playfair Display",
                    "Poppins", "Prata", "Quicksand", "Righteous", "Rubik",
                    "Russo One", "Sacramento", "Secular One", "Shadows Into Light", "Share Tech Mono",
                    "Shrikhand", "Sniglet", "Space Grotesk", "Space Mono", "Spectral",
                    "Tangerine", "Titan One", "Varela Round", "Vollkorn", "Zilla Slab"
                ];
            }
        }

        // å­—é«”è¼‰å…¥å®Œæˆçš„ Promiseï¼ˆä¾›å…¶ä»–åœ°æ–¹ awaitï¼‰
        let fontsLoadedResolve;
        const fontsLoadedPromise = new Promise(resolve => { fontsLoadedResolve = resolve; });

        // åˆå§‹åŒ–ï¼šè¼‰å…¥å­—é«”åº«ï¼ˆfonts.jsonï¼‰ï¼Œä¸¦åœ¨è¼‰å…¥å®Œæˆå¾Œè§¸ç™¼ Google Fonts é è¼‰
        (async function initializeFonts() {
            const loaded = await loadFontsFromJSON();
            console.log(`âœ… å­—é«”åº«å·²è¼‰å…¥ï¼š${loaded.length} ç¨®å­—é«”`);
            availableFonts = loaded;
            if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            // é€šçŸ¥å…¶ä»–ç­‰å¾…å­—é«”è¼‰å…¥çš„åœ°æ–¹
            if (fontsLoadedResolve) fontsLoadedResolve();
        })();

        // åˆå§‹åŒ–å¯ç”¨å­—é«”æ¸…å–®ï¼šä¸€å¾‹å¾ fonts.json è¼‰å…¥ï¼ˆæ–¹ä¾¿å¾ŒçºŒè®Šæ›´å­—é«”æ¸…å–®ï¼‰
        async function initAvailableFonts() {
            try {
                console.log('ğŸ” å¾ fonts.json è¼‰å…¥å­—é«”æ¸…å–®...');
                availableFonts = await loadFontsFromJSON();
                console.log(`âœ… å…±æœ‰ ${availableFonts.length} ç¨®å­—é«”å¯ç”¨`);
                if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            } catch (error) {
                console.error('âŒ è¼‰å…¥ fonts.json å¤±æ•—:', error);
                availableFonts = await loadFontsFromJSON().catch(() => []);
                if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            }
        }

        // æè³ªè¨­å®š
        const MATERIALS = {
            gold18k: { color: 0xFFD700, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.3 },
            whitegold18k: { color: 0xE5E5E5, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.3 },
            rosegold18k: { color: 0xECC5B0, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.0 },
            silver925: { color: 0xC0C0C0, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 10.3 },
            brass: { color: 0xB5A642, metalness: 0.9, roughness: { glossy: 0.0, matte: 0.6 }, density: 8.5 },
            platinum: { color: 0xE5E5E5, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 21.4 }
        };

        // é›»éé¡è‰²å®šç¾©
        const PLATING_COLORS = {
            none: null,  // ç„¡é›»éï¼Œä½¿ç”¨åŸºç¤æè³ªé¡è‰²
            gold18k: 0xFFD700,      // 18K é‡‘è‰²
            whitegold18k: 0xE5E5E5, // 18K ç™½Ké‡‘è‰²
            rosegold18k: 0xECC5B0   // 18K ç«ç‘°é‡‘è‰²
        };

        // åˆå§‹åŒ–å ´æ™¯ï¼ˆZ-up ç³»çµ±ï¼‰
        function initScene() {
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.up.set(0, 0, 1); // Z-up ç³»çµ±
            // å¾ç‰©ä»¶å‰æ–¹ç¨å¾®åå³ä¸Šï¼Œ15åº¦ä¿¯è§’è§€çœ‹ 45 åº¦å¤¾è§’
            camera.position.set(60, -85, 18);  // æ‹‰é é¡é ­ï¼ˆåŸ: 50, -70, 15ï¼‰
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.getElementById('viewport').appendChild(renderer.domElement);
            // æš´éœ² renderer, scene, camera çµ¦å…¨å±€ï¼Œä¾›ä½©æˆ´æ¨¡æ“¬ä½¿ç”¨
            window.renderer = renderer;
            window.scene = scene;
            window.camera = camera;

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.25);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(5, 5, 10);
            scene.add(directionalLight);

            const rgbeLoader = new RGBELoader();
            const hdrUrl = 'https://raw.githubusercontent.com/brendon-create/duet-openscad/main/images/studio_small_08_1k.hdr';

            console.log('ğŸ”„ é–‹å§‹è¼‰å…¥ HDR:', hdrUrl);

            rgbeLoader.load(
                hdrUrl,
                (texture) => {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    envMap = texture;
                    scene.environment = envMap;
                    console.log('âœ… HDR ç’°å¢ƒè²¼åœ–è¼‰å…¥æˆåŠŸ');
                    showInitialSphere();
                },
                undefined,  // onProgress
                (error) => {
                    console.error('âŒ HDR è¼‰å…¥å¤±æ•—:', error);
                    console.error('   URL:', hdrUrl);
                    console.error('   çƒé«”å°‡é¡¯ç¤ºä½†ç¼ºå°‘ç’°å¢ƒåå°„');
                    showInitialSphere();  // å¤±æ•—ä¹Ÿè¦é¡¯ç¤ºçƒé«”
                }
            );

            window.addEventListener('resize', onResize);
        }

        function showInitialSphere() {
            const geometry = new THREE.SphereGeometry(7.5, 64, 64);
            const material = getMaterial('silver925', 'glossy', 'none');  // é è¨­ï¼š925éŠ€ï¼Œäº®é¢ï¼Œç„¡é›»é
            mainMesh = new THREE.Mesh(geometry, material);
            scene.add(mainMesh);
            // æš´éœ² mainMesh çµ¦å…¨å±€ï¼Œä¾›ä½©æˆ´æ¨¡æ“¬ä½¿ç”¨
            window.mainMesh = mainMesh;
            document.getElementById('loader').style.display = 'none';
        }

        function getMaterial(materialType, finish, plating = 'none') {
            const mat = MATERIALS[materialType];
            const roughness = mat.roughness[finish];

            // æ±ºå®šæœ€çµ‚é¡è‰²ï¼šå¦‚æœæœ‰é›»éï¼Œä½¿ç”¨é›»éé¡è‰²ï¼›å¦å‰‡ä½¿ç”¨åŸºç¤æè³ªé¡è‰²
            const finalColor = PLATING_COLORS[plating] !== null
                ? PLATING_COLORS[plating]
                : mat.color;

            const materialConfig = {
                color: finalColor,
                metalness: mat.metalness,
                roughness: roughness,
                envMapIntensity: finish === 'glossy' ? 2.0 : 1.0
            };

            // åªåœ¨ envMap å­˜åœ¨æ™‚æ‰åŠ å…¥ï¼ˆé˜²æ­¢é»‘è‰²çƒé«”ï¼‰
            if (envMap) {
                materialConfig.envMap = envMap;
            }

            return new THREE.MeshStandardMaterial(materialConfig);
        }

        // 3D å»ºæ¨¡ï¼ˆZ-up ç³»çµ±ï¼šXY æ°´å¹³é¢ï¼ŒZ è»¸å‘ä¸Šï¼‰
        async function generateModel() {
            // é¡¯ç¤ºé‡å»ºæç¤º
            let indicator = document.getElementById('model-rebuilding-indicator');
            if (indicator) indicator.style.display = 'block';

            const l1 = document.getElementById('letter1').value;
            const l2 = document.getElementById('letter2').value;

            // æª¢æŸ¥å­—é«”æŒ‰éˆ•æˆ–ä¸‹æ‹‰é¸å–®æ˜¯å¦æœ‰é¸æ“‡çš„å­—é«”
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Btn = document.getElementById('font1-btn');
            const font2Btn = document.getElementById('font2-btn');

            const f1Name = font1Select ? font1Select.value : font1Btn.getAttribute('data-selected');
            const f2Name = font2Select ? font2Select.value : font2Btn.getAttribute('data-selected');

            console.log('generateModel called:', { l1, l2, f1Name, f2Name }); // Debug

            if (!l1 || !l2 || !f1Name || !f2Name || f1Name === 'reselect' || f2Name === 'reselect') {
                console.log('Missing parameters, showing sphere'); // Debug
                if (!mainMesh || mainMesh.geometry.type !== 'SphereGeometry') {
                    showInitialSphere();
                }
                // éš±è—é‡å»ºæç¤º
                if (indicator) indicator.style.display = 'none';
                return;
            }

            const targetHeight = parseInt(document.getElementById('size').value);

            // æš«å­˜èˆŠç‰©ä»¶ï¼Œç­‰æ–°ç‰©ä»¶å‰µå»ºå®Œæˆå¾Œå†ç§»é™¤ï¼ˆé¿å…ç•«é¢ç©ºç™½ï¼‰
            const oldMainMesh = mainMesh;
            const oldBailMesh = bailMesh;

            console.log('Loading fonts...'); // Debug
            // è¼‰å…¥å­—é«”
            const f1 = await loadFont(f1Name);
            const f2 = await loadFont(f2Name);
            console.log('Fonts loaded, generating geometry...'); // Debug

            const evaluator = new Evaluator();
            const baseMat = new THREE.MeshStandardMaterial();

            // âœ… ä¿®å¾©æˆªæ–·å•é¡Œï¼šå¢å¤§ depth ä¿‚æ•¸
            // åŸå› ï¼šscale() æœƒç¸®å°æ‰€æœ‰æ–¹å‘ï¼ŒåŒ…æ‹¬æ·±åº¦
            // å¾Œç«¯ç”¨ resize() åªç¸®æ”¾ XYï¼Œä¿æŒåŸå§‹æ·±åº¦
            // å‰ç«¯éœ€è¦æ›´å¤§çš„ä¿‚æ•¸ä¾†è£œå„Ÿç¸®æ”¾
            const depth = targetHeight * 20.0;  // å¾ 5.0 â†’ 20.0
            const params = {
                font: null,
                size: 50,
                height: depth,
                curveSegments: 32,  // å¢åŠ åˆ° 32ï¼ˆæ›´å¹³æ»‘çš„æ›²ç·šï¼‰
                bevelEnabled: false,  // ğŸ”§ é—œé–‰ bevel ä»¥ç¢ºä¿å‰å¾Œç«¯ä¸€è‡´
                bevelThickness: 2.0,
                bevelSize: 0.8,
                bevelSegments: 16
            };

            // === å­—æ¯ 1 (æ­£é¢)ï¼šå°‡å­—æ¯å¹³é¢å¾ XY è½‰åˆ° XZï¼Œæ“ å‡ºæ–¹å‘å¾ Z è½‰åˆ° Y ===
            const geo1 = new TextGeometry(l1, { ...params, font: f1 });
            geo1.computeBoundingBox();
            const bbox1 = geo1.boundingBox;
            const actualHeight1 = bbox1.max.y - bbox1.min.y;
            const actualWidth1 = bbox1.max.x - bbox1.min.x;

            // ğŸ” Debug: åŸå§‹å°ºå¯¸ï¼ˆscale ä¹‹å‰ï¼‰
            console.log(`ğŸ” Letter 1 "${l1}" åŸå§‹å°ºå¯¸ï¼ˆå« bevelï¼‰:`, {
                width: actualWidth1.toFixed(3) + 'mm',
                height: actualHeight1.toFixed(3) + 'mm',
                depth: (bbox1.max.z - bbox1.min.z).toFixed(3) + 'mm'
            });

            const scale1 = targetHeight / actualHeight1;
            console.log(`ğŸ” Letter 1 ç¸®æ”¾æ¯”ä¾‹: ${scale1.toFixed(4)} (ç›®æ¨™é«˜åº¦ ${targetHeight}mm)`);

            geo1.scale(scale1, scale1, scale1);
            geo1.center();

            // ä¿å­˜ Letter 1 çš„ BBox ä¿¡æ¯ï¼ˆcenter ä¹‹å¾Œï¼Œrotate ä¹‹å‰ï¼‰
            geo1.computeBoundingBox();
            const bbox1AfterScale = geo1.boundingBox;
            window.letter1BBox = {
                width: bbox1AfterScale.max.x - bbox1AfterScale.min.x,
                height: bbox1AfterScale.max.y - bbox1AfterScale.min.y,
                depth: bbox1AfterScale.max.z - bbox1AfterScale.min.z,
                offsetX: (bbox1AfterScale.max.x + bbox1AfterScale.min.x) / 2,
                offsetY: (bbox1AfterScale.max.y + bbox1AfterScale.min.y) / 2,
                offsetZ: (bbox1AfterScale.max.z + bbox1AfterScale.min.z) / 2
            };

            // === ä½¿ç”¨å…¨åŸŸè»¸æ—‹è½‰ï¼ˆæ›´æ¸…æ™°ã€æ˜“ç¶­è­·ï¼‰===
            // Letter 1: XZ å¹³é¢ï¼Œæ²¿ Y è»¸ extrude
            // Geometry æ²’æœ‰ rotateOnWorldAxisï¼Œéœ€è¦ç”¨æ—‹è½‰çŸ©é™£
            const rotationMatrix1 = new THREE.Matrix4();
            rotationMatrix1.makeRotationX(Math.PI / 2);
            geo1.applyMatrix4(rotationMatrix1);

            const brush1 = new Brush(geo1, baseMat);
            brush1.updateMatrixWorld();

            // === å­—æ¯ 2 (å´é¢)ï¼šYZ å¹³é¢ï¼Œæ²¿ X è»¸ extrude ===
            const geo2 = new TextGeometry(l2, { ...params, font: f2 });
            geo2.computeBoundingBox();
            const bbox2 = geo2.boundingBox;
            const actualHeight2 = bbox2.max.y - bbox2.min.y;
            const actualWidth2 = bbox2.max.x - bbox2.min.x;

            // ğŸ” Debug: åŸå§‹å°ºå¯¸ï¼ˆscale ä¹‹å‰ï¼‰
            console.log(`ğŸ” Letter 2 "${l2}" åŸå§‹å°ºå¯¸ï¼ˆå« bevelï¼‰:`, {
                width: actualWidth2.toFixed(3) + 'mm',
                height: actualHeight2.toFixed(3) + 'mm',
                depth: (bbox2.max.z - bbox2.min.z).toFixed(3) + 'mm'
            });

            const scale2 = targetHeight / actualHeight2;
            console.log(`ğŸ” Letter 2 ç¸®æ”¾æ¯”ä¾‹: ${scale2.toFixed(4)} (ç›®æ¨™é«˜åº¦ ${targetHeight}mm)`);

            geo2.scale(scale2, scale2, scale2);
            geo2.center();

            // ä¿å­˜ Letter 2 çš„ BBox ä¿¡æ¯ï¼ˆcenter ä¹‹å¾Œï¼Œrotate ä¹‹å‰ï¼‰
            geo2.computeBoundingBox();
            const bbox2AfterScale = geo2.boundingBox;
            window.letter2BBox = {
                width: bbox2AfterScale.max.x - bbox2AfterScale.min.x,
                height: bbox2AfterScale.max.y - bbox2AfterScale.min.y,
                depth: bbox2AfterScale.max.z - bbox2AfterScale.min.z,
                offsetX: (bbox2AfterScale.max.x + bbox2AfterScale.min.x) / 2,
                offsetY: (bbox2AfterScale.max.y + bbox2AfterScale.min.y) / 2,
                offsetZ: (bbox2AfterScale.max.z + bbox2AfterScale.min.z) / 2
            };

            // === ä½¿ç”¨å…¨åŸŸè»¸æ—‹è½‰ï¼ˆæ›´æ¸…æ™°ã€æ˜“ç¶­è­·ï¼‰===
            // Letter 2: å…ˆç¹ X è»¸è½‰ 90 åº¦ï¼Œå†ç¹ Z è»¸è½‰ 90 åº¦
            const rotationMatrix2X = new THREE.Matrix4();
            rotationMatrix2X.makeRotationX(Math.PI / 2);
            geo2.applyMatrix4(rotationMatrix2X);

            const rotationMatrix2Z = new THREE.Matrix4();
            rotationMatrix2Z.makeRotationZ(Math.PI / 2);
            geo2.applyMatrix4(rotationMatrix2Z);

            const brush2 = new Brush(geo2, baseMat);
            brush2.updateMatrixWorld();

            console.log('Calculating intersection...'); // Debug

            // ğŸ” Debug: CSG å‰æª¢æŸ¥å…©å€‹ Brush çš„å¯¦éš›ç¯„åœ
            brush1.geometry.computeBoundingBox();
            brush2.geometry.computeBoundingBox();
            console.log('ğŸ” Brush1 (Letter1) BBox:', {
                min: brush1.geometry.boundingBox.min,
                max: brush1.geometry.boundingBox.max,
                size: {
                    x: (brush1.geometry.boundingBox.max.x - brush1.geometry.boundingBox.min.x).toFixed(2),
                    y: (brush1.geometry.boundingBox.max.y - brush1.geometry.boundingBox.min.y).toFixed(2),
                    z: (brush1.geometry.boundingBox.max.z - brush1.geometry.boundingBox.min.z).toFixed(2)
                }
            });
            console.log('ğŸ” Brush2 (Letter2) BBox:', {
                min: brush2.geometry.boundingBox.min,
                max: brush2.geometry.boundingBox.max,
                size: {
                    x: (brush2.geometry.boundingBox.max.x - brush2.geometry.boundingBox.min.x).toFixed(2),
                    y: (brush2.geometry.boundingBox.max.y - brush2.geometry.boundingBox.min.y).toFixed(2),
                    z: (brush2.geometry.boundingBox.max.z - brush2.geometry.boundingBox.min.z).toFixed(2)
                }
            });

            // å¸ƒæ—äº¤é›†é‹ç®—
            let result = evaluator.evaluate(brush1, brush2, INTERSECTION);

            // ğŸ” Debug: CSG å¾Œæª¢æŸ¥çµæœ
            result.geometry.computeBoundingBox();
            console.log('ğŸ” CSG Result BBox:', {
                min: result.geometry.boundingBox.min,
                max: result.geometry.boundingBox.max,
                size: {
                    x: (result.geometry.boundingBox.max.x - result.geometry.boundingBox.min.x).toFixed(2),
                    y: (result.geometry.boundingBox.max.y - result.geometry.boundingBox.min.y).toFixed(2),
                    z: (result.geometry.boundingBox.max.z - result.geometry.boundingBox.min.z).toFixed(2)
                }
            });

            if (result.geometry.attributes.position.count === 0) {
                console.warn('äº¤é›†ç‚ºç©º');
                return;
            }

            console.log('Fixing geometry...'); // Debug
            // === ä¿®å¾©å¹¾ä½•é«” ===
            result.geometry = result.geometry.toNonIndexed();
            result.geometry.deleteAttribute('normal');
            result.geometry.computeVertexNormals();

            const offset = 0.001;
            const positions = result.geometry.attributes.position;
            const normals = result.geometry.attributes.normal;

            for (let i = 0; i < positions.count; i++) {
                const nx = normals.getX(i);
                const ny = normals.getY(i);
                const nz = normals.getZ(i);

                positions.setXYZ(
                    i,
                    positions.getX(i) + nx * offset,
                    positions.getY(i) + ny * offset,
                    positions.getZ(i) + nz * offset
                );
            }
            positions.needsUpdate = true;

            result.geometry.computeBoundingBox();
            const bbox = result.geometry.boundingBox;

            // âœ… ç§»å‹•ç‰©ä»¶åˆ°åŸé»ï¼ˆè§£æ±ºå°ç‰©ä»¶è¢«æˆªæ–·å•é¡Œï¼‰
            const center = bbox.getCenter(new THREE.Vector3());
            result.geometry.translate(-center.x, -center.y, -center.z);

            // é‡æ–°è¨ˆç®— BBoxï¼ˆç¾åœ¨ä¸­å¿ƒæ‡‰è©²åœ¨åŸé»ï¼‰
            result.geometry.computeBoundingBox();
            const newBbox = result.geometry.boundingBox;
            modelTopZ = newBbox.max.z; // æ–°çš„é«˜åº¦è»¸æ˜¯ Z
            modelCenter.copy(newBbox.getCenter(new THREE.Vector3()));

            // è¼¸å‡ºå¯¦éš›å°ºå¯¸
            const modelWidth = newBbox.max.x - newBbox.min.x;
            const modelDepth = newBbox.max.y - newBbox.min.y;
            const modelHeight = newBbox.max.z - newBbox.min.z;

            // ğŸ” Debug: å®Œæ•´å»ºæ¨¡ä¿¡æ¯
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ å‰ç«¯æ¸¬é‡ - Letter 1 BBox (å‚³çµ¦å¾Œç«¯):', {
                width: window.letter1BBox.width.toFixed(3) + 'mm',
                height: window.letter1BBox.height.toFixed(3) + 'mm',
                depth: window.letter1BBox.depth.toFixed(3) + 'mm'
            });
            console.log('ğŸ“ å‰ç«¯æ¸¬é‡ - Letter 2 BBox (å‚³çµ¦å¾Œç«¯):', {
                width: window.letter2BBox.width.toFixed(3) + 'mm',
                height: window.letter2BBox.height.toFixed(3) + 'mm',
                depth: window.letter2BBox.depth.toFixed(3) + 'mm'
            });
            console.log('ğŸ” Bevel åƒæ•¸:', {
                bevelEnabled: params.bevelEnabled,
                bevelThickness: params.bevelThickness,
                bevelSize: params.bevelSize,
                bevelSegments: params.bevelSegments
            });
            console.log('ğŸ“ å‰ç«¯ Model æœ€çµ‚å¯¦éš›å°ºå¯¸ (CSG äº¤é›†å¾Œ):');
            console.log('  å¯¬åº¦ (X):', modelWidth.toFixed(3), 'mm');
            console.log('  æ·±åº¦ (Y):', modelDepth.toFixed(3), 'mm');
            console.log('  é«˜åº¦ (Z):', modelHeight.toFixed(3), 'mm');
            console.log('  ä¸­å¿ƒé»: (',
                modelCenter.x.toFixed(3), ',',
                modelCenter.y.toFixed(3), ',',
                modelCenter.z.toFixed(3), ')');
            console.log('  BBox min: (',
                newBbox.min.x.toFixed(3), ',',
                newBbox.min.y.toFixed(3), ',',
                newBbox.min.z.toFixed(3), ')');
            console.log('  BBox max: (',
                newBbox.max.x.toFixed(3), ',',
                newBbox.max.y.toFixed(3), ',',
                newBbox.max.z.toFixed(3), ')');

            result.material = getMaterial(
                document.getElementById('material').value,
                document.getElementById('finish').value,
                document.getElementById('plating').value
            );

            mainMesh = result;
            scene.add(mainMesh);

            // æ–°ç‰©ä»¶å·²æ·»åŠ ï¼Œç¾åœ¨å¯ä»¥å®‰å…¨ç§»é™¤èˆŠç‰©ä»¶
            if (oldMainMesh) {
                scene.remove(oldMainMesh);
                oldMainMesh.geometry?.dispose();
                oldMainMesh.material?.dispose();
            }
            if (oldBailMesh) {
                scene.remove(oldBailMesh);
                oldBailMesh.geometry?.dispose();
                oldBailMesh.material?.dispose();
            }

            console.log('Model generated, creating bail...'); // Debug
            createBail();
            updateVolumeWeight();
            console.log('Generation complete!'); // Debug

            // éš±è—é‡å»ºæç¤º
            indicator = document.getElementById('model-rebuilding-indicator');
            if (indicator) indicator.style.display = 'none';

            // æ›´æ–°ä½©æˆ´æ¨¡æ“¬é è¦½
            if (window.updateWearingPreview) {
                setTimeout(() => {
                    console.log('ğŸ”„ å•†å“ç”Ÿæˆå®Œæˆï¼Œæ›´æ–°ä½©æˆ´æ¨¡æ“¬');
                    window.updateWearingPreview();
                }, 300);
            }
        }

        // å¾ opentype.js å­—é«”è½‰æ›ç‚º Three.js typeface æ ¼å¼
        function convertOpentypeToThreejs(opentypeFont, fontName) {
            const glyphs = {};
            const resolution = 1000;
            const scale = resolution / opentypeFont.unitsPerEm;

            // ç²å–æ‰€æœ‰éœ€è¦çš„å­—ç¬¦
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (const char of chars) {
                const glyph = opentypeFont.charToGlyph(char);
                if (!glyph || glyph.index === 0) continue;

                // ä½¿ç”¨åŸå§‹å–®ä½ç²å–è·¯å¾‘ï¼Œç„¶å¾Œæ‰‹å‹•ç¸®æ”¾
                const path = glyph.getPath(0, 0, opentypeFont.unitsPerEm);
                const commands = [];

                for (const cmd of path.commands) {
                    switch (cmd.type) {
                        case 'M':
                            commands.push({ type: 'm', args: [cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'L':
                            commands.push({ type: 'l', args: [cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'Q':
                            commands.push({ type: 'q', args: [cmd.x1 * scale, cmd.y1 * scale, cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'C':
                            commands.push({ type: 'b', args: [cmd.x1 * scale, cmd.y1 * scale, cmd.x2 * scale, cmd.y2 * scale, cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'Z':
                            commands.push({ type: 'z', args: [] });
                            break;
                    }
                }

                // å°‡ commands è½‰æ›ç‚º 'o' æ ¼å¼ï¼ˆThree.js typeface æ ¼å¼ï¼‰
                let o = '';
                for (const cmd of commands) {
                    o += cmd.type;
                    if (cmd.args.length > 0) {
                        o += ' ' + cmd.args.map(n => Math.round(n)).join(' ') + ' ';
                    }
                }

                glyphs[char] = {
                    ha: Math.round((glyph.advanceWidth || opentypeFont.unitsPerEm * 0.5) * scale),
                    x_min: Math.round((glyph.xMin || 0) * scale),
                    x_max: Math.round((glyph.xMax || glyph.advanceWidth || opentypeFont.unitsPerEm * 0.5) * scale),
                    o: o.trim()
                };
            }

            return {
                glyphs: glyphs,
                familyName: fontName,
                ascender: Math.round(opentypeFont.ascender * scale),
                descender: Math.round(opentypeFont.descender * scale),
                underlinePosition: Math.round((opentypeFont.tables.post?.underlinePosition || -100) * scale),
                underlineThickness: Math.round((opentypeFont.tables.post?.underlineThickness || 50) * scale),
                boundingBox: {
                    xMin: Math.round((opentypeFont.tables.head?.xMin || 0) * scale),
                    yMin: Math.round((opentypeFont.tables.head?.yMin || 0) * scale),
                    xMax: Math.round((opentypeFont.tables.head?.xMax || 1000) * scale),
                    yMax: Math.round((opentypeFont.tables.head?.yMax || 1000) * scale)
                },
                resolution: resolution,
                original_font_information: {
                    format: 0,
                    copyright: '',
                    fontFamily: fontName,
                    fontSubfamily: 'Regular',
                    uniqueID: fontName,
                    fullName: fontName,
                    version: '1.0',
                    postScriptName: fontName.replace(/ /g, '')
                }
            };
        }

        async function loadFont(fontName) {
            if (loadedFonts[fontName]) return loadedFonts[fontName];

            const loader = new FontLoader();

            console.log(`Loading font: ${fontName}`);

            // å°‡å­—é«”åç¨±è½‰æ›ç‚º npm å¥—ä»¶åç¨±æ ¼å¼
            // ä¾‹å¦‚ï¼š'Playfair Display' -> 'playfair-display'
            const packageName = fontName.toLowerCase().replace(/ /g, '-');

            // å˜—è©¦å¾å¤šå€‹ä¾†æºè¼‰å…¥
            const sources = [
                // 1. @compai/font-* å¥—ä»¶ (esm.sh CDN)
                `https://esm.sh/@compai/font-${packageName}/data/typefaces/normal-400.json`,
                // 2. components-ai/typefaces GitHub (jsDelivr)
                `https://cdn.jsdelivr.net/gh/components-ai/typefaces/packages/font-${packageName}/data/typefaces/normal-400.json`,
                // 3. 7dir/json-fonts GitHub
                `https://cdn.jsdelivr.net/gh/7dir/json-fonts/Roboto/${fontName.replace(/ /g, '_')}_Regular.json`,
                // 4. emreacar/google-fonts-as-json GitHub  
                `https://cdn.jsdelivr.net/gh/emreacar/google-fonts-as-json/fonts/${fontName.replace(/ /g, '%20')}/regular.json`,
            ];

            for (const url of sources) {
                try {
                    console.log(`Trying: ${url}`);
                    const response = await fetch(url);
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const json = await response.json();
                            // æª¢æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ typeface æ ¼å¼
                            if (json.glyphs || json.data) {
                                const fontData = json.data || json;
                                const font = loader.parse(fontData);
                                loadedFonts[fontName] = font;
                                console.log(`âœ“ Loaded ${fontName} from ${url}`);
                                return font;
                            }
                        }
                    }
                } catch (e) {
                    console.log(`âœ— Failed: ${url}`, e.message);
                }
            }

            // å¦‚æœ CDN éƒ½å¤±æ•—ï¼Œå˜—è©¦ç”¨ opentype.js å¾ Google Fonts è§£æ
            try {
                const fontUrlName = fontName.replace(/ /g, '+');
                const cssUrl = `https://fonts.googleapis.com/css?family=${fontUrlName}`;

                const cssResponse = await fetch(cssUrl);
                if (cssResponse.ok) {
                    const cssText = await cssResponse.text();
                    const urlMatch = cssText.match(/url\((https:\/\/fonts\.gstatic\.com\/[^)]+)\)/);

                    if (urlMatch) {
                        const fontFileUrl = urlMatch[1];
                        console.log(`Trying Google Fonts: ${fontFileUrl}`);

                        const fontResponse = await fetch(fontFileUrl);
                        if (fontResponse.ok) {
                            const fontBuffer = await fontResponse.arrayBuffer();

                            try {
                                const opentypeFont = opentype.parse(fontBuffer);
                                const typefaceData = convertOpentypeToThreejs(opentypeFont, fontName);
                                const font = loader.parse(typefaceData);
                                loadedFonts[fontName] = font;
                                console.log(`âœ“ Loaded ${fontName} via opentype.js`);
                                return font;
                            } catch (parseError) {
                                console.log(`âœ— Parse failed (likely woff2): ${parseError.message}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn(`Failed Google Fonts: ${error.message}`);
            }

            // æœ€çµ‚å‚™ç”¨ï¼šä½¿ç”¨é è¨­å­—é«”
            console.warn(`âš  Using Helvetiker for: ${fontName}`);
            return new Promise((resolve) => {
                loader.load(
                    'https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',
                    (font) => resolve(font)
                );
            });
        }

        function createBail() {
            // å…ˆç§»é™¤èˆŠçš„ bailMesh
            if (bailMesh) {
                scene.remove(bailMesh);
                bailMesh.geometry?.dispose();
                bailMesh.material?.dispose();
                bailMesh = null;
                // æš´éœ²çµ¦ä½©æˆ´æ¨¡æ“¬ï¼ˆç”¨æ–¼æˆªå–å¢œé£¾ï¼‰
                window.bailMesh = null;
            }

            if (!mainMesh) return;

            const innerRadius = 1.5;   // å…§ç›´å¾‘ 3mm
            const tubeRadius = 0.35;   // ç®¡åŠå¾‘ 0.35mmï¼Œç›´å¾‘ 0.7mm
            const geometry = new THREE.TorusGeometry(innerRadius + tubeRadius, tubeRadius, 16, 32);

            // å°‡ Torus å¾ XY å¹³é¢è½‰åˆ° XZ å¹³é¢ (ç«™ç«‹)
            geometry.rotateX(Math.PI / 2);
            // ç¹æ–°çš„é«˜åº¦è»¸ Z æ—‹è½‰ 90 åº¦
            geometry.rotateZ(Math.PI / 2);

            const material = getMaterial(
                document.getElementById('material').value,
                document.getElementById('finish').value,
                document.getElementById('plating').value
            );
            bailMesh = new THREE.Mesh(geometry, material);
            scene.add(bailMesh);
            // æš´éœ²çµ¦ä½©æˆ´æ¨¡æ“¬ï¼ˆç”¨æ–¼æˆªå–å¢œé£¾ï¼‰
            window.bailMesh = bailMesh;

            updateBailPosition();
        }

        function updateBailPosition() {
            if (!bailMesh) return;
            const x = parseFloat(document.getElementById('bailX').value);
            // bailY å°æ‡‰ UI çš„ Position Y (Depth)
            const y_depth_adj = parseFloat(document.getElementById('bailY').value);
            // bailZ å°æ‡‰ UI çš„ Position Z (Height)
            const z_height_adj = parseFloat(document.getElementById('bailZ').value);
            const rotation = parseFloat(document.getElementById('bailRotation').value);

            const baseZ = modelTopZ + 2.0; // åœ¨ Z (é«˜åº¦) è»¸ä¸Šå®šä½

            // èª¿æ•´ï¼šX ä¸è®Š, Y è»¸ç‚º modelCenter.y + æ·±åº¦èª¿æ•´, Z è»¸ç‚º baseZ + é«˜åº¦èª¿æ•´
            bailMesh.position.set(modelCenter.x + x, modelCenter.y + y_depth_adj, baseZ + z_height_adj);

            // æ—‹è½‰ä»¥ Z è»¸ç‚ºè»¸å¿ƒ
            bailMesh.rotation.z = (rotation * Math.PI) / 180;

            // ğŸ” Debug: å¢œé ­ä½ç½®
            console.log('ğŸ” å¢œé ­çµ•å°ä½ç½®:', {
                x: bailMesh.position.x.toFixed(3),
                y: bailMesh.position.y.toFixed(3),
                z: bailMesh.position.z.toFixed(3),
                rotation: rotation + 'Â°'
            });
            console.log('ğŸ” æ¨¡å‹ä¸­å¿ƒ:', {
                x: modelCenter.x.toFixed(3),
                y: modelCenter.y.toFixed(3),
                z: modelCenter.z.toFixed(3)
            });
            console.log('ğŸ” æ¨¡å‹é ‚éƒ¨ Z:', modelTopZ.toFixed(3));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }

        // åªæ›´æ–°æè³ªï¼Œä¸é‡å»ºæ¨¡å‹ï¼ˆå³æ™‚åˆ‡æ›ï¼ï¼‰
        function updateMaterial() {
            if (!mainMesh || !bailMesh) return;

            const materialType = document.getElementById('material').value;
            const finish = document.getElementById('finish').value;
            const plating = document.getElementById('plating').value;
            const newMaterial = getMaterial(materialType, finish, plating);

            // æ›´æ›ä¸»é«”å’Œå¢œé ­çš„æè³ª
            mainMesh.material = newMaterial;
            bailMesh.material = newMaterial.clone();

            // æ›´æ–°é‡é‡é¡¯ç¤ºï¼ˆå¯†åº¦æ”¹è®Šäº†ï¼‰
            updateVolumeWeight();

            // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
            updatePriceDisplay();
        }

        // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
        function updatePriceDisplay() {
            const plating = document.getElementById('plating').value;

            // åŸºç¤åƒ¹æ ¼ï¼š925éŠ€ã€é»ƒéŠ…éƒ½æ˜¯ 3850
            let price = 3850;

            // æœ‰é›»éï¼ˆä»»ä½•é›»éï¼‰+400
            if (plating && plating !== 'none') {
                price += 400;
            }

            // æ›´æ–°é¡¯ç¤º
            document.getElementById('price-display').textContent = `NT$ ${price.toLocaleString()}`;
        }

        function updateVolumeWeight() {
            if (!mainMesh || !mainMesh.geometry.attributes.position) {
                document.getElementById('volume-display').textContent = '- mmÂ³';
                document.getElementById('weight-display').textContent = '- g';
                return;
            }

            let volume = 0;
            const positions = mainMesh.geometry.attributes.position;
            const p1 = new THREE.Vector3();
            const p2 = new THREE.Vector3();
            const p3 = new THREE.Vector3();

            for (let i = 0; i < positions.count; i += 3) {
                p1.fromBufferAttribute(positions, i);
                p2.fromBufferAttribute(positions, i + 1);
                p3.fromBufferAttribute(positions, i + 2);
                volume += p1.dot(p2.cross(p3)) / 6.0;
            }
            volume = Math.abs(volume);

            const density = MATERIALS[document.getElementById('material').value].density;
            const weight = (volume * density) / 1000;

            document.getElementById('volume-display').textContent = `${volume.toFixed(2)} mmÂ³`;
            document.getElementById('weight-display').textContent = `${weight.toFixed(2)} g`;
        }

        // å­—é«”é¸æ“‡å™¨ï¼ˆç­‰å¾… fonts.json è¼‰å…¥å®Œæˆå¾Œæ‰åˆå§‹åŒ–ï¼‰
        async function initFontSelector() {
            // ç­‰å¾…å­—é«”è¼‰å…¥å®Œæˆ
            if (typeof fontsLoadedPromise !== 'undefined') {
                await fontsLoadedPromise;
            }

            const listContainer = document.getElementById('font-list-container');
            const displayArea = document.getElementById('font-display-area');

            // ä½¿ç”¨å¾ fonts.json è¼‰å…¥çš„å¯ç”¨å­—é«”æ¸…å–®
            const fontsToDisplay = availableFonts.length > 0 ? availableFonts : [];

            fontsToDisplay.forEach((font) => {
                const item = document.createElement('div');
                item.className = 'font-list-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.font = font;

                const label = document.createElement('span');
                label.textContent = font;
                label.style.fontFamily = `"${font}", sans-serif`;

                item.appendChild(checkbox);
                item.appendChild(label);
                listContainer.appendChild(item);

                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        checkedFonts.add(font);
                    } else {
                        checkedFonts.delete(font);
                    }
                    updateFontDisplay();
                });

                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                const card = document.createElement('div');
                card.className = 'font-preview-card';
                card.dataset.font = font;

                const charDiv = document.createElement('div');
                charDiv.className = 'preview-char';
                charDiv.style.fontFamily = `"${font}", sans-serif`;
                // ä½¿ç”¨è¼¸å…¥çš„å‰å…©å€‹å­—æ¯ï¼Œé è¨­ç‚º 'A'
                const charInput = document.getElementById('char-input');
                charDiv.textContent = charInput.value.substring(0, 2) || 'A';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'preview-name';
                nameDiv.textContent = font;

                card.appendChild(charDiv);
                card.appendChild(nameDiv);
                displayArea.appendChild(card);

                card.addEventListener('click', () => {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            });

            document.getElementById('char-input').addEventListener('input', (e) => {
                // é¡¯ç¤ºå‰å…©å€‹å­—æ¯
                const chars = e.target.value.substring(0, 2) || 'A';
                document.querySelectorAll('.preview-char').forEach(el => {
                    el.textContent = chars;
                });

                // åŒæ­¥å›å·¦å´å­—æ¯é¸æ“‡ï¼ˆé›™å‘åŒæ­¥ï¼‰
                if (chars.length >= 1) {
                    document.getElementById('letter1').value = chars[0] || 'A';
                }
                if (chars.length >= 2) {
                    document.getElementById('letter2').value = chars[1] || 'A';
                }
            });

            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.font-list-item input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        checkedFonts.add(cb.dataset.font);
                    } else {
                        checkedFonts.delete(cb.dataset.font);
                    }
                });
                updateFontDisplay();
            });
        }

        function updateFontDisplay() {
            document.querySelectorAll('.font-preview-card').forEach(card => {
                const font = card.dataset.font;
                if (checkedFonts.has(font)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function openFontSelector() {
            // è®€å–ç•¶å‰å­—æ¯ä¸¦è‡ªå‹•å¡«å…¥å­—é«”é¸æ“‡è¦–çª—
            const letter1 = document.getElementById('letter1').value;
            const letter2 = document.getElementById('letter2').value;
            const charInput = document.getElementById('char-input');
            charInput.value = letter1 + letter2;

            // è§¸ç™¼ input äº‹ä»¶ï¼Œæ›´æ–°å­—é«”é è¦½
            charInput.dispatchEvent(new Event('input'));

            document.getElementById('font-selector-modal').classList.add('active');
        }

        function closeFontSelector() {
            document.getElementById('font-selector-modal').classList.remove('active');
        }

        // é è¼‰å…¥é¸ä¸­çš„å­—é«”åˆ° cacheï¼ˆèƒŒæ™¯è¼‰å…¥ï¼‰
        async function preloadSelectedFonts(fontNames) {
            console.log(`ğŸš€ é–‹å§‹é è¼‰å…¥ ${fontNames.length} å€‹å­—é«”...`);

            // é¡¯ç¤ºé€²åº¦æç¤º
            const statusDiv = document.getElementById('font-preload-status');
            const progressText = document.getElementById('preload-progress');
            const preloadText = document.getElementById('preload-text');

            statusDiv.style.display = 'block';
            preloadText.textContent = 'é è¼‰å…¥å­—é«”ä¸­...';
            progressText.textContent = `0 / ${fontNames.length}`;

            const startTime = Date.now();
            let successCount = 0;

            // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰å­—é«”ï¼ˆä¸é˜»å¡ UIï¼‰
            const loadPromises = fontNames.map(async (fontName) => {
                try {
                    await loadFont(fontName);
                    successCount++;
                    progressText.textContent = `${successCount} / ${fontNames.length}`;
                    console.log(`âœ“ é è¼‰å…¥æˆåŠŸ: ${fontName} (${successCount}/${fontNames.length})`);
                } catch (error) {
                    console.warn(`âœ— é è¼‰å…¥å¤±æ•—: ${fontName}`, error);
                }
            });

            // ä¸ç­‰å¾…å…¨éƒ¨å®Œæˆï¼Œè®“å®ƒåœ¨èƒŒæ™¯åŸ·è¡Œ
            Promise.all(loadPromises).then(() => {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`âœ… å­—é«”é è¼‰å…¥å®Œæˆï¼æˆåŠŸ: ${successCount}/${fontNames.length}ï¼Œè€—æ™‚: ${duration}ç§’`);

                // é¡¯ç¤ºå®Œæˆç‹€æ…‹ 2 ç§’å¾Œéš±è—
                preloadText.textContent = `âœ“ ${successCount} å€‹å­—é«”å·²å°±ç·’ï¼`;
                progressText.textContent = `åˆ‡æ›å­—é«”å°‡æ›´å¿«é€Ÿ`;

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            });
        }

        function confirmFontSelection() {
            if (checkedFonts.size === 0) {
                alert('Please select at least one font!');
                return;
            }

            const inputChars = document.getElementById('char-input').value.trim();
            if (inputChars.length < 2) {
                alert('Please enter 2 letters');
                return;
            }

            const letter1Select = document.getElementById('letter1');
            const letter2Select = document.getElementById('letter2');

            letter1Select.value = inputChars[0];
            letter2Select.value = inputChars[1];

            const selectedFonts = Array.from(checkedFonts);

            // æ›´æ–°å­—é«”æŒ‰éˆ•ç‚ºä¸‹æ‹‰é¸å–®
            ['font1', 'font2'].forEach(target => {
                const btn = document.getElementById(`${target}-btn`);

                // éš±è—æŒ‰éˆ•ï¼Œå‰µå»ºä¸‹æ‹‰é¸å–®
                btn.style.display = 'none';

                // æª¢æŸ¥æ˜¯å¦å·²æœ‰ä¸‹æ‹‰é¸å–®
                let select = document.getElementById(`${target}-select`);
                if (!select) {
                    select = document.createElement('select');
                    select.id = `${target}-select`;
                    select.className = 'font-select-btn';
                    select.style.display = 'block';
                    select.style.cursor = 'pointer';
                    btn.parentNode.appendChild(select);
                } else {
                    select.style.display = 'block';
                }

                // æ¸…ç©ºä¸¦å¡«å…¥å­—é«”é¸é …
                select.innerHTML = '';
                selectedFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    option.style.fontFamily = `"${font}", sans-serif`;
                    select.appendChild(option);
                });

                // æ·»åŠ  Re-select é¸é …
                const reselectOption = document.createElement('option');
                reselectOption.value = 'reselect';
                reselectOption.textContent = 'â†» Re-select Fonts';
                select.appendChild(reselectOption);

                // æ™ºèƒ½é¸æ“‡é è¨­å­—é«”ï¼ˆå„ªå…ˆä½¿ç”¨ AI æ¨è–¦ï¼‰
                let defaultFont = selectedFonts[0];

                if (window.aiRecommendation) {
                    const recommendedForThisLetter = target === 'font1'
                        ? window.aiRecommendation.letter1
                        : window.aiRecommendation.letter2;

                    // å¦‚æœæ¨è–¦å­—é«”åœ¨å·²é¸å­—é«”ä¸­ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹æ¨è–¦
                    const firstRecommended = recommendedForThisLetter.find(f => selectedFonts.includes(f));
                    if (firstRecommended) {
                        defaultFont = firstRecommended;
                        console.log(`âœ… ${target} ä½¿ç”¨ AI æ¨è–¦å­—é«”:`, defaultFont);
                    }
                }

                select.value = defaultFont;
                btn.setAttribute('data-selected', defaultFont);
                select.style.fontFamily = `"${defaultFont}", sans-serif`;

                // ç›£è½ä¸‹æ‹‰é¸å–®è®Šæ›´
                select.onchange = function () {
                    if (this.value === 'reselect') {
                        openFontSelector();
                        this.value = btn.getAttribute('data-selected') || selectedFonts[0];
                    } else {
                        btn.setAttribute('data-selected', this.value);
                        // æ›´æ–°ä¸‹æ‹‰é¸å–®æœ¬èº«çš„å­—é«”æ¨£å¼
                        this.style.fontFamily = `"${this.value}", sans-serif`;
                        // ä¸åŒæ­¥æ›´æ–°å¦ä¸€å€‹ä¸‹æ‹‰é¸å–®ï¼Œå…è¨±ç¨ç«‹é¸æ“‡
                        generateModel();
                    }
                };
            });

            closeFontSelector();

            // ğŸš€ é è¼‰å…¥æ‰€æœ‰é¸ä¸­çš„å­—é«”åˆ° cacheï¼ˆèƒŒæ™¯è¼‰å…¥ï¼‰
            preloadSelectedFonts(selectedFonts);

            generateModel();
        }

        // æ§½ä½åŠŸèƒ½ï¼ˆç°¡åŒ–ç‰ˆï¼šç´”å„²å­˜å’Œå¬å›ï¼Œæ·»åŠ åŒæ­¥æ—‹è½‰ï¼‰
        function saveToSlot(slotIndex) {
            if (!mainMesh) return;

            const slotElement = document.querySelector(`[data-slot="${slotIndex + 1}"]`);
            slotElement.classList.remove('empty');

            // ç²å–ç•¶å‰å­—é«”åç¨±
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Name = font1Select ? font1Select.value : document.getElementById('font1-btn').getAttribute('data-selected');
            const font2Name = font2Select ? font2Select.value : document.getElementById('font2-btn').getAttribute('data-selected');

            // ä¿å­˜ç•¶å‰ç‹€æ…‹
            savedVersions[slotIndex] = {
                letter1: document.getElementById('letter1').value,
                letter2: document.getElementById('letter2').value,
                font1: font1Name,
                font2: font2Name,
                material: document.getElementById('material').value,
                plating: document.getElementById('plating').value,
                finish: document.getElementById('finish').value,
                size: document.getElementById('size').value,
                bailX: document.getElementById('bailX').value,
                bailY: document.getElementById('bailY').value,
                bailZ: document.getElementById('bailZ').value,
                bailRotation: document.getElementById('bailRotation').value,
                mesh: mainMesh.clone(),
                bail: bailMesh ? bailMesh.clone() : null
            };

            // å‰µå»ºç¸®ç•¥åœ–
            slotElement.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = 160;
            canvas.height = 160;
            slotElement.appendChild(canvas);

            const slotRenderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            slotRenderer.setSize(160, 160);
            slotRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            slotRenderer.outputColorSpace = THREE.SRGBColorSpace;

            const slotScene = new THREE.Scene();
            const slotCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            slotCamera.up.set(0, 0, 1); // Z-up ç³»çµ±
            const dist = 50;
            const ratioX = 1.0;
            const ratioY = 0.4;
            const ratioZ = 1.0;
            const totalRatio = Math.sqrt(ratioX * ratioX + ratioY * ratioY + ratioZ * ratioZ);
            const scaleFactor = dist / totalRatio;
            const newRatioX = ratioZ;
            const newRatioY = -ratioX;
            slotCamera.position.set(
                newRatioX * scaleFactor,
                newRatioY * scaleFactor,
                ratioY * scaleFactor
            );
            slotCamera.lookAt(0, 0, 0);

            const light1 = new THREE.AmbientLight(0xffffff, 0.5);
            const light2 = new THREE.DirectionalLight(0xffffff, 1.0);
            light2.position.set(5, 5, 10);
            slotScene.add(light1);
            slotScene.add(light2);
            slotScene.environment = envMap;

            const meshClone = mainMesh.clone();
            slotScene.add(meshClone);
            if (bailMesh) {
                const bailClone = bailMesh.clone();
                slotScene.add(bailClone);
            }

            slotRenderer.render(slotScene, slotCamera);

            // ä¿å­˜åˆ°å…¨åŸŸè®Šæ•¸ä»¥ä¾¿åŒæ­¥æ—‹è½‰
            if (slotIndex === 0) {
                slot1Renderer = slotRenderer;
                slot1Scene = slotScene;
                slot1Camera = slotCamera;
            } else {
                slot2Renderer = slotRenderer;
                slot2Scene = slotScene;
                slot2Camera = slotCamera;
            }

            const label = document.createElement('div');
            label.className = 'version-label';
            label.textContent = `SLOT ${slotIndex + 1}`;
            slotElement.appendChild(label);
        }

        function loadFromSlot(slotIndex) {
            const slotData = savedVersions[slotIndex];
            if (!slotData) return;

            // è¼‰å…¥æ§½ä½æ•¸æ“šåˆ°ä¸»ç•«é¢
            document.getElementById('letter1').value = slotData.letter1;
            document.getElementById('letter2').value = slotData.letter2;
            document.getElementById('material').value = slotData.material;
            document.getElementById('plating').value = slotData.plating || 'none';  // å‘å¾Œç›¸å®¹ï¼šå¦‚æœæ²’æœ‰é›»éè³‡æ–™ï¼Œé è¨­ç‚ºã€Œç„¡ã€
            document.getElementById('finish').value = slotData.finish;
            document.getElementById('size').value = slotData.size;
            document.getElementById('bailX').value = slotData.bailX;
            document.getElementById('bailY').value = slotData.bailY;
            document.getElementById('bailZ').value = slotData.bailZ;
            document.getElementById('bailRotation').value = slotData.bailRotation;

            // æ›´æ–°é¡¯ç¤ºå€¼
            document.getElementById('bailX-val').textContent = slotData.bailX;
            document.getElementById('bailY-val').textContent = slotData.bailY;
            document.getElementById('bailZ-val').textContent = slotData.bailZ;
            document.getElementById('bailRotation-val').textContent = slotData.bailRotation + 'Â°';

            // æ›´æ–°å­—é«”æŒ‰éˆ•å’Œä¸‹æ‹‰é¸å–®
            const font1Btn = document.getElementById('font1-btn');
            const font2Btn = document.getElementById('font2-btn');
            font1Btn.setAttribute('data-selected', slotData.font1);
            font2Btn.setAttribute('data-selected', slotData.font2);

            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            if (font1Select) font1Select.value = slotData.font1;
            if (font2Select) font2Select.value = slotData.font2;

            // æ¸…é™¤èˆŠæ¨¡å‹
            if (mainMesh) {
                scene.remove(mainMesh);
                if (mainMesh.geometry) mainMesh.geometry.dispose();
                if (mainMesh.material) mainMesh.material.dispose();
            }
            if (bailMesh) {
                scene.remove(bailMesh);
                if (bailMesh.geometry) bailMesh.geometry.dispose();
                if (bailMesh.material) bailMesh.material.dispose();
            }

            // è¼‰å…¥æ–°æ¨¡å‹ï¼ˆä½¿ç”¨æ·±æ‹·è²ï¼‰
            mainMesh = slotData.mesh.clone();
            mainMesh.material = mainMesh.material.clone();
            scene.add(mainMesh);

            if (slotData.bail) {
                bailMesh = slotData.bail.clone();
                bailMesh.material = bailMesh.material.clone();
                scene.add(bailMesh);
            }

            updateVolumeWeight();
        }

        // è³¼ç‰©è»Š
        function addToCart() {
            if (!mainMesh) return;

            // âœ… é™åˆ¶è³¼ç‰©è»Šæœ€å¤š 3 å€‹ç‰©ä»¶
            if (cartItems.length >= 3) {
                alert('è³¼ç‰©è»Šæœ€å¤šåªèƒ½åŠ å…¥ 3 å€‹å•†å“\nå¦‚éœ€è¨‚è³¼æ›´å¤šï¼Œè«‹åˆ†æ‰¹çµå¸³');
                return;
            }

            // ç²å–ç•¶å‰é¸æ“‡çš„å­—é«”åç¨±
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Name = font1Select ? font1Select.value : document.getElementById('font1-btn').getAttribute('data-selected');
            const font2Name = font2Select ? font2Select.value : document.getElementById('font2-btn').getAttribute('data-selected');

            // è¨ˆç®—å¢œé ­ç›¸å°æ–¼ä¸»é«”ä¸­å¿ƒçš„å‘é‡
            const bailRelativeX = bailMesh ? (bailMesh.position.x - modelCenter.x) : 0;
            const bailRelativeY = bailMesh ? (bailMesh.position.y - modelCenter.y) : 0;
            const bailRelativeZ = bailMesh ? (bailMesh.position.z - modelCenter.z) : 0;
            const bailRot = bailMesh ? (bailMesh.rotation.z * 180 / Math.PI) : 0;

            // âœ… ç”Ÿæˆç¸®ç•¥åœ–ï¼ˆç”¨æ–¼è³¼ç‰©è»Šé è¦½ï¼‰
            const thumbnailCanvas = document.createElement('canvas');
            thumbnailCanvas.width = 100;
            thumbnailCanvas.height = 100;
            const thumbnailRenderer = new THREE.WebGLRenderer({
                canvas: thumbnailCanvas,
                antialias: true,
                alpha: true
            });
            thumbnailRenderer.setSize(100, 100);
            thumbnailRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            thumbnailRenderer.outputColorSpace = THREE.SRGBColorSpace;

            const thumbnailScene = new THREE.Scene();
            const thumbnailCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            thumbnailCamera.up.set(0, 0, 1);
            thumbnailCamera.position.set(20, -28, 6);
            thumbnailCamera.lookAt(0, 0, 0);

            // æ·»åŠ ç‡ˆå…‰
            const light1 = new THREE.AmbientLight(0xffffff, 0.5);
            const light2 = new THREE.DirectionalLight(0xffffff, 1.0);
            light2.position.set(5, 5, 10);
            thumbnailScene.add(light1, light2);

            // è¤‡è£½ç•¶å‰å ´æ™¯çš„ç‰©ä»¶
            thumbnailScene.add(mainMesh.clone());
            if (bailMesh) thumbnailScene.add(bailMesh.clone());

            // æ¸²æŸ“
            thumbnailRenderer.render(thumbnailScene, thumbnailCamera);
            const thumbnailDataURL = thumbnailCanvas.toDataURL('image/png');

            const item = {
                id: Date.now(),
                letter1: document.getElementById('letter1').value,
                letter2: document.getElementById('letter2').value,
                font1: font1Name,
                font2: font2Name,
                material: document.getElementById('material').value,
                plating: document.getElementById('plating').value,
                finish: document.getElementById('finish').value,
                size: parseInt(document.getElementById('size').value),  // âœ… è½‰æ›ç‚ºæ•´æ•¸
                volume: document.getElementById('volume-display').textContent,
                weight: document.getElementById('weight-display').textContent,
                quantity: 1,
                // å‹•æ…‹è¨ˆç®—åƒ¹æ ¼
                price: (() => {
                    const plating = document.getElementById('plating').value;
                    // åŸºç¤åƒ¹æ ¼ï¼š925éŠ€ã€é»ƒéŠ…éƒ½æ˜¯ 3850
                    let basePrice = 3850;
                    // æœ‰é›»éï¼ˆä»»ä½•é›»éï¼‰+400
                    if (plating && plating !== 'none') {
                        basePrice += 400;
                    }
                    return basePrice;
                })(),
                // å„²å­˜å¢œé ­ç›¸å°å‘é‡
                bailRelativeX: bailRelativeX,
                bailRelativeY: bailRelativeY,
                bailRelativeZ: bailRelativeZ,
                bailRotation: bailRot,
                // å„²å­˜å¢œé ­çµ•å°åº§æ¨™ï¼ˆç”¨æ–¼å¾Œç«¯ç²¾ç¢ºå®šä½ï¼‰
                bailAbsoluteX: bailMesh ? bailMesh.position.x : 0,
                bailAbsoluteY: bailMesh ? bailMesh.position.y : 0,
                bailAbsoluteZ: bailMesh ? bailMesh.position.z : 0,
                // å„²å­˜å­—æ¯ BBox ä¿¡æ¯ï¼ˆç”¨æ–¼å¾Œç«¯ç²¾ç¢ºå»ºæ¨¡ï¼‰
                letter1BBox: window.letter1BBox || {},
                letter2BBox: window.letter2BBox || {},
                // âœ… å„²å­˜è¨­è¨ˆç†å¿µ
                designStory: window.finalDesignStory || '',
                // âœ… å„²å­˜ç¸®ç•¥åœ–ï¼ˆç”¨æ–¼è³¼ç‰©è»Šé è¦½ï¼‰
                thumbnail: thumbnailDataURL
            };

            cartItems.push(item);
            openCart();
        }

        function openCart() {
            document.getElementById('cart-modal').classList.add('active');
            renderCart();
        }

        function closeCart() {
            document.getElementById('cart-modal').classList.remove('active');
        }

        function renderCart() {
            const container = document.getElementById('cart-items');

            if (cartItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px;">Your cart is empty</div>';
                document.getElementById('cart-total').textContent = 'NT$ 0';
                return;
            }

            container.innerHTML = '';
            let total = 0;

            cartItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';

                // âœ… ä½¿ç”¨å„²å­˜çš„ç¸®ç•¥åœ–
                if (item.thumbnail) {
                    const img = document.createElement('img');
                    img.src = item.thumbnail;
                    img.className = 'cart-item-image';
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: contain; background: transparent;';
                    div.appendChild(img);
                } else {
                    // å‚™ç”¨ï¼šé¡¯ç¤ºä½”ä½ç¬¦
                    const placeholder = document.createElement('div');
                    placeholder.className = 'cart-item-image';
                    placeholder.style.cssText = 'width: 100px; height: 100px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 40px;';
                    placeholder.textContent = item.letter1 + item.letter2;
                    div.appendChild(placeholder);
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'cart-item-info';
                const platingText = item.plating === 'none' ? 'ç„¡é›»é' : item.plating;
                const finishText = item.finish === 'glossy' ? 'äº®é¢' : 'éœ§é¢';
                infoDiv.innerHTML = `
                    <h3>DUET "${item.letter1}${item.letter2}"</h3>
                    <div class="cart-item-details">
                        "${item.letter1}" in font "${item.font1}"<br>
                        "${item.letter2}" in font "${item.font2}"<br>
                        æè³ª: ${item.material} | é›»é: ${platingText} | è³ªåœ°: ${finishText}<br>
                        å°ºå¯¸: ${item.size}mm | é‡é‡: ${item.weight}
                    </div>
                `;
                div.appendChild(infoDiv);

                const priceDiv = document.createElement('div');
                priceDiv.className = 'cart-item-price';
                priceDiv.textContent = `NT$ ${(item.price * item.quantity).toLocaleString()}`;
                div.appendChild(priceDiv);

                const quantityDiv = document.createElement('div');
                quantityDiv.className = 'cart-item-quantity';

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'quantity-input';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.setAttribute('data-index', index);
                quantityInput.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value) || 1;
                    if (value > 0) {
                        cartItems[index].quantity = value;
                        renderCart();
                    }
                });

                const quantityBtns = document.createElement('div');
                quantityBtns.className = 'quantity-btns';

                const upBtn = document.createElement('button');
                upBtn.className = 'qty-btn';
                upBtn.textContent = 'â–²';
                upBtn.onclick = () => {
                    cartItems[index].quantity++;
                    renderCart();
                };

                const downBtn = document.createElement('button');
                downBtn.className = 'qty-btn';
                downBtn.textContent = 'â–¼';
                downBtn.onclick = () => {
                    if (cartItems[index].quantity > 1) {
                        cartItems[index].quantity--;
                        renderCart();
                    }
                };

                quantityBtns.appendChild(upBtn);
                quantityBtns.appendChild(downBtn);

                quantityDiv.appendChild(quantityInput);
                quantityDiv.appendChild(quantityBtns);
                div.appendChild(quantityDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = () => {
                    cartItems.splice(index, 1);
                    renderCart();
                };
                div.appendChild(deleteBtn);

                container.appendChild(div);
                total += item.price * item.quantity;
            });

            // å„²å­˜åŸå§‹ç¸½é‡‘é¡
            originalTotal = total;

            // è¨ˆç®—æŠ˜æ‰£å¾Œé‡‘é¡
            const finalTotal = Math.max(0, originalTotal - promoDiscount);

            // æ›´æ–°é¡¯ç¤º
            updateTotalDisplay(originalTotal, promoDiscount, finalTotal);
        }

        // ============================================================
        // å„ªæƒ ç¢¼åŠŸèƒ½
        // ============================================================

        function updateTotalDisplay(original, discount, final) {
            const totalElement = document.getElementById('cart-total');

            if (discount > 0) {
                // æœ‰å„ªæƒ ç¢¼æ™‚é¡¯ç¤ºè©³ç´°è³‡è¨Š
                totalElement.innerHTML = `
                    <div style="text-align: right;">
                        <div style="font-size: 16px; color: rgba(255,255,255,0.6); text-decoration: line-through; margin-bottom: 5px;">
                            NT$ ${original.toLocaleString()}
                        </div>
                        <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">
                            å„ªæƒ æŠ˜æ‰£ -NT$ ${discount.toLocaleString()}
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #d4af37;">
                            NT$ ${final.toLocaleString()}
                        </div>
                    </div>
                `;
            } else {
                // æ²’æœ‰å„ªæƒ ç¢¼æ™‚æ­£å¸¸é¡¯ç¤º
                totalElement.textContent = `NT$ ${final.toLocaleString()}`;
            }
        }

        async function applyPromoCode() {
            const promoInput = document.getElementById('promo-code-input');
            const promoCode = promoInput.value.trim().toUpperCase();
            const promoMessage = document.getElementById('promo-message');
            const applyBtn = document.getElementById('apply-promo-btn');

            console.log('ğŸ« é–‹å§‹å¥—ç”¨å„ªæƒ ç¢¼:', promoCode);
            console.log('ğŸ“Š ç•¶å‰è³¼ç‰©è»Šç¸½é‡‘é¡:', originalTotal);

            // æ¸…é™¤ä¹‹å‰çš„è¨Šæ¯
            promoMessage.innerHTML = '';

            if (!promoCode) {
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">âš ï¸ è«‹è¼¸å…¥å„ªæƒ ç¢¼</span>';
                return;
            }

            if (cartItems.length === 0) {
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">âš ï¸ è³¼ç‰©è»Šæ˜¯ç©ºçš„</span>';
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            applyBtn.disabled = true;
            applyBtn.textContent = 'é©—è­‰ä¸­...';

            try {
                console.log('ğŸŒ å‘¼å«å¾Œç«¯ API:', `${BACKEND_URL}/api/validate-promo`);

                // å‘¼å«å¾Œç«¯é©—è­‰ API
                const response = await fetch(`${BACKEND_URL}/api/validate-promo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        promoCode: promoCode,
                        total: originalTotal
                    })
                });

                console.log('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', response.status);

                const result = await response.json();
                console.log('ğŸ“¦ API å›æ‡‰å…§å®¹:', result);

                if (result.valid) {
                    // å„ªæƒ ç¢¼æœ‰æ•ˆ
                    appliedPromoCode = promoCode;
                    promoDiscount = result.discount;

                    console.log('âœ… å„ªæƒ ç¢¼æœ‰æ•ˆ!');
                    console.log('ğŸ’° æŠ˜æ‰£é‡‘é¡:', promoDiscount);
                    console.log('ğŸ’µ æœ€çµ‚é‡‘é¡:', originalTotal - promoDiscount);

                    promoMessage.innerHTML = `
                        <div style="color: #4CAF50; display: flex; align-items: center; justify-content: space-between;">
                            <span>âœ… ${result.description}</span>
                            <button onclick="removePromoCode()" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 14px;">
                                ç§»é™¤
                            </button>
                        </div>
                    `;

                    // ç¦ç”¨è¼¸å…¥æ¡†
                    promoInput.disabled = true;
                    applyBtn.disabled = true;
                    applyBtn.textContent = 'å·²å¥—ç”¨';

                    // æ›´æ–°é¡¯ç¤º
                    renderCart();

                    console.log('ğŸ‰ å„ªæƒ ç¢¼å¥—ç”¨å®Œæˆï¼Œç•«é¢å·²æ›´æ–°');

                } else {
                    // å„ªæƒ ç¢¼ç„¡æ•ˆ
                    console.warn('âŒ å„ªæƒ ç¢¼ç„¡æ•ˆ:', result.error);
                    promoMessage.innerHTML = `<span style="color: #ff6b6b;">âŒ ${result.error}</span>`;
                    appliedPromoCode = '';
                    promoDiscount = 0;
                    renderCart();
                }

            } catch (error) {
                console.error('âŒ å„ªæƒ ç¢¼é©—è­‰éŒ¯èª¤:', error);
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">âŒ é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</span>';
                appliedPromoCode = '';
                promoDiscount = 0;
            } finally {
                // é‡ç½®æŒ‰éˆ•
                applyBtn.disabled = false;
                applyBtn.textContent = 'å¥—ç”¨';
            }
        }

        function removePromoCode() {
            appliedPromoCode = '';
            promoDiscount = 0;

            const promoInput = document.getElementById('promo-code-input');
            const promoMessage = document.getElementById('promo-message');
            const applyBtn = document.getElementById('apply-promo-btn');

            promoInput.value = '';
            promoInput.disabled = false;
            applyBtn.disabled = false;
            applyBtn.textContent = 'å¥—ç”¨';
            promoMessage.innerHTML = '';

            renderCart();
            console.log('ğŸ—‘ï¸ å„ªæƒ ç¢¼å·²ç§»é™¤');
        }

        function calculateCartTotal() {
            return originalTotal - promoDiscount;
        }

        async function testModeCheckout() {
            console.log('ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼šæ¨¡æ“¬æ”¯ä»˜æˆåŠŸ');

            const mockOrderId = 'TEST_' + Date.now();
            const mockUserInfo = {
                name: 'æ¸¬è©¦ç”¨æˆ¶',
                email: 'brendon@brendonchen.com',
                phone: '0912345678'
            };

            try {
                console.log('ğŸ“¤ ç™¼é€æ¸¬è©¦è¨‚å–®åˆ°å¾Œç«¯...');

                // âœ… æ’é™¤ mesh å’Œ bailï¼ˆ3D ç‰©ä»¶ï¼‰ï¼Œåªç™¼é€å¿…è¦è³‡æ–™
                const itemsWithBBox = cartItems.map(item => {
                    // è§£æ§‹æ’é™¤ mesh å’Œ bail
                    const { mesh, bail, ...itemData } = item;

                    return {
                        ...itemData,
                        // âœ… ç¢ºä¿æ‰€æœ‰æ•¸å€¼æ¬„ä½éƒ½æ˜¯æ•¸å­—é¡å‹
                        size: typeof item.size === 'string' ? parseInt(item.size) : item.size,
                        quantity: typeof item.quantity === 'string' ? parseInt(item.quantity) : item.quantity,
                        price: typeof item.price === 'string' ? parseFloat(item.price) : item.price,
                        bailAbsoluteX: typeof item.bailAbsoluteX === 'string' ? parseFloat(item.bailAbsoluteX) : (item.bailAbsoluteX || 0),
                        bailAbsoluteY: typeof item.bailAbsoluteY === 'string' ? parseFloat(item.bailAbsoluteY) : (item.bailAbsoluteY || 0),
                        bailAbsoluteZ: typeof item.bailAbsoluteZ === 'string' ? parseFloat(item.bailAbsoluteZ) : (item.bailAbsoluteZ || 0),
                        bailRelativeX: typeof item.bailRelativeX === 'string' ? parseFloat(item.bailRelativeX) : (item.bailRelativeX || 0),
                        bailRelativeY: typeof item.bailRelativeY === 'string' ? parseFloat(item.bailRelativeY) : (item.bailRelativeY || 0),
                        bailRelativeZ: typeof item.bailRelativeZ === 'string' ? parseFloat(item.bailRelativeZ) : (item.bailRelativeZ || 0),
                        bailRotation: typeof item.bailRotation === 'string' ? parseFloat(item.bailRotation) : (item.bailRotation || 0),
                        letter1BBox: item.letter1BBox || { width: 10, height: 12, depth: 5, offsetX: 0, offsetY: 0, offsetZ: 0 },
                        letter2BBox: item.letter2BBox || { width: 10, height: 12, depth: 5, offsetX: 0, offsetY: 0, offsetZ: 0 }
                    };
                });

                console.log('ğŸ“¦ è¨‚å–®è³‡æ–™:', { orderId: mockOrderId, items: itemsWithBBox, total: calculateCartTotal() });

                const response = await fetch(`${BACKEND_URL}/api/test-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: mockOrderId,
                        items: itemsWithBBox,
                        userInfo: mockUserInfo,
                        total: originalTotal,           // å‚³é€åŸå§‹é‡‘é¡
                        promoCode: appliedPromoCode,    // å‚³é€å„ªæƒ ç¢¼
                        testMode: true
                    })
                });

                console.log('ğŸ“¥ æ”¶åˆ°å›æ‡‰:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ å¾Œç«¯éŒ¯èª¤:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('âœ… å¾Œç«¯å›æ‡‰:', result);

                if (result.success) {
                    cartItems = [];
                    renderCart();
                    closeCart();
                    showSuccessModal();
                    console.log('âœ… æ¸¬è©¦è¨‚å–®å®Œæˆï¼');
                } else {
                    alert('âŒ æ¸¬è©¦å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }

            } catch (error) {
                console.error('âŒ æ¸¬è©¦æ¨¡å¼éŒ¯èª¤:', error);
                alert('âŒ é€£æ¥å¾Œç«¯å¤±æ•—ï¼š\n\n' + error.message + '\n\nè«‹æŸ¥çœ‹ Console äº†è§£è©³æƒ…');
            }
        }

        // ============================================================
        // è¨­è¨ˆç†å¿µæ”¶é›†æµç¨‹ï¼ˆæ–°å¢åˆ° duet-frontendï¼‰
        // ä½ç½®ï¼šåœ¨ showSuccessModal() ä¹‹å¾Œ
        // ============================================================

        // ä¿®æ”¹ showSuccessModal å‡½æ•¸
        function showSuccessModal() {
            // ç§»é™¤èˆŠçš„å½ˆçª—
            const oldModal = document.getElementById('success-modal');
            if (oldModal) {
                oldModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'success-modal';
            modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999;
    `;

            const content = document.createElement('div');
            content.style.cssText = `
        max-width: 360px;
        padding: 30px 35px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px) saturate(150%);
        -webkit-backdrop-filter: blur(20px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        text-align: center;
    `;

            content.innerHTML = `
        <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 20px; font-weight: 500; letter-spacing: 0.5px;">
            çµå¸³å®Œæˆ
        </h3>
        <p style="margin: 0 0 24px 0; color: rgba(255, 255, 255, 0.7); font-size: 14px; line-height: 1.5;">
            æ„Ÿè¬æ‚¨çš„è¨‚è³¼<br>ç¢ºèªä¿¡å·²ç™¼é€è‡³ä¿¡ç®±
        </p>
    `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // 3 ç§’å¾Œé—œé–‰ä¸¦é–‹å§‹æ”¶é›†è¨­è¨ˆç†å¿µ
            setTimeout(() => {
                modal.remove();
                collectDesignStories();
            }, 3000);
        }

        // å»é‡é‚è¼¯
        function getUniqueDesignCombinations(items) {
            const combinations = new Map();

            items.forEach(item => {
                const key = `${item.letter1}-${item.font1}-${item.letter2}-${item.font2}`;

                if (!combinations.has(key)) {
                    combinations.set(key, {
                        letters: { letter1: item.letter1, letter2: item.letter2 },
                        fonts: { font1: item.font1, font2: item.font2 },
                        itemIds: [item.id],
                        thumbnail: item.thumbnail
                    });
                } else {
                    combinations.get(key).itemIds.push(item.id);
                }
            });

            return Array.from(combinations.values());
        }

        // ä¸»æµç¨‹ï¼šæ”¶é›†è¨­è¨ˆç†å¿µ
        async function collectDesignStories() {
            // ä½¿ç”¨ window.cartItemsï¼ˆä»˜æ¬¾å¾Œå¾å¾Œç«¯è¼‰å…¥çš„ï¼‰
            const items = window.cartItems || [];

            if (items.length === 0) {
                console.error('âŒ æ²’æœ‰è³¼ç‰©è»Šè³‡æ–™');
                showNotification('ç„¡æ³•è¼‰å…¥è¨‚å–®å•†å“', 'error');
                return;
            }

            const combinations = getUniqueDesignCombinations(items);

            console.log(`ğŸ“ éœ€è¦æ”¶é›† ${combinations.length} å€‹è¨­è¨ˆç†å¿µ`);

            const concepts = [];

            // é€ä¸€è©¢å•å­—é«”åŸå› ä¸¦ç”Ÿæˆè¨­è¨ˆç†å¿µ
            for (let i = 0; i < combinations.length; i++) {
                const fontReason = await askFontReason(combinations[i], i, combinations.length);

                if (fontReason) {
                    // é¡¯ç¤ºè¨­è¨ˆç†å¿µç”Ÿæˆæç¤º
                    showDesignStoryGeneratingIndicator();

                    const designStory = await generateDesignStory(combinations[i], fontReason);

                    // éš±è—æç¤º
                    hideDesignStoryGeneratingIndicator();

                    if (designStory) {
                        concepts.push({
                            letters: combinations[i].letters,
                            fonts: combinations[i].fonts,
                            itemIds: combinations[i].itemIds,
                            thumbnail: combinations[i].thumbnail,
                            designStory: designStory
                        });
                    }
                }
            }

            // å„²å­˜åˆ° localStorage
            localStorage.setItem('duet_design_concepts', JSON.stringify({
                orderId: window.lastOrderId || 'DUET' + Date.now(),
                concepts: concepts
            }));

            // é¡¯ç¤ºè¨­è¨ˆç†å¿µæ˜ä¿¡ç‰‡å¡ç‰‡ï¼ˆä¸è·³è½‰ï¼‰
            if (concepts.length > 0) {
                showDesignStoryCard(concepts[0].designStory);
            } else {
                console.error('âŒ æ²’æœ‰è¨­è¨ˆç†å¿µå¯é¡¯ç¤º');
            }
        }

        // é¡¯ç¤ºè¨­è¨ˆç†å¿µæ˜ä¿¡ç‰‡å¡ç‰‡
        // é¡¯ç¤ºè¨­è¨ˆç†å¿µç”Ÿæˆæç¤º
        function showDesignStoryGeneratingIndicator() {
            // å‰µå»ºå…¨è¢å¹•é®ç½©
            const overlay = document.createElement('div');
            overlay.id = 'design-story-generating-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            overlay.innerHTML = `
                <div style="
                    text-align: center;
                    color: rgba(212, 175, 55, 0.9);
                    font-size: 14px;
                ">
                    <div style="font-size: 32px; margin-bottom: 15px;">âœï¸</div>
                    <div>æ­£åœ¨ç‚ºæ‚¨æ’°å¯«è¨­è¨ˆç†å¿µ<span class="dots-animation"></span></div>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // éš±è—è¨­è¨ˆç†å¿µç”Ÿæˆæç¤º
        function hideDesignStoryGeneratingIndicator() {
            const overlay = document.getElementById('design-story-generating-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showDesignStoryCard(designStory) {
            const modal = document.getElementById('design-story-modal');
            const content = document.getElementById('story-content');

            // å°‡è¨­è¨ˆç†å¿µæ–‡å­—è½‰æ›ç‚º HTMLï¼ˆä¿ç•™æ›è¡Œï¼‰
            const formattedStory = designStory.replace(/\n/g, '<br>');
            content.innerHTML = formattedStory;

            // åˆå§‹åŒ–æ™‚ä¹Ÿå„²å­˜è¨­è¨ˆç†å¿µ
            window.finalDesignStory = designStory;

            // é¡¯ç¤º Modal
            modal.style.display = 'flex';

            console.log('âœ… è¨­è¨ˆç†å¿µå¡ç‰‡å·²é¡¯ç¤º');
        }

        // è©¢å•å­—é«”åŸå› 
        function askFontReason(combination, index, total) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.id = 'font-reason-modal';
                modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

                modal.innerHTML = `
            <div style="background: #1a1a2e; padding: 40px; border-radius: 20px;
                        max-width: 600px; width: 90%;">
                
                <div style="text-align: center; color: rgba(255,255,255,0.5); 
                            font-size: 13px; margin-bottom: 20px;">
                    ${index + 1} / ${total}
                </div>
                
                <h2 style="color: #d4af37; text-align: center; margin-bottom: 30px;">
                    âœ¨ åˆ†äº«æ‚¨çš„è¨­è¨ˆç†å¿µ
                </h2>
                
                <!-- å­—é«”é è¦½ -->
                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; 
                                border-radius: 16px; text-align: center; flex: 1;">
                        <div style="font-size: 72px; font-family: '${combination.fonts.font1}', serif; 
                                    color: #d4af37; margin-bottom: 15px;">
                            ${combination.letters.letter1}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">
                            å­—æ¯ "${combination.letters.letter1}"
                        </div>
                        <div style="color: #d4af37; font-size: 12px;">
                            ${combination.fonts.font1}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; 
                                border-radius: 16px; text-align: center; flex: 1;">
                        <div style="font-size: 72px; font-family: '${combination.fonts.font2}', serif; 
                                    color: #d4af37; margin-bottom: 15px;">
                            ${combination.letters.letter2}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">
                            å­—æ¯ "${combination.letters.letter2}"
                        </div>
                        <div style="color: #d4af37; font-size: 12px;">
                            ${combination.fonts.font2}
                        </div>
                    </div>
                </div>
                
                <!-- AI å•é¡Œ -->
                <div style="background: rgba(212,175,55,0.1); padding: 20px; 
                            border-radius: 12px; margin-bottom: 20px;
                            border-left: 3px solid #d4af37;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 15px; line-height: 1.6;">
                        å¯ä»¥åˆ†äº«ä¸€ä¸‹é¸æ“‡é€™å…©å€‹å­—é«”çš„åŸå› å—ï¼Ÿ
                    </div>
                </div>
                
                <textarea id="font-reason-input" 
                          placeholder="åˆ†äº«æ‚¨çš„æƒ³æ³•..."
                          style="width: 100%; height: 120px; padding: 15px; 
                                 background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
                                 color: white; border-radius: 12px; font-size: 14px; resize: vertical;
                                 font-family: inherit; margin-bottom: 20px;"></textarea>
                
                <div style="display: flex; gap: 12px;">
                    <button id="submit-reason-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #d4af37, #aa8a2e);
                                   color: #000; border: none; border-radius: 12px; font-size: 14px; font-weight: 600;
                                   cursor: pointer;">
                        é€å‡º
                    </button>
                    <button id="skip-reason-btn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08);
                                   border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 12px;
                                   font-size: 14px; font-weight: 600; cursor: pointer;">
                        è·³é
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(modal);

                // é€å‡ºæŒ‰éˆ•
                document.getElementById('submit-reason-btn').onclick = () => {
                    const reason = document.getElementById('font-reason-input').value.trim();

                    if (!reason) {
                        alert('è«‹åˆ†äº«æ‚¨çš„æƒ³æ³•');
                        return;
                    }

                    modal.remove();
                    resolve(reason);
                };

                // è·³éæŒ‰éˆ•
                document.getElementById('skip-reason-btn').onclick = () => {
                    modal.remove();
                    resolve('');  // ç©ºå­—ä¸²ä»£è¡¨è·³é
                };
            });
        }

        // å‘¼å«å¾Œç«¯ç”Ÿæˆè¨­è¨ˆç†å¿µ
        async function generateDesignStory(combination, fontReason) {
            try {
                // å„ªå…ˆä½¿ç”¨ä»˜æ¬¾å¾Œå¾å¾Œç«¯è¼‰å…¥çš„ AI è«®è©¢è³‡æ–™
                let aiData = window.aiConsultationData;

                // å¦‚æœæ²’æœ‰ï¼ˆä¾‹å¦‚æ¸¬è©¦æ¨¡å¼ï¼‰ï¼Œæ‰å¾ localStorage å–å¾—
                if (!aiData) {
                    const aiDataStr = localStorage.getItem('duet_ai_consultation');
                    if (aiDataStr) {
                        aiData = JSON.parse(aiDataStr);
                    }
                }

                if (!aiData) {
                    console.warn('âš ï¸ ç„¡ AI è«®è©¢è³‡æ–™ï¼Œä½¿ç”¨é è¨­æ ¼å¼');
                    return `é€™å€‹ DUET ä½œå“äº¤ç¹”äº† ${combination.letters.letter1} å’Œ ${combination.letters.letter2} å…©å€‹å­—æ¯ã€‚\n\n${fontReason}`;
                }

                const conversationSummary = aiData.conversationSummary || aiData;

                const response = await fetch(`${BACKEND_URL}/api/design-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationSummary: conversationSummary,
                        selectedFonts: {
                            letter1: combination.letters.letter1,
                            font1: combination.fonts.font1,
                            letter2: combination.letters.letter2,
                            font2: combination.fonts.font2
                        },
                        fontReason: fontReason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… è¨­è¨ˆç†å¿µç”ŸæˆæˆåŠŸ');
                    let story = result.designStory;
                    
                    // æ¸…ç† JSON æ¨™è¨˜å’Œå¤šé¤˜å…§å®¹
                    story = story
                        .replace(/```json\s*/gi, '')
                        .replace(/```\s*/g, '')
                        .replace(/^\s*{\s*"designStory":\s*"/i, '')
                        .replace(/"\s*}\s*$/i, '')
                        .replace(/^["'\s]+|["'\s]+$/g, '')
                        .trim();

                    // å‰ç«¯å®‰å…¨ç¶²ï¼šç¢ºä¿ä¸è¶…é 250 å­—
                    if (story.length > 250) {
                        console.warn('âš ï¸ è¨­è¨ˆç†å¿µè¶…é 250 å­—ï¼Œè‡ªå‹•æˆªæ–·');
                        story = story.substring(0, 247) + '...';
                    }

                    return story;
                } else {
                    console.error('âŒ è¨­è¨ˆç†å¿µç”Ÿæˆå¤±æ•—:', result.error);
                    // å›å‚³é è¨­æ ¼å¼
                    return `é€™å€‹ DUET ä½œå“äº¤ç¹”äº† ${combination.letters.letter1} å’Œ ${combination.letters.letter2} å…©å€‹å­—æ¯ã€‚\n\n${fontReason}`;
                }

            } catch (error) {
                console.error('âŒ è¨­è¨ˆç†å¿µç”ŸæˆéŒ¯èª¤:', error);
                // å›å‚³é è¨­æ ¼å¼
                return `é€™å€‹ DUET ä½œå“äº¤ç¹”äº† ${combination.letters.letter1} å’Œ ${combination.letters.letter2} å…©å€‹å­—æ¯ã€‚\n\n${fontReason}`;
            }
        }

        // å°‡ lastOrderId è¨­ç‚ºå…¨åŸŸè®Šæ•¸ï¼ˆåœ¨ processPayment ä¸­è¨­å®šï¼‰
        window.lastOrderId = null;

        // ä¸»çµå¸³å‡½æ•¸ï¼ˆæ ¹æ“šæ¸¬è©¦æ¨¡å¼æ±ºå®šæµç¨‹ï¼‰
        function checkout() {
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¶“é AI è«®è©¢
            const aiDataStr = localStorage.getItem('duet_ai_consultation');
            const hasAIConsultation = aiDataStr && aiDataStr !== 'null';

            if (hasAIConsultation) {
                // é¡¯ç¤ºæé†’å½ˆçª—
                showCheckoutReminder();
            } else {
                // æ²’æœ‰ AI è«®è©¢ï¼Œç›´æ¥çµå¸³
                if (TESTING_MODE) {
                    testModeCheckout();
                } else {
                    processPayment();
                }
            }
        }

        // é¡¯ç¤ºçµå¸³æé†’å½ˆçª—
        function showCheckoutReminder() {
            const modal = document.getElementById('checkout-reminder-modal');
            modal.style.display = 'flex';

            // ç¶å®šæŒ‰éˆ•äº‹ä»¶ï¼ˆåªç¶å®šä¸€æ¬¡ï¼‰
            const btn = document.getElementById('proceed-to-checkout-btn');
            btn.onclick = function () {
                modal.style.display = 'none';
                if (TESTING_MODE) {
                    testModeCheckout();
                } else {
                    processPayment();
                }
            };
        }

        // æ­£å¸¸æ”¯ä»˜æµç¨‹
        async function processPayment() {
            console.log('ğŸ’³ é–‹å§‹æ”¯ä»˜æµç¨‹...');

            // æ”¶é›†ç”¨æˆ¶è³‡è¨Š
            console.log('ğŸ“ ç­‰å¾…ç”¨æˆ¶å¡«å¯«è³‡è¨Š...');
            const userInfo = await getUserInfo();
            console.log('âœ… ç”¨æˆ¶è³‡è¨Šæ”¶é›†å®Œæˆ:', userInfo ? 'æˆåŠŸ' : 'å·²å–æ¶ˆ');

            if (!userInfo) {
                console.warn('âš ï¸ ç”¨æˆ¶å–æ¶ˆå¡«å¯«è³‡è¨Š');
                return; // ç”¨æˆ¶å–æ¶ˆ
            }

            const orderId = 'DUET' + Date.now();
            console.log('ğŸ”¢ è¨‚å–®ID:', orderId);
            console.log('ğŸ“¦ è³¼ç‰©è»Šå•†å“:', cartItems);
            console.log('ğŸ’° åŸå§‹é‡‘é¡:', originalTotal);
            console.log('ğŸ« å„ªæƒ ç¢¼:', appliedPromoCode || 'ç„¡');

            try {
                // å–å¾— AI è«®è©¢è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const aiDataStr = localStorage.getItem('duet_ai_consultation');
                const aiData = aiDataStr ? JSON.parse(aiDataStr) : null;

                // å‘¼å«å¾Œç«¯åˆå§‹åŒ–æ”¯ä»˜
                console.log('ğŸŒ å‘¼å«å¾Œç«¯ API:', `${BACKEND_URL}/api/checkout`);
                console.log('ğŸ’° DEBUG - originalTotal:', originalTotal, 'type:', typeof originalTotal);
                console.log('ğŸ« DEBUG - appliedPromoCode:', appliedPromoCode);
                
                // ç¢ºä¿ total æ˜¯æ•¸å­—
                const totalAmount = Number(originalTotal);
                if (isNaN(totalAmount) || totalAmount < 1) {
                    alert('âŒ è¨‚å–®é‡‘é¡éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦');
                    return;
                }
                
                const response = await fetch(`${BACKEND_URL}/api/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        items: cartItems,
                        userInfo: userInfo,
                        total: totalAmount,             // ç¢ºä¿æ˜¯æ•¸å­—
                        promoCode: appliedPromoCode,    // å‚³é€å„ªæƒ ç¢¼
                        aiConsultation: aiData,         // âœ… æ–°å¢ï¼šAI è«®è©¢è³‡æ–™
                        returnUrl: window.location.origin + '/payment-success.html'
                    })
                });

                console.log('ğŸ“¡ API å›æ‡‰ç‹€æ…‹:', response.status);
                const result = await response.json();
                console.log('ğŸ“¦ API å›æ‡‰å…§å®¹:', result);

                if (result.success) {
                    console.log('âœ… çµå¸³æˆåŠŸï¼Œæº–å‚™é¡¯ç¤ºç¶ ç•Œè¡¨å–®');
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šé‡‘é¡ç‹€æ³ï¼ˆå„ªæƒ å¾Œ â‰¤ 0ï¼‰
                    if (result.specialAmountCase) {
                        console.log('âš ï¸ ç‰¹æ®Šç‹€æ³ï¼šå„ªæƒ å¾Œé‡‘é¡ç‚º 0ï¼Œéœ€ç”¨æˆ¶ç¢ºèª');
                        
                        // é¡¯ç¤ºèªªæ˜å½ˆçª—
                        const confirmed = await showSpecialAmountModal(result.originalTotal, result.discount);
                        
                        if (!confirmed) {
                            console.log('âŒ ç”¨æˆ¶å–æ¶ˆçµå¸³');
                            return;
                        }
                    }
                    
                    // é¡¯ç¤ºç¶ ç•Œæ”¯ä»˜è¡¨å–®
                    displayPaymentForm(result.paymentFormHTML);
                } else {
                    console.error('âŒ çµå¸³å¤±æ•—:', result.error);
                    alert('âŒ çµå¸³å¤±æ•—ï¼š' + result.error);
                }

            } catch (error) {
                console.error('âŒ æ”¯ä»˜éŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack
                });
                alert('âŒ æ”¯ä»˜éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // æ”¶é›†ç”¨æˆ¶è³‡è¨Š
        async function getUserInfo() {
            return new Promise((resolve) => {
                // å‰µå»ºè¡¨å–® modal
                const modal = document.createElement('div');
                modal.id = 'user-info-modal';
                modal.className = 'modal active';
                // è¨­å®š z-index ç¢ºä¿è¡¨å–®åœ¨æœ€ä¸Šå±¤
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px !important; width: 90%; max-height: 90vh; overflow-y: auto; background: #1a1a2e; padding: 50px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="margin-bottom: 20px; color: #d4af37;">å¡«å¯«è¨‚è³¼è³‡è¨Š</h2>
                        ${appliedPromoCode ? `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #4CAF50; font-size: 14px;">
                                <span>âœ…</span>
                                <span>å·²å¥—ç”¨å„ªæƒ ç¢¼ï¼š<strong>${appliedPromoCode}</strong></span>
                            </div>
                            <div style="margin-top: 5px; font-size: 13px; color: rgba(255,255,255,0.6);">
                                æŠ˜æ‰£ NT$ ${promoDiscount.toLocaleString()}
                            </div>
                        </div>
                        ` : ''}
                        <form id="user-info-form">
                            <!-- è³¼è²·äººè³‡è¨Š -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">è³¼è²·äººè³‡è¨Š</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">è³¼è²·äººå§“å *</label>
                                    <input type="text" id="buyer-name" required 
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Email *</label>
                                    <input type="email" id="buyer-email" required
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                                    <input type="tel" id="buyer-phone" required pattern="[0-9]{10}"
                                           placeholder="0912345678"
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                            </div>
                            
                            <!-- æ”¶ä»¶äººè³‡è¨Š -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">æ”¶ä»¶äººè³‡è¨Š</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                        <input type="checkbox" id="same-as-buyer" 
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleRecipientFields(this.checked)">
                                        <label for="same-as-buyer" style="cursor: pointer; font-size: 13px; color: rgba(255,255,255,0.7);">
                                            åŒè³¼è²·äºº
                                        </label>
                                    </div>
                                    
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">æ”¶ä»¶äººå§“å *</label>
                                    <input type="text" id="recipient-name" required 
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">æ”¶ä»¶äººæ‰‹æ©Ÿ *</label>
                                    <input type="tel" id="recipient-phone" required pattern="[0-9]{10}"
                                           placeholder="0912345678"
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                            </div>
                            
                            <!-- æ”¶è²¨åœ°å€ -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">æ”¶è²¨åœ°å€</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">éƒµéå€è™Ÿ</label>
                                    <input type="text" id="postal-code" pattern="[0-9]{3,5}"
                                           placeholder="ä¾‹ï¼š100"
                                           style="width: 120px; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">æ”¶è²¨åœ°å€ *</label>
                                    <textarea id="shipping-address" required rows="3"
                                              placeholder="è«‹å¡«å¯«å®Œæ•´æ”¶è²¨åœ°å€ï¼ˆç¸£å¸‚ã€é„‰é®å€ã€è·¯è¡—å··å¼„è™Ÿï¼‰"
                                              style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                     background: rgba(255,255,255,0.1); color: white; border-radius: 5px; 
                                                     resize: vertical; font-family: inherit;"></textarea>
                                </div>
                            </div>
                            
                            <!-- ç™¼ç¥¨è³‡è¨Š -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">ç™¼ç¥¨è³‡è¨Š</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="invoice-type" value="personal" checked
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleInvoiceFields(false)">
                                        <span style="color: rgba(255,255,255,0.8);">å€‹äººç™¼ç¥¨ï¼ˆäºŒè¯å¼ï¼‰</span>
                                    </label>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="invoice-type" value="company"
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleInvoiceFields(true)">
                                        <span style="color: rgba(255,255,255,0.8);">å…¬å¸ç™¼ç¥¨ï¼ˆä¸‰è¯å¼ï¼‰</span>
                                    </label>
                                </div>
                                
                                <div id="company-invoice-fields" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">çµ±ä¸€ç·¨è™Ÿ *</label>
                                        <input type="text" id="company-tax-id" pattern="[0-9]{8}"
                                               placeholder="8ä½æ•¸å­—"
                                               style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">å…¬å¸æŠ¬é ­ *</label>
                                        <input type="text" id="company-name"
                                               placeholder="å…¬å¸åç¨±"
                                               style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å‚™è¨» -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">å‚™è¨»</label>
                                <textarea id="order-note" rows="3"
                                          placeholder="æœ‰ä»»ä½•ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»ï¼Œè«‹åœ¨æ­¤å¡«å¯«"
                                          style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                 background: rgba(255,255,255,0.1); color: white; border-radius: 5px; 
                                                 resize: vertical; font-family: inherit;"></textarea>
                            </div>
                            
                            <!-- é‡‘é¡æ‘˜è¦ -->
                            <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 10px;">è¨‚å–®é‡‘é¡ï¼š</div>
                                ${promoDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; font-size: 14px; color: rgba(255,255,255,0.5); text-decoration: line-through; margin-bottom: 5px;">
                                    <span>åŸåƒ¹</span>
                                    <span>NT$ ${originalTotal.toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 14px; color: #4CAF50; margin-bottom: 5px;">
                                    <span>å„ªæƒ æŠ˜æ‰£</span>
                                    <span>-NT$ ${promoDiscount.toLocaleString()}</span>
                                </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #d4af37; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <span>æ‡‰ä»˜é‡‘é¡</span>
                                    <span>NT$ ${calculateCartTotal().toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn" style="flex: 1;">
                                    ç¹¼çºŒä»˜æ¬¾
                                </button>
                                <button type="button" class="btn" style="flex: 1; background: rgba(255,255,255,0.1);" 
                                        onclick="document.getElementById('user-info-modal').remove();">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // ã€ŒåŒè³¼è²·äººã€checkbox è™•ç†
                window.toggleRecipientFields = function (isSame) {
                    if (isSame) {
                        document.getElementById('recipient-name').value = document.getElementById('buyer-name').value;
                        document.getElementById('recipient-phone').value = document.getElementById('buyer-phone').value;
                        document.getElementById('recipient-name').disabled = true;
                        document.getElementById('recipient-phone').disabled = true;
                    } else {
                        document.getElementById('recipient-name').disabled = false;
                        document.getElementById('recipient-phone').disabled = false;
                    }
                };

                // è³¼è²·äººæ¬„ä½è®ŠåŒ–æ™‚è‡ªå‹•åŒæ­¥ï¼ˆå¦‚æœå·²å‹¾é¸ï¼‰
                ['buyer-name', 'buyer-phone'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        if (document.getElementById('same-as-buyer').checked) {
                            toggleRecipientFields(true);
                        }
                    });
                });

                // ç™¼ç¥¨é¡å‹åˆ‡æ›è™•ç†
                window.toggleInvoiceFields = function (isCompany) {
                    const fields = document.getElementById('company-invoice-fields');
                    const taxId = document.getElementById('company-tax-id');
                    const companyName = document.getElementById('company-name');

                    if (isCompany) {
                        fields.style.display = 'block';
                        taxId.required = true;
                        companyName.required = true;
                    } else {
                        fields.style.display = 'none';
                        taxId.required = false;
                        companyName.required = false;
                    }
                };

                // è™•ç†è¡¨å–®æäº¤
                document.getElementById('user-info-form').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const invoiceType = document.querySelector('input[name="invoice-type"]:checked').value;

                    const userInfo = {
                        // è³¼è²·äººè³‡è¨Š
                        buyerName: document.getElementById('buyer-name').value.trim(),
                        buyerEmail: document.getElementById('buyer-email').value.trim(),
                        buyerPhone: document.getElementById('buyer-phone').value.trim(),

                        // æ”¶ä»¶äººè³‡è¨Š
                        recipientName: document.getElementById('recipient-name').value.trim(),
                        recipientPhone: document.getElementById('recipient-phone').value.trim(),

                        // æ”¶è²¨åœ°å€
                        postalCode: document.getElementById('postal-code').value.trim(),
                        shippingAddress: document.getElementById('shipping-address').value.trim(),

                        // ç™¼ç¥¨è³‡è¨Š
                        invoiceType: invoiceType,
                        companyTaxId: invoiceType === 'company' ? document.getElementById('company-tax-id').value.trim() : '',
                        companyName: invoiceType === 'company' ? document.getElementById('company-name').value.trim() : '',

                        // å‚™è¨»
                        note: document.getElementById('order-note').value.trim(),

                        // ç‚ºäº†å‘å¾Œå…¼å®¹ï¼Œä¿ç•™èˆŠçš„æ¬„ä½åç¨±
                        name: document.getElementById('recipient-name').value.trim(),
                        email: document.getElementById('buyer-email').value.trim(),
                        phone: document.getElementById('recipient-phone').value.trim(),
                        address: document.getElementById('shipping-address').value.trim()
                    };

                    modal.remove();
                    resolve(userInfo);
                });
            });
        }

        // é¡¯ç¤ºç¶ ç•Œæ”¯ä»˜è¡¨å–®
        // ä»˜æ¬¾å®Œæˆè¨Šæ¯å½ˆçª—
        function showPaymentCompleteModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(20px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: rgba(255, 255, 255, 0.08);
                    backdrop-filter: blur(40px) saturate(180%);
                    -webkit-backdrop-filter: blur(40px) saturate(180%);
                    border: 1px solid rgba(255, 255, 255, 0.18);
                    border-radius: 24px;
                    padding: 40px;
                    width: 420px;
                    text-align: center;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                ">
                    <div style="font-size: 64px; margin-bottom: 24px;">âœ“</div>
                    <h2 style="
                        color: rgba(255, 255, 255, 0.95);
                        margin: 0 0 20px 0;
                        font-size: 22px;
                        font-weight: 500;
                        letter-spacing: 0.5px;
                    ">è¨‚å–®å·²å®Œæˆ</h2>
                    <p style="
                        color: rgba(255, 255, 255, 0.7);
                        font-size: 14px;
                        line-height: 1.8;
                        margin: 0 0 28px 0;
                    ">
                        æ‚¨çš„è¨­è¨ˆå·²å®Œæˆï¼Œå°‡å¾ˆå¿«æ”¶åˆ°è¨‚å–®ç¢ºèªä¿¡<br>
                        ç•«é¢å³å°‡å°å¼•è‡³ BCAG è¨­è¨ˆå¸«è¨‚è£½ç å¯¶é¦–é 
                    </p>
                    <div style="
                        color: rgba(212, 175, 55, 0.8);
                        font-size: 13px;
                        font-weight: 500;
                    ">3 ç§’å¾Œè‡ªå‹•è·³è½‰...</div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 3 ç§’å¾Œè·³è½‰
            setTimeout(() => {
                window.location.href = 'https://www.brendonchen.com';
            }, 3000);
        }
        
        // ç‰¹æ®Šé‡‘é¡èªªæ˜å½ˆçª—ï¼ˆå„ªæƒ å¾Œ â‰¤ 0 å…ƒï¼‰
        // ç‰¹æ®Šé‡‘é¡èªªæ˜å½ˆçª—ï¼ˆLiquid Glass é¢¨æ ¼ï¼‰
        function showSpecialAmountModal(originalTotal, discount) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(20px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: rgba(255, 255, 255, 0.08);
                        backdrop-filter: blur(40px) saturate(180%);
                        -webkit-backdrop-filter: blur(40px) saturate(180%);
                        border: 1px solid rgba(255, 255, 255, 0.18);
                        border-radius: 24px;
                        padding: 32px 36px;
                        width: 380px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    ">
                        <h3 style="
                            color: rgba(255, 255, 255, 0.95);
                            margin: 0 0 22px 0;
                            font-size: 17px;
                            font-weight: 500;
                            letter-spacing: 0.3px;
                        ">å„ªæƒ æŠ˜æŠµèªªæ˜</h3>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.2);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255, 255, 255, 0.08);
                            border-radius: 14px;
                            padding: 16px 18px;
                            margin-bottom: 18px;
                        ">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: rgba(255, 255, 255, 0.55); font-size: 13px;">åŸåƒ¹</span>
                                <span style="color: rgba(255, 255, 255, 0.4); font-size: 13px; text-decoration: line-through;">NT$ ${originalTotal.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: rgba(255, 255, 255, 0.55); font-size: 13px;">æŠ˜æ‰£</span>
                                <span style="color: rgba(76, 175, 80, 0.85); font-size: 13px; font-weight: 500;">-NT$ ${discount.toLocaleString()}</span>
                            </div>
                            <div style="
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                                margin: 10px 0 0 0;
                                padding-top: 10px;
                            ">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255, 255, 255, 0.75); font-size: 14px;">æ‡‰ä»˜é‡‘é¡</span>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 600;">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <p style="
                            color: rgba(255, 255, 255, 0.6);
                            font-size: 12px;
                            line-height: 1.6;
                            margin: 0 0 22px 0;
                        ">
                            å„ªæƒ æŠ˜æŠµå¾Œé‡‘é¡ç‚º 0 å…ƒã€‚ç”±æ–¼é‡‘æµç³»çµ±è¦æ±‚æœ€ä½äº¤æ˜“é‡‘é¡ç‚º NT$ 1ï¼Œæ‚¨åªéœ€æ”¯ä»˜ <span style="color: rgba(212, 175, 55, 0.9);">NT$ 1</span> å³å¯å®Œæˆè¨‚å–®ã€‚
                        </p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="cancel-special-btn" style="
                                flex: 1;
                                padding: 11px 18px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.15);
                                color: rgba(255, 255, 255, 0.7);
                                border-radius: 12px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: all 0.3s;
                                backdrop-filter: blur(10px);
                            ">
                                å–æ¶ˆ
                            </button>
                            <button id="confirm-special-btn" style="
                                flex: 1.2;
                                padding: 11px 18px;
                                background: rgba(212, 175, 55, 0.2);
                                border: 1px solid rgba(212, 175, 55, 0.4);
                                color: rgba(212, 175, 55, 0.95);
                                border-radius: 12px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.3s;
                                backdrop-filter: blur(10px);
                                white-space: nowrap;
                            ">
                                ç¢ºå®šä»˜æ¬¾
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('confirm-special-btn').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.getElementById('cancel-special-btn').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                // Hover æ•ˆæœ
                const confirmBtn = document.getElementById('confirm-special-btn');
                confirmBtn.onmouseover = () => {
                    confirmBtn.style.background = 'rgba(212, 175, 55, 0.3)';
                    confirmBtn.style.borderColor = 'rgba(212, 175, 55, 0.6)';
                };
                confirmBtn.onmouseout = () => {
                    confirmBtn.style.background = 'rgba(212, 175, 55, 0.2)';
                    confirmBtn.style.borderColor = 'rgba(212, 175, 55, 0.4)';
                };
                
                const cancelBtn = document.getElementById('cancel-special-btn');
                cancelBtn.onmouseover = () => {
                    cancelBtn.style.background = 'rgba(255, 255, 255, 0.08)';
                };
                cancelBtn.onmouseout = () => {
                    cancelBtn.style.background = 'rgba(255, 255, 255, 0.05)';
                };
            });
        }

        // é¡¯ç¤ºç¶ ç•Œæ”¯ä»˜è¡¨å–®
        function displayPaymentForm(formHTML) {
            // å‰µå»ºé®ç½©å±¤
            const overlay = document.createElement('div');
            overlay.id = 'payment-overlay';
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.9); z-index: 10000; 
                            display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 15px; 
                                max-width: 500px; text-align: center;">
                        <h2 style="color: #333; margin-bottom: 15px;">è·³è½‰è‡³ç¶ ç•Œæ”¯ä»˜...</h2>
                        <p style="color: #666; margin-bottom: 20px;">è«‹ç¨å€™ï¼Œæ­£åœ¨ç‚ºæ‚¨å°å‘æ”¯ä»˜é é¢</p>
                        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; 
                                    border-top: 5px solid #3498db; border-radius: 50%; 
                                    animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        ${formHTML}
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            // è‡ªå‹•æäº¤è¡¨å–®
            setTimeout(() => {
                const form = overlay.querySelector('form');
                if (form) {
                    console.log('ğŸ”„ è‡ªå‹•æäº¤ç¶ ç•Œè¡¨å–®...');
                    // âœ… é—œéµä¿®æ”¹ï¼šè·³å‡º Wix iframe
                    form.target = '_top';
                    form.submit();
                }
            }, 1500);
        }

        // äº‹ä»¶ç›£è½
        function setupEventListeners() {
            // åˆå§‹åŒ–å­—æ¯é¸å–®
            const letter1 = document.getElementById('letter1');
            const letter2 = document.getElementById('letter2');

            for (let i = 65; i <= 90; i++) {
                letter1.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
                letter2.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
            }
            for (let i = 97; i <= 122; i++) {
                letter1.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
                letter2.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
            }

            document.getElementById('font1-btn').addEventListener('click', openFontSelector);
            document.getElementById('font2-btn').addEventListener('click', openFontSelector);
            document.getElementById('close-modal').addEventListener('click', closeFontSelector);
            document.getElementById('confirm-btn').addEventListener('click', confirmFontSelection);

            // çµæ§‹åƒæ•¸æ”¹è®Š â†’ é‡å»ºæ¨¡å‹
            ['letter1', 'letter2', 'size'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    // å¦‚æœå­—é«”é¸æ“‡è¦–çª—é–‹è‘—ï¼ŒåŒæ­¥å­—æ¯åˆ°è¦–çª—
                    const modal = document.getElementById('font-selector-modal');
                    if (modal.classList.contains('active')) {
                        const letter1 = document.getElementById('letter1').value;
                        const letter2 = document.getElementById('letter2').value;
                        const charInput = document.getElementById('char-input');
                        charInput.value = letter1 + letter2;
                        charInput.dispatchEvent(new Event('input'));
                    }

                    generateModel();
                });
            });

            // æè³ªåƒæ•¸æ”¹è®Š â†’ åªæ›´æ–°æè³ªï¼Œä¸é‡å»ºæ¨¡å‹ï¼ˆå³æ™‚ï¼ï¼‰
            ['material', 'finish', 'plating'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    updateMaterial();
                });
            });

            ['bailX', 'bailY', 'bailZ', 'bailRotation'].forEach(id => {
                const slider = document.getElementById(id);
                slider.addEventListener('input', (e) => {
                    const suffix = id === 'bailRotation' ? 'Â°' : '';
                    document.getElementById(`${id}-val`).textContent = e.target.value + suffix;
                    // åªæ›´æ–°ä½ç½®ï¼Œä¸é‡æ–°å‰µå»º
                    updateBailPosition();
                });
            });

            document.getElementById('save-slot-1').addEventListener('click', () => saveToSlot(0));
            document.getElementById('save-slot-2').addEventListener('click', () => saveToSlot(1));

            // Slot é»æ“Šå¬å›
            document.querySelector('[data-slot="1"]').addEventListener('click', () => {
                if (savedVersions[0]) loadFromSlot(0);
            });
            document.querySelector('[data-slot="2"]').addEventListener('click', () => {
                if (savedVersions[1]) loadFromSlot(1);
            });
            document.getElementById('addToCartBtn').addEventListener('click', (e) => {
                // å¦‚æœé»æ“Šçš„æ˜¯ View Cart å€åŸŸï¼Œåªæ‰“é–‹è³¼ç‰©è»Š
                if (e.target.id === 'viewCartBtn' || e.target.closest('#viewCartBtn')) {
                    openCart();
                } else {
                    // å¦å‰‡æ˜¯ Add to Cart
                    addToCart();
                }
            });
            document.getElementById('continue-shopping').addEventListener('click', closeCart);
            document.getElementById('checkout').addEventListener('click', checkout);

            // è¨­è¨ˆç†å¿µå¡ç‰‡åˆ‡æ›é‚è¼¯
            const cardStyles = [
                { name: 'ç¶“å…¸é¢¨æ ¼', bg: '#f5f5dc', border: '3px solid #d4af37', color: '#2d2d2d' },
                { name: 'ç¾ä»£é¢¨æ ¼', bg: '#2d2d2d', border: '2px solid #c0c0c0', color: '#ffffff' },
                { name: 'æµªæ¼«é¢¨æ ¼', bg: '#fff5f5', border: '3px solid #dda0a0', color: '#2d2d2d' }
            ];
            let currentCardStyle = 0;

            function updateCardStyle() {
                const card = document.getElementById('story-card');
                const styleName = document.getElementById('card-style-name');
                const style = cardStyles[currentCardStyle];

                card.style.background = style.bg;
                card.style.border = style.border;
                card.style.color = style.color;
                styleName.textContent = style.name;

                // æ›´æ–°å…§å®¹å€åŸŸé¡è‰²
                document.getElementById('story-content').style.color = style.color;
            }

            document.getElementById('prev-card-style').addEventListener('click', () => {
                currentCardStyle = (currentCardStyle - 1 + cardStyles.length) % cardStyles.length;
                updateCardStyle();
            });

            document.getElementById('next-card-style').addEventListener('click', () => {
                currentCardStyle = (currentCardStyle + 1) % cardStyles.length;
                updateCardStyle();
            });

            document.getElementById('confirm-story-card').addEventListener('click', () => {
                // ç²å–ç·¨è¼¯å¾Œçš„è¨­è¨ˆç†å¿µ
                const editedStory = document.getElementById('story-content').textContent;

                // å„²å­˜åˆ°å…¨å±€è®Šæ•¸ï¼ˆä¾›å¾ŒçºŒè¨‚å–®ä½¿ç”¨ï¼‰
                window.finalDesignStory = editedStory;

                console.log('âœ… è¨­è¨ˆç†å¿µå·²ç¢ºèª:', editedStory);

                // é—œé–‰ Modal
                document.getElementById('design-story-modal').style.display = 'none';
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºä»˜æ¬¾æˆåŠŸæµç¨‹
                const urlParams = new URLSearchParams(window.location.search);
                const isPaymentFlow = urlParams.get('payment_success') === 'true';
                
                if (isPaymentFlow) {
                    console.log('âœ… ä»˜æ¬¾æµç¨‹å®Œæˆï¼Œé¡¯ç¤ºå®Œæˆè¨Šæ¯');
                    showPaymentCompleteModal();
                }
            });

            // åˆå§‹åŒ–å¡ç‰‡æ¨£å¼
            updateCardStyle();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // åŒæ­¥ Slot ç›¸æ©Ÿä½ç½®å’Œæ¸²æŸ“
            if (slot1Camera && slot1Renderer && slot1Scene) {
                slot1Camera.position.copy(camera.position).multiplyScalar(0.5); // ç¸®æ”¾è·é›¢
                slot1Camera.lookAt(0, 0, 0);
                slot1Renderer.render(slot1Scene, slot1Camera);
            }
            if (slot2Camera && slot2Renderer && slot2Scene) {
                slot2Camera.position.copy(camera.position).multiplyScalar(0.5); // ç¸®æ”¾è·é›¢
                slot2Camera.lookAt(0, 0, 0);
                slot2Renderer.render(slot2Scene, slot2Camera);
            }

            renderer.render(scene, camera);
        }

        // å•Ÿå‹•
        initScene();
        initFontSelector();
        setupEventListeners();
        animate();

        // åˆå§‹åŒ–åƒ¹æ ¼é¡¯ç¤º
        updatePriceDisplay();

        // æš´éœ²é—œéµå‡½æ•¸åˆ°å…¨å±€ï¼ˆç¢ºä¿ HTML onclick å¯ä»¥è¨ªå•ï¼‰
        window.applyPromoCode = applyPromoCode;
        window.removePromoCode = removePromoCode;
        window.checkout = checkout;

        // æ¸¬è©¦è¨­è¨ˆç†å¿µå¡ç‰‡é¡¯ç¤º
        window.testDesignStoryCard = function () {
            const modal = document.getElementById('design-story-modal');
            const content = document.getElementById('story-content');

            // æ¸¬è©¦å…§å®¹
            content.innerHTML = `
                é€™æ˜¯ä¸€å€‹é—œæ–¼ã€ŒLã€èˆ‡ã€ŒJã€çš„æ•…äº‹ã€‚<br><br>
                
                å­—æ¯ã€ŒLã€é¸ç”¨äº†å„ªé›…çš„ Playfair Display å­—é«”ï¼Œ<br>
                è±¡å¾µè‘—æº«æŸ”ä¸­å¸¶è‘—åŠ›é‡çš„å …å®šã€‚<br><br>
                
                å­—æ¯ã€ŒJã€å‰‡æ¡ç”¨ Dancing Script æ‰‹å¯«é«”ï¼Œ<br>
                å±•ç¾å‡ºè‡ªç”±å¥”æ”¾çš„æµªæ¼«æƒ…æ‡·ã€‚<br><br>
                
                å…©å€‹å­—æ¯äº¤ç¹”åœ¨ä¸€èµ·ï¼Œ<br>
                å¦‚åŒå…©é¡†å¿ƒéˆç›¸äº’ä¾åï¼Œ<br>
                å…±åŒè­œå¯«å±¬æ–¼ä½ å€‘çš„ç¨ç‰¹ç¯‡ç« ã€‚
            `;

            modal.style.display = 'flex';
            console.log('âœ… è¨­è¨ˆç†å¿µå¡ç‰‡å·²é¡¯ç¤º');
        };

        console.log('âœ… å…¨å±€å‡½æ•¸å·²æš´éœ²:', {
            applyPromoCode: typeof window.applyPromoCode,
            removePromoCode: typeof window.removePromoCode,
            checkout: typeof window.checkout,
            testDesignStoryCard: typeof window.testDesignStoryCard
        });

        // è¼‰å…¥ Google Fonts - åˆ†æ‰¹è¼‰å…¥å¯ç”¨å­—é«”ï¼ˆä½¿ç”¨ availableFontsï¼‰
        function loadGoogleFonts() {
            if (!availableFonts || availableFonts.length === 0) return;
            const batchSize = 50;
            for (let i = 0; i < availableFonts.length; i += batchSize) {
                const batch = availableFonts.slice(i, i + batchSize);
                const link = document.createElement('link');
                link.href = 'https://fonts.googleapis.com/css2?family=' + batch.map(f => f.replace(/ /g, '+')).join('&family=') + '&display=swap';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }
    </script>
    <!-- ä½©æˆ´æ¨¡æ“¬é è¦½æ¨¡çµ„ - Temporarily Disabled -->
    <!-- <script src="wearing-preview.js"></script> -->
</body>

</html>