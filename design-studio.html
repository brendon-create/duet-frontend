<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- üîÑ Èò≤Ê≠¢ÁÄèË¶ΩÂô®Âø´ÂèñÔºàÁ¢∫‰øùÊõ¥Êñ∞ÂæåÁ´ãÂç≥ÁîüÊïàÔºâ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>DUET by BCAG</title>

    <!-- Google Fonts: ‰∏≠ÊñáÈãºÁ≠ÜÂ≠óÈ´î -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Noto+Serif+TC:wght@400;500;600&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: #000;
            /* ÂÖàË®≠ÂÆöÈªëËâ≤ËÉåÊôØÔºåÈÅøÂÖçÁôΩËâ≤ÈñÉÁàç */
            background-image: url('https://cdn.jsdelivr.net/gh/brendon-create/duet-frontend@main/assets/images/backgrounds/Toscana.png');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px) saturate(100%);
            -webkit-backdrop-filter: blur(10px) saturate(100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }

        #control-panel {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            padding: 24px;
            border-radius: 20px;
            z-index: 100;
        }

        #control-panel::-webkit-scrollbar {
            width: 4px;
        }

        #control-panel::-webkit-scrollbar-track {
            margin: 20px 0;
        }

        #control-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .panel-header .subtitle {
            font-size: 11px;
            color: #d4af37;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 300;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #d4af37;
            margin-bottom: 16px;
        }

        .control-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
        }

        .flex-row>div:first-child {
            flex: 1;
        }

        .flex-row>div:last-child {
            flex: 2;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #d4af37;
        }

        .font-select-btn {
            width: 100%;
            padding: 12px 16px;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            color: #d4af37;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        /* Â≠óÈ´î‰∏ãÊãâÈÅ∏ÂñÆ‰∏≠ÁöÑÈÅ∏È†Ö‰ª•ÂêÑËá™Â≠óÈ´îÈ°ØÁ§∫ */
        select.font-select-btn {
            font-family: inherit;
        }

        select.font-select-btn option {
            background: #1a1a2e;
            color: #fff;
            padding: 8px;
            font-size: 14px;
        }

        .font-select-btn:hover {
            background: rgba(212, 175, 55, 0.25);
            border-color: #d4af37;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }

        .slider-value {
            float: right;
            color: #d4af37;
            font-weight: 600;
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #000;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.3);
            display: flex;
            align-items: center;
        }

        #addToCartBtn {
            justify-content: space-between;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .view-cart-section {
            width: 70px;
            border-left: 1px solid rgba(0, 0, 0, 0.2);
            padding-left: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 9px;
            cursor: pointer;
        }

        .view-cart-section:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .info-value {
            color: #d4af37;
            font-weight: 600;
            text-align: right;
        }

        #saved-versions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .version-slot {
            width: 160px;
            height: 160px;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .version-slot:hover {
            transform: scale(1.05);
        }

        .version-slot.empty {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px) saturate(100%);
            -webkit-backdrop-filter: blur(10px) saturate(100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .version-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            font-size: 10px;
            text-align: center;
            color: #d4af37;
        }

        #viewport {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }

        /* Font Selector Modal */
        #font-selector-modal {
            display: none;
            position: fixed;
            top: 20px;
            left: 360px;
            right: 20px;
            max-height: calc(100vh - 40px);
            border-radius: 16px;
            z-index: 2000;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        }

        #font-selector-modal.active {
            display: block;
        }

        .close-modal-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
            width: auto;
            padding: 0;
            line-height: 1;
        }

        .close-modal-btn:hover {
            color: #d4af37;
        }

        .modal-layout {
            display: flex;
            height: calc(100vh - 40px);
        }

        .font-sidebar {
            width: 20%;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .font-sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .font-sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        .char-input-group {
            margin-bottom: 20px;
        }

        .char-input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            text-align: center;
            font-size: 18px;
            border-radius: 8px;
        }

        .select-all-group {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }

        .select-all-group input {
            margin-right: 10px;
            cursor: pointer;
        }

        .font-list-item {
            display: flex;
            align-items: center;
            padding: 10px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: background 0.2s;
        }

        .font-list-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .font-list-item input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .font-list-item span {
            font-size: 13px;
            color: #ccc;
        }

        .font-display-area {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 20px;
            align-content: start;
        }

        .font-display-area::-webkit-scrollbar {
            width: 6px;
        }

        .font-display-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .font-preview-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid transparent;
            border-radius: 12px;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 140px;
        }

        .font-preview-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .font-preview-card.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.15);
        }

        .preview-char {
            font-size: 48px;
            margin-bottom: 8px;
            color: #fff;
        }

        .preview-name {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        .confirm-container {
            position: absolute;
            /* ÊîπÁÇ∫ absoluteÔºåÁõ∏Â∞çÊñº font-selector-modal */
            bottom: 30px;
            right: 30px;
            z-index: 2002;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #d4af37 0%, #aa8a2e 100%);
            color: #000;
            border: none;
            padding: 16px 40px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.3);
            transition: all 0.3s;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        /* Cart Modal */
        #cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #cart-modal.active {
            display: flex;
        }

        .cart-container {
            width: 80%;
            max-width: 900px;
            height: 80%;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .cart-items {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .cart-item {
            padding: 20px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-info h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .cart-item-details {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.6;
        }

        .cart-item-price {
            font-size: 20px;
            font-weight: 700;
            color: #d4af37;
            margin-right: 20px;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-input {
            width: 60px;
            padding: 8px;
            text-align: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            -moz-appearance: textfield;
            appearance: none;
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-btns {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .qty-btn {
            width: 24px;
            height: 20px;
            padding: 0;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #d4af37;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .delete-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff4444;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 0.3);
        }

        .cart-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #d4af37;
        }

        .cart-actions {
            display: flex;
            gap: 12px;
        }

        .cart-actions button {
            flex: 1;
            text-align: center;
            justify-content: center;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            letter-spacing: 3px;
        }

        /* ÂÑ™ÊÉ†Á¢ºÊ¨Ñ‰ΩçÊ®£Âºè */
        #promo-code-input:focus {
            border-color: #d4af37;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3);
        }

        #promo-code-input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }

        #apply-promo-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.3), inset 0 1px 0 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        #apply-promo-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #apply-promo-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal ÊªæÂãïÊ¢ùÊ®£Âºè */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.7);
        }

        /* ========== AI Ë´ÆË©¢ÈÄ£ÁµêÊ®£Âºè (Êñ∞Â¢û) ========== */
        .ai-consultant-link {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .ai-consultant-link a {
            color: #d4af37;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
            cursor: pointer;
        }

        .ai-consultant-link a:hover {
            color: #f4d03f;
        }

        /* Èö±ËóèË®≠Ë®àÁêÜÂøµÂç°ÁâáÁöÑÊªæËª∏ */
        #story-content::-webkit-scrollbar {
            display: none;
        }

        /* ÈªûÈªûÂãïÁï´ */
        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .dots-animation::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        /* üßπ Toggle Switch Ê®£Âºè */
        .toggle-switch {
            position: relative;
            display: inline-block;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-label {
            display: block;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toggle-button {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-checkbox:checked + .toggle-label {
            background: rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .toggle-checkbox:checked + .toggle-label .toggle-button {
            left: 22px;
            background: #d4af37;
        }

        .toggle-checkbox:disabled + .toggle-label {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toggle-label:hover:not(.toggle-checkbox:disabled + .toggle-label) {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Liquid Glass Á¢∫Ë™çÂ∞çË©±Ê°Ü */
        .cleanup-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cleanup-confirm-overlay.show {
            opacity: 1;
        }

        .cleanup-confirm-dialog {
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .cleanup-confirm-overlay.show .cleanup-confirm-dialog {
            transform: scale(1);
        }

        .cleanup-confirm-title {
            font-size: 18px;
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 16px;
            text-align: center;
        }

        .cleanup-confirm-message {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 24px;
            text-align: center;
        }

        .cleanup-confirm-buttons {
            display: flex;
            gap: 12px;
        }

        .cleanup-confirm-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .cleanup-confirm-btn.confirm {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: #d4af37;
        }

        .cleanup-confirm-btn.confirm:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .cleanup-confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .cleanup-confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* ËÑàË°ùÂãïÁï´ - Áî®ÊñºÊèêÁ§∫ÁîüÊàêÊåâÈàï */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
            }
        }
        
        /* ‰ΩéË™øÁöÑ Toast ÊèêÁ§∫ */
        .custom-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(40, 40, 40, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            max-width: 90%;
        }
        
        .custom-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        
        .custom-toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .custom-toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .custom-toast-message {
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
    
    <!-- üîß ÈñãÁôºËÄÖÂäüËÉΩÊ®°ÁµÑ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/brendonchen/duet-frontend@main/product-photo-studio.css">
</head>

<body>
    <!-- üîß ÈñãÁôºËÄÖÂäüËÉΩÊ®°ÁµÑ JS -->
    <script src="https://cdn.jsdelivr.net/gh/brendonchen/duet-frontend@main/product-photo-studio.js"></script>
    
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text">LOADING STUDIO...</div>
    </div>

    <div id="viewport"></div>

    <div id="control-panel" class="glass">
        <div class="panel-header">
            <h1>DUET</h1>
            <div class="subtitle">BY BCAG</div>
        </div>

        <div class="section">
            <div class="control-group">
                <label>Letter 1</label>
                <div class="flex-row">
                    <div><select id="letter1"></select></div>
                    <div><button class="font-select-btn" id="font1-btn">Choose Fonts</button></div>
                </div>
            </div>

            <div class="control-group">
                <label>Letter 2</label>
                <div class="flex-row">
                    <div><select id="letter2"></select></div>
                    <div><button class="font-select-btn" id="font2-btn">Choose Fonts</button></div>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="control-group">
            <label>ÊùêË≥™ (Material)</label>
            <select id="material">
                <option value="silver925">925 ÈäÄ</option>
                <option value="brass">ÈªÉÈäÖ</option>
            </select>
        </div>

        <div class="control-group">
            <label>Ë°®Èù¢ÈõªÈçç (Plating)</label>
            <select id="plating">
                <option value="none">ÁÑ°</option>
                <option value="gold18k">18K Èáë</option>
                <option value="whitegold18k">18K ÁôΩKÈáë</option>
                <option value="rosegold18k">18K Áé´Áë∞Èáë</option>
            </select>
        </div>

        <div class="control-group">
            <label>Ë°®Èù¢Ë≥™Âú∞ (Finish)</label>
            <select id="finish">
                <option value="glossy">‰∫ÆÈù¢</option>
                <option value="matte">ÈúßÈù¢</option>
            </select>
        </div>

        <div class="control-group">
            <label>Size (Height)</label>
            <select id="size">
                <option value="8">8 mm</option>
                <option value="10">10 mm</option>
                <option value="12">12 mm</option>
                <option value="15" selected>15 mm</option>
                <option value="18">18 mm</option>
            </select>
        </div>

        <div class="divider"></div>

        <div class="section-title">Bail Position</div>

        <div class="control-group">
            <label>X (Left/Right) <span class="slider-value" id="bailX-val">0.0</span></label>
            <input type="range" id="bailX" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Y (Front/Back) <span class="slider-value" id="bailY-val">0.0</span></label>
            <input type="range" id="bailY" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Z (Up/Down) <span class="slider-value" id="bailZ-val">0.0</span></label>
            <input type="range" id="bailZ" min="-10" max="10" step="0.1" value="0">
        </div>

        <div class="control-group">
            <label>Rotation <span class="slider-value" id="bailRotation-val">0¬∞</span></label>
            <input type="range" id="bailRotation" min="0" max="90" step="1" value="0">
        </div>

        <!-- üßπ Ê∏ÖÁêÜÈõ∂Á¢éÈÉ®‰ª∂ÈñãÈóú -->
        <div class="control-group" style="margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label id="cleanup-label" style="margin: 0; font-size: 13px;">Ê∏ÖÁêÜ‰ΩúÂìÅÈõ∂Á¢éÈÉ®‰ª∂</label>
                
                <!-- Toggle Switch -->
                <div class="toggle-switch" id="cleanup-toggle-container">
                    <input type="checkbox" id="cleanup-toggle" class="toggle-checkbox" disabled>
                    <label for="cleanup-toggle" class="toggle-label">
                        <span class="toggle-button"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="info-box">
            <div class="info-row">
                <span class="info-label">ÂÉπÊ†º</span>
                <span class="info-value" id="price-display">NT$ 3,850</span>
            </div>
            <!-- È´îÁ©çÈáçÈáèË≥áË®äÈö±ËóèÔºå‰ΩÜ‰øùÁïôÂú® DOM ‰∏≠‰æõÂæåÁ´Ø‰ΩøÁî® -->
            <input type="hidden" id="volume-display" value="- mm¬≥">
            <input type="hidden" id="weight-display" value="- g">
        </div>

        <!-- Â≠óÈ´îÈ†êËºâÂÖ•ÈÄ≤Â∫¶ÊèêÁ§∫ -->
        <div id="font-preload-status"
            style="display: none; margin-top: 12px; padding: 12px; background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 12px; font-size: 11px;">
            <div style="display: flex; align-items: center; gap: 8px; color: #d4af37;">
                <div
                    style="width: 12px; height: 12px; border: 2px solid rgba(212, 175, 55, 0.3); border-top-color: #d4af37; border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
                <span id="preload-text">È†êËºâÂÖ•Â≠óÈ´î‰∏≠...</span>
            </div>
            <div style="margin-top: 6px; font-size: 10px; color: rgba(255, 255, 255, 0.5);" id="preload-progress">0 / 0
            </div>
        </div>

        <button class="btn-secondary" id="save-slot-1">Save to Slot 1</button>
        <button class="btn-secondary" id="save-slot-2">Save to Slot 2</button>

        <!-- 3D Ê®°ÂûãÈáçÂª∫ÊèêÁ§∫ -->
        <div id="model-rebuilding-indicator" style="
            display: none;
            margin-top: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(212, 175, 55, 0.15);
            border-radius: 6px;
            font-size: 10px;
            color: rgba(212, 175, 55, 0.6);
            text-align: center;
            font-style: italic;
        ">
            ‚öôÔ∏è Re-constructing 3D model<span class="dots-animation"></span>
        </div>

        <button class="btn-primary" id="addToCartBtn">
            <span style="flex: 1;">Add to Cart</span>
            <div class="view-cart-section" id="viewCartBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="margin-bottom: 2px;">
                    <circle cx="9" cy="21" r="1" />
                    <circle cx="20" cy="21" r="1" />
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                </svg>
                <span style="margin-top: 2px;">View Cart</span>
            </div>
        </button>

        <!-- üß™ Ê∏¨Ë©¶Áî®ÔºöÁõ¥Êé•‰∏ãËºâ STL -->
        <button id="downloadStlBtn" style="
            display: none;
            width: 100%;
            padding: 12px 20px;
            margin-top: 12px;
            background: rgba(212, 175, 55, 0.15);
            border: 1.5px dashed rgba(212, 175, 55, 0.5);
            border-radius: 16px;
            color: #d4af37;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        " onmouseover="this.style.background='rgba(212, 175, 55, 0.25)'" 
           onmouseout="this.style.background='rgba(212, 175, 55, 0.15)'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>üß™ ‰∏ãËºâ STLÔºàÊ∏¨Ë©¶Áî®Ôºâ</span>
        </button>

        <!-- AI Ë´ÆË©¢ÈÄ£Áµê -->
        <div class="ai-consultant-link">
            <a onclick="openDesignConsultant()">
                <span>üíé</span>
                <span>ÈáçÊñ∞ÈñãÂßã AI Ë®≠Ë®àË´ÆË©¢</span>
            </a>
        </div>
    </div>

    <div id="saved-versions">
        <div class="version-slot empty" data-slot="1">
            <div class="version-label">SLOT 1</div>
        </div>
        <div class="version-slot empty" data-slot="2">
            <div class="version-label">SLOT 2</div>
        </div>
    </div>

    <!-- ‰Ω©Êà¥Ê®°Êì¨È†êË¶Ω -->
    <!-- Wearing Preview - Temporarily Disabled -->
    <!-- 
    <div id="wearing-preview-container" class="glass" style="
        position: absolute;
        top: 200px;
        right: 20px;
        width: 332px;
        bottom: 20px;
        z-index: 50;
        border-radius: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
    ">
    </div>
    -->

    <!-- Font Selector Modal -->
    <div id="font-selector-modal">
        <button class="close-modal-btn" id="close-modal">√ó</button>

        <div class="modal-layout">
            <aside class="font-sidebar">
                <div class="char-input-group">
                    <input type="text" id="char-input" maxlength="2" placeholder="type in 2 letters" value="">
                </div>

                <div class="select-all-group">
                    <input type="checkbox" id="select-all-checkbox">
                    <label for="select-all-checkbox">ÂÖ®ÈÅ∏ / ÂÖ®ÈÉ®ÂèñÊ∂à</label>
                </div>

                <div id="font-list-container"></div>
            </aside>

            <section class="font-display-area" id="font-display-area"></section>
        </div>

        <div class="confirm-container">
            <button class="confirm-btn" id="confirm-btn">Confirm Selection</button>
        </div>
    </div>

    <!-- Design Story Card Modal -->
    <div id="design-story-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            width: 560px;
            height: 400px;
            position: relative;
            padding: 60px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        " id="story-card" data-style="classic">
            <!-- Ë®≠Ë®àÁêÜÂøµÂÖßÂÆπ -->
            <div id="story-content" contenteditable="true" style="
                font-family: 'Noto Serif TC', serif;
                font-size: 15px;
                line-height: 1.8;
                letter-spacing: 0.3px;
                flex: 1;
                text-align: justify;
                padding: 0;
                overflow-y: auto;
                max-height: 100%;
                outline: none;
                scrollbar-width: none;
                -ms-overflow-style: none;
            " placeholder="ÊÇ®ÁöÑË®≠Ë®àÁêÜÂøµÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...">
                ÈÄôÊòØ‰∏ÄÂÄãÈóúÊñºÂÖ©ÂÄãÂ≠óÊØçÁöÑÊïÖ‰∫ã...
            </div>

            <!-- Á∞ΩÂêçÊ¨Ñ‰Ωç -->
            <div style="
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 30px;
            ">
                <span style="font-size: 14px; opacity: 0.6;">Ë®≠Ë®àÂ∏´</span>
                <div style="
                    width: 120px;
                    height: 1px;
                    background: currentColor;
                    opacity: 0.3;
                "></div>
            </div>
        </div>

        <!-- Âç°ÁâáÂàáÊèõÊéßÂà∂ÔºàÁßªÂà∞‰∏äÊñπÔºâ -->
        <div style="
            position: absolute;
            bottom: 125px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        ">
            <button id="prev-card-style" style="
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            " onmouseover="this.style.color='rgba(255,255,255,1)'"
                onmouseout="this.style.color='rgba(255,255,255,0.6)'">
                ‚Üê
            </button>
            <span id="card-style-name" style="
                font-size: 13px;
                color: rgba(255, 255, 255, 0.8);
                min-width: 80px;
                text-align: center;
            ">Á∂ìÂÖ∏È¢®Ê†º</span>
            <button id="next-card-style" style="
                background: none;
                border: none;
                color: rgba(255, 255, 255, 0.6);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
            " onmouseover="this.style.color='rgba(255,255,255,1)'"
                onmouseout="this.style.color='rgba(255,255,255,0.6)'">
                ‚Üí
            </button>
        </div>

        <!-- Á∑®ËºØÊèêÁ§∫ÔºàÂú®Âç°ÁâáÂ§ñÔºåÈù†ËøëÂç°ÁâáÔºâ -->
        <div style="
            position: absolute;
            bottom: 195px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            padding: 4px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        ">
            üí° ÈªûÊìäÂç°ÁâáÂÖßÊñáÂ≠óÂèØÁ∑®ËºØ
        </div>

        <!-- Á¢∫ÂÆöÊåâÈàïÔºàÁßªÂà∞ÊúÄ‰∏ãÊñπÔºåÊîπÂ∞èÔºâ -->
        <button id="confirm-story-card" style="
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: rgba(212, 175, 55, 0.9);
            padding: 8px 32px;
            border-radius: 18px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        " onmouseover="this.style.background='rgba(212, 175, 55, 0.25)'; this.style.borderColor='rgba(212, 175, 55, 0.5)'"
            onmouseout="this.style.background='rgba(212, 175, 55, 0.15)'; this.style.borderColor='rgba(212, 175, 55, 0.3)'">
            Á¢∫ÂÆö
        </button>
    </div>

    <!-- Cart Modal -->
    <!-- Checkout Reminder Modal (ÁéªÁíÉÊì¨ÊÖãÁ≤æÁ∑ªÂΩàÁ™ó) -->
    <div id="checkout-reminder-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(15px);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    ">
        <div style="
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 32px;
            padding: 50px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            position: relative;
        ">
            <!-- Ê®ôÈ°å -->
            <div style="text-align: center; margin-bottom: 35px;">
                <div style="font-size: 48px; margin-bottom: 15px;">üíé</div>
                <h2 style="
                    font-size: 28px;
                    font-weight: 600;
                    color: #fff;
                    margin: 0 0 12px 0;
                    letter-spacing: 0.5px;
                ">Âç≥Â∞áÂÆåÊàêÊÇ®ÁöÑÂ∞àÂ±¨‰ΩúÂìÅ</h2>
                <p style="
                    font-size: 15px;
                    color: rgba(255, 255, 255, 0.7);
                    margin: 0;
                ">ÈÇÑÊúâ‰∏ÄÂÄãÁâπÂà•ÁöÑÊ≠•È©üÂú®Á≠âËëóÊÇ®...</p>
            </div>

            <!-- ÂÖßÂÆπ -->
            <div style="
                background: rgba(255, 255, 255, 0.05);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
            ">
                <ul style="
                    list-style: none;
                    padding: 0;
                    margin: 0;
                    color: #fff;
                    line-height: 2;
                ">
                    <li style="margin-bottom: 18px; font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">‚ú®</span>
                        Á≥ªÁµ±Â∞áÁÇ∫ÊÇ®ÁîüÊàêÂ∞àÂ±¨Ë®≠Ë®àÁêÜÂøµ
                    </li>
                    <li style="margin-bottom: 18px; font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">üìù</span>
                        ÊàëÂÄëÊúÉË©¢ÂïèÊÇ®ÂπæÂÄãÈóúÊñºÂ≠óÈ´îÁöÑÂïèÈ°å
                    </li>
                    <li style="font-size: 16px;">
                        <span style="color: #d4af37; margin-right: 12px;">üé®</span>
                        ÊúÄÂæåÂëàÁèæÁ≤æÁæéÁöÑË®≠Ë®àÁêÜÂøµÂç°Áâá
                    </li>
                </ul>
            </div>

            <!-- ÊèêÈÜíÊñáÂ≠ó -->
            <div style="
                text-align: center;
                padding: 20px;
                background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
                border-radius: 16px;
                border: 1px solid rgba(212, 175, 55, 0.3);
                margin-bottom: 35px;
            ">
                <p style="
                    color: #d4af37;
                    font-size: 15px;
                    font-weight: 500;
                    margin: 0;
                    line-height: 1.8;
                ">
                    ‚è≥ Ë´ãÂú®‰ªòÊ¨æÂÆåÊàêÂæåÔºåÁ®çÂÄôÁâáÂàª‰∏çË¶ÅÈóúÈñâË¶ñÁ™ó
                </p>
            </div>

            <!-- ÊåâÈàï -->
            <button id="proceed-to-checkout-btn" style="
                width: 100%;
                padding: 18px;
                background: linear-gradient(135deg, #d4af37, #f4d03f);
                border: none;
                border-radius: 16px;
                color: #000;
                font-size: 17px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(212, 175, 55, 0.5)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(212, 175, 55, 0.4)'">
                ÊàëÁü•ÈÅì‰∫ÜÔºåÂâçÂæÄÁµêÂ∏≥
            </button>
        </div>
    </div>

    <div id="cart-modal">
        <div class="cart-container">
            <div class="cart-header">
                <h2>Shopping Cart</h2>
            </div>
            <div class="cart-items" id="cart-items"></div>

            <div class="cart-footer">
                <!-- ÂÑ™ÊÉ†Á¢ºÂçÄÂ°ä -->
                <div
                    style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: bold; color: #d4af37; font-size: 14px;">
                        üéÅ ÂÑ™ÊÉ†Á¢º
                    </label>
                    <div style="display: flex; align-items: stretch; gap: 10px; width: 100%;">
                        <input type="text" id="promo-code-input" placeholder="Ëº∏ÂÖ•ÂÑ™ÊÉ†Á¢º" maxlength="20" style="flex: 1; 
                                      min-width: 0;
                                      padding: 10px 12px; 
                                      border: 1px solid rgba(255,255,255,0.3); 
                                      background: rgba(255,255,255,0.1); 
                                      color: white; 
                                      border-radius: 5px; 
                                      font-size: 14px; 
                                      text-transform: uppercase;
                                      outline: none;
                                      transition: all 0.3s;">
                        <button id="apply-promo-btn" type="button" onclick="applyPromoCode()" class="glass" style="flex-shrink: 0;
                                       width: 70px;
                                       padding: 10px 12px; 
                                       background: rgba(255, 255, 255, 0.08);
                                       backdrop-filter: blur(10px) saturate(100%);
                                       -webkit-backdrop-filter: blur(10px) saturate(100%);
                                       border: 1px solid rgba(255, 255, 255, 0.2);
                                       box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.2), inset 0 1px 0 0 rgba(255, 255, 255, 0.15);
                                       color: white; 
                                       border-radius: 8px; 
                                       cursor: pointer; 
                                       font-weight: bold; 
                                       font-size: 14px; 
                                       white-space: nowrap; 
                                       transition: all 0.3s;">
                            Â•óÁî®
                        </button>
                    </div>
                    <div id="promo-message" style="margin-top: 8px; font-size: 13px; min-height: 18px;"></div>
                </div>

                <div class="cart-total">
                    <span>Total:</span>
                    <span id="cart-total">NT$ 0</span>
                </div>
                <div class="cart-actions">
                    <button class="btn-secondary" id="continue-shopping">Continue Shopping</button>
                    <button class="btn-primary" id="checkout">Checkout</button>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://esm.sh/three@0.160.0",
            "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
            "three-mesh-bvh": "https://esm.sh/three-mesh-bvh@0.7.3",
            "three-bvh-csg": "https://esm.sh/three-bvh-csg@0.0.16?deps=three@0.160.0,three-mesh-bvh@0.7.3",
            "opentype": "https://esm.sh/opentype.js@1.3.4"
        }
    }
    </script>

    <script type="module">
        // ==========================================
        // üîß ÈñãÁôºËÄÖÂäüËÉΩÂàùÂßãÂåñ
        // ==========================================
        // Ê™¢Êü• URL ÂèÉÊï∏ ?dev=true ÊàñÁ®ãÂºèÁ¢ºË®≠ÂÆö
        DevFeatures.init();
        // DevFeatures.enabled = true;  // ÊàñÁõ¥Êé•Âú®ÈÄôË£°ÂïüÁî®
        
        // ==========================================
        // Three.js Ê®°ÁµÑÂºïÂÖ•
        // ==========================================
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { STLExporter } from 'three/addons/exporters/STLExporter.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { Evaluator, Brush, INTERSECTION } from 'three-bvh-csg';
        import opentype from 'opentype';

        // ‰æõÈùû module ËÖ≥Êú¨Ôºàwearing-preview.jsÔºâ‰ΩøÁî® three.js È°ûÂà•
        // Ôºà‰æãÂ¶Ç Box3 / Vector3 ÊäïÂΩ±Ë®àÁÆóÔºå‰ª•‰æøÊà™ÂèñÂ¢úÈ£æÂçÄÂüüÔºâ
        window.THREE = THREE;

        // ============================================================
        // DUET ÂæåÁ´ØÊï¥Âêà - Ê∑ªÂä†Êñº 2024
        // ============================================================
        // ========== AI Ë´ÆË©¢Êï¥ÂêàÁ®ãÂºèÁ¢º (Êñ∞Â¢û) ==========

        // È°ØÁ§∫ AI Ê≠°ËøéË®äÊÅØ
        function showAIWelcomeMessage() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #d4af37, #f4d03f);
                color: #000;
                padding: 15px 30px;
                border-radius: 50px;
                font-weight: 600;
                z-index: 9999;
                box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            `;
            notification.textContent = '‚ú® AI Â∑≤ÁÇ∫ÊÇ®Ê∫ñÂÇôÂ•ΩÊé®Ëñ¶Â≠óÈ´î';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        // ËºâÂÖ•Êé®Ëñ¶Â≠óÈ´î
        function loadRecommendedFonts(recommendations) {
            const fonts = [
                ...recommendations.letter1.map(r => r.font),
                ...recommendations.letter2.map(r => r.font)
            ];

            const uniqueFonts = [...new Set(fonts)];

            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?${uniqueFonts.map(f => `family=${f.replace(/ /g, '+')}`).join('&')}&display=swap`;
            document.head.appendChild(link);
        }
        // È°ØÁ§∫ AI Êé®Ëñ¶ÊèêÁ§∫ÔºàÂú®Â≠óÈ´îÈÅ∏ÊìáË¶ñÁ™ó‰∏≠Ôºâ
        function showAINotification() {
            // ‚úÖ Â∑≤ÂÅúÁî®Ê≠§ÊèêÁ§∫
            return;
        }
        // È°ØÁ§∫ AI ‰ªãÁ¥π Modal
        function showAIIntroModal() {
            console.log('üîî Ê∫ñÂÇôÈ°ØÁ§∫ AI ‰ªãÁ¥π Modal');
            // Á¢∫‰øùÊ≤íÊúâÁèæÊúâÁöÑ modal
            const existingModal = document.getElementById('ai-intro-modal');
            if (existingModal) {
                existingModal.remove();
            }
            const modal = document.createElement('div');
            modal.id = 'ai-intro-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.75); backdrop-filter: blur(20px); 
                            display: flex; justify-content: center; align-items: center; z-index: 10000;
                            animation: fadeIn 0.5s ease-out;">
                    <div style="background: rgba(26, 26, 26, 0.85);
                                backdrop-filter: blur(10px) saturate(100%);
                                border: 1px solid rgba(212, 175, 55, 0.3); 
                                border-radius: 24px;
                                padding: 45px 55px; 
                                max-width: 580px; 
                                color: #fff;
                                box-shadow: 0 25px 50px rgba(0,0,0,0.5);
                                animation: scaleIn 0.5s ease-out;
                                font-family: 'Cormorant Garamond', serif;">
                        <div style="text-align: center; font-size: 34px; color: #d4af37; 
                                    font-weight: 300; letter-spacing: 8px; margin-bottom: 25px;
                                    font-family: 'Cormorant Garamond', serif;">
                            DUET
                        </div>
                        <h2 style="color: #d4af37; text-align: center; font-size: 24px; 
                                   font-weight: 400; letter-spacing: 2px; margin-bottom: 25px;
                                   font-family: 'Cormorant Garamond', serif;">
                            ÈñãÂïüÊÇ®ÁöÑÂ∞àÂ±¨Ë®≠Ë®àÊóÖÁ®ã
                        </h2>
                        <p style="text-align: center; line-height: 1.9; color: #ccc; 
                                  margin-bottom: 30px; font-size: 15px;">
                            BCAG Ë®ÇË£ΩÁè†ÂØ∂ÁöÑË®≠Ë®àÁ∏ΩÁõ£ÔºåÁÇ∫ DUET Á≥ªÂàóÁöÑ AI Ê†∏ÂøÉ<br>
                            Ê§çÂÖ•‰∫ÜË∂ÖÈÅé 20 Âπ¥Ë®ÇË£ΩÁè†ÂØ∂ÁöÑË´ÆË©¢Á∂ìÈ©ó„ÄÇ
                        </p>
                        <ul style="list-style: none; margin-bottom: 35px;">
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; 
                                       font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">üíé</span>
                                <span>ÈÄèÈÅéÁ∞°ÂñÆÁöÑÂπæÂÄãÂïèÁ≠îÔºåÂºïÂ∞éÊÇ®ÁôºÊéòË®≠Ë®àÁöÑÁç®ÁâπÊÑèÁæ©</span>
                            </li>
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">‚ú®</span>
                                <span>Âú®‰∏äÁôæÊ¨æÂèØÈÅ∏Â≠óÈ´î‰∏≠ÔºåÁÇ∫ÊÇ®Êé®Ëñ¶ÂèØËÉΩÈÅ©ÂêàÊÇ®ÁöÑÂ≠óÈ´î</span>
                            </li>
                            <li style="display: flex; align-items: flex-start; padding: 12px 0; font-size: 14px; color: #ddd; line-height: 1.6;">
                                <span style="font-size: 22px; margin-right: 15px;">üéÅ</span>
                                <span>ÁµêÂ∏≥ÂæåÈÇÑÊúâÂ∞àÂ±¨Â∞èÈ©öÂñú</span>
                            </li>
                        </ul>
                        <button onclick="startAIConsultation()" 
                                style="width: 100%; background: linear-gradient(135deg, #8E795E, #a89276);
                                       color: #fff; border: none; padding: 15px 35px; border-radius: 50px;
                                       font-size: 15px; font-weight: 500; cursor: pointer; margin-bottom: 10px;
                                       transition: 0.3s; letter-spacing: 1px;
                                       font-family: 'Cormorant Garamond', serif;">
                            ÈñãÂßãÊàëÁöÑË®≠Ë®àÊóÖÁ®ã
                        </button>
                        <button onclick="skipAIConsultation()"
                                style="width: 100%; background: transparent; color: #888; border: none;
                                       padding: 10px; font-size: 13px; cursor: pointer;
                                       font-family: 'Cormorant Garamond', serif;">
                            ‰∏çÈúÄË¶ÅÔºåÊàëÊÉ≥Ëá™Â∑±ÈÅ∏ÊìáÂ≠óÊØçËàáÂ≠óÈ´îÔºåÁõ¥Êé•ÈñãÂßã
                        </button>
                    </div>
                </div>
                <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes scaleIn {
                    from { opacity: 0; transform: scale(0.9); }
                    to { opacity: 1; transform: scale(1); }
                }
                </style>
            `;
            document.body.appendChild(modal);
            console.log('‚úÖ AI ‰ªãÁ¥π Modal Â∑≤ÂâµÂª∫‰∏¶Ê∑ªÂä†Âà∞ DOM');
            // Á¢∫‰øù modal Âú®ÊúÄÈ´òÂ±§Á¥ö
            const modalElement = document.getElementById('ai-intro-modal');
            if (modalElement) {
                const overlay = modalElement.querySelector('div');
                if (overlay) {
                    overlay.style.zIndex = '10000';
                }
            }
        }

        window.startAIConsultation = function () {
            window.location.href = 'https://duet.brendonchen.com/ai-consultant';
        }

        window.skipAIConsultation = function () {
            localStorage.setItem('duet_skip_ai', 'true');
            document.getElementById('ai-intro-modal')?.remove();
        }

        window.openDesignConsultant = function () {
            const existingData = localStorage.getItem('duet_ai_consultation');
            if (existingData) {
                if (confirm('ÈáçÊñ∞ÈñãÂßã AI Ë®≠Ë®àË´ÆË©¢ÔºüÈÄôÂ∞áÊ∏ÖÈô§‰πãÂâçÁöÑÊé®Ëñ¶„ÄÇ')) {
                    localStorage.removeItem('duet_ai_consultation');
                    window.location.href = 'https://duet.brendonchen.com/ai-consultant';
                }
            } else {
                window.location.href = 'https://duet.brendonchen.com/ai-consultant';
            }
        }

        // Ê™¢Êü• AI Ë´ÆË©¢Êï∏Êìö
        // ========== ÈÄöÁî®ÈÄöÁü•ÂáΩÊï∏ (Êñ∞Â¢û) ==========
        // ÂæåÁ´Ø URL ÈÖçÁΩÆÔºàÊèêÂâçÂÆöÁæ©Ôºå‰æõ‰ªòÊ¨æÊ™¢Ê∏¨‰ΩøÁî®Ôºâ
        const BACKEND_URL = 'https://duet-backend-wlw8.onrender.com';
        // ÈáçË¶ÅÔºöËÆìÂÖ∂‰ªñÊ™îÊ°àÔºàÂ¶Ç wearing-preview.jsÔºâÂèØËÆÄÂèñ
        window.BACKEND_URL = BACKEND_URL;

        /**
         * È°ØÁ§∫ÈÄöÁü•Ë®äÊÅØ
         * @param {string} message - ÈÄöÁü•Ë®äÊÅØ
         * @param {string} type - ÈÄöÁü•È°ûÂûã: 'success', 'error', 'info'
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');

            // Ê†πÊìöÈ°ûÂûãË®≠ÂÆöÈ°èËâ≤
            const colors = {
                'success': {
                    bg: 'linear-gradient(135deg, #10b981, #059669)',
                    shadow: 'rgba(16, 185, 129, 0.4)'
                },
                'error': {
                    bg: 'linear-gradient(135deg, #ef4444, #dc2626)',
                    shadow: 'rgba(239, 68, 68, 0.4)'
                },
                'info': {
                    bg: 'linear-gradient(135deg, #d4af37, #f4d03f)',
                    shadow: 'rgba(212, 175, 55, 0.4)'
                }
            };

            const color = colors[type] || colors.info;

            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${color.bg};
                color: #fff;
                padding: 16px 32px;
                border-radius: 50px;
                font-weight: 600;
                font-size: 15px;
                z-index: 10000;
                box-shadow: 0 8px 24px ${color.shadow};
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Ê∑°ÂÖ•ÊïàÊûú
            setTimeout(() => notification.style.opacity = '1', 10);

            // 3 ÁßíÂæåÊ∑°Âá∫‰∏¶ÁßªÈô§
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        // ========== ÈÄöÁî®ÈÄöÁü•ÂáΩÊï∏ÁµêÊùü ==========

        // ========== ‰ªòÊ¨æÊàêÂäüÊ™¢Ê∏¨ (Êñ∞Â¢û) ==========
        /**
         * Ê™¢Ê∏¨‰ªòÊ¨æÊàêÂäüÁãÄÊÖãÔºàÂæû URL ÂèÉÊï∏ËÆÄÂèñÔºâ
         * GitHub Pages ‰∏çÊúÉÈÅéÊøæ URL ÂèÉÊï∏ÔºåÂèØ‰ª•ÂÆâÂÖ®‰ΩøÁî®
         */
        function checkPaymentStatusImmediate() {
            console.log('üîç Á´ãÂç≥Ê™¢Ê∏¨‰ªòÊ¨æÁãÄÊÖã...');

            // Âæû URL ÂèÉÊï∏ËÆÄÂèñ
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success') === 'true';
            const paymentFailed = urlParams.get('payment_failed') === 'true';
            const orderId = urlParams.get('order');

            console.log('üîç URL ÂèÉÊï∏Ê™¢Ê∏¨:', {
                paymentSuccess,
                paymentFailed,
                orderId
            });

            // ‰ªòÊ¨æÊàêÂäü
            if (paymentSuccess && orderId) {
                console.log(`‚úÖ Ê™¢Ê∏¨Âà∞‰ªòÊ¨æÊàêÂäü: ${orderId}`);

                // Ê∏ÖÈô§ URL ÂèÉÊï∏ÔºàÈÅøÂÖçÈáçË§áËß∏ÁôºÔºâ
                window.history.replaceState({}, document.title, window.location.pathname);

                // Ë®≠ÂÆöÊ®ôË®òÔºö‰ªòÊ¨æÊàêÂäüÂæåÈÄ≤ÂÖ•Ë®≠Ë®àÁêÜÂøµÊµÅÁ®ã
                window.isPostPayment = true;

                // È°ØÁ§∫‰ªòÊ¨æÊàêÂäüÈÄöÁü•
                showNotification('‰ªòÊ¨æÊàêÂäüÔºÅÊ≠£Âú®ÁÇ∫ÊÇ®Ê∫ñÂÇôË®≠Ë®àË´ÆË©¢...', 'success');

                // Âª∂ÈÅ≤ 1.5 ÁßíÂæåËºâÂÖ•Ë®ÇÂñÆ‰∏¶Ëß∏ÁôºË®≠Ë®àÁêÜÂøµÊî∂ÈõÜÊµÅÁ®ã
                setTimeout(async () => {
                    console.log('üé® Ê∫ñÂÇôË®≠Ë®àÁêÜÂøµÊî∂ÈõÜÊµÅÁ®ã');
                    console.log('üîç Ë®ÇÂñÆID:', orderId);
                    console.log('üîç BACKEND_URL:', BACKEND_URL);
                    console.log('üîç ÂÆåÊï¥ API URL:', `${BACKEND_URL}/api/order/${orderId}`);

                    // ÂÖàÂæûÂæåÁ´ØËºâÂÖ•Ë®ÇÂñÆË≥áÊñôÔºåÊÅ¢Âæ©Ë≥ºÁâ©Ëªä
                    try {
                        const apiUrl = `${BACKEND_URL}/api/order/${orderId}`;
                        console.log('üì° Ê≠£Âú®ÂëºÂè´ API:', apiUrl);

                        const response = await fetch(apiUrl);
                        console.log('üì° Response status:', response.status);
                        console.log('üì° Response ok:', response.ok);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log('üì¶ Êî∂Âà∞Ë≥áÊñô:', data);
                        console.log('üì¶ data.success:', data.success);
                        console.log('üì¶ data.order:', data.order);
                        console.log('üì¶ data.order?.items:', data.order?.items);
                        console.log('üì¶ data.order?.aiConsultation:', data.order?.aiConsultation);

                        if (data.success && data.order && data.order.items) {
                            const order = data.order;
                            
                            // Ê™¢Êü•ÊòØÂê¶Êúâ AI consultation
                            if (!order.aiConsultation) {
                                // Ê≤íÊúâ AI consultationÔºåÈ°ØÁ§∫ÊÑüË¨ùË®äÊÅØÂæåË∑≥ËΩâ
                                showNotification('Ë®ÇÂñÆÂ∑≤Á¢∫Ë™çÔºÅÊÑüË¨ùÊÇ®ÁöÑË®ÇË≥º', 'success');
                                setTimeout(() => {
                                    window.location.href = 'https://www.brendonchen.com';
                                }, 2000);
                                return;
                            }
                            
                            // Êúâ AI consultationÔºåÊÅ¢Âæ©Ë≥ºÁâ©ËªäË≥áÊñô
                            window.cartItems = order.items;
                            window.lastOrderId = orderId;
                            window.aiConsultationData = order.aiConsultation;  // ‚úÖ ÂÑ≤Â≠ò AI Ë´ÆË©¢Ë≥áÊñô

                            console.log('‚úÖ Ë®ÇÂñÆË≥áÊñôÂ∑≤ËºâÂÖ•');
                            console.log('  - ÂïÜÂìÅÊï∏Èáè:', order.items.length);
                            console.log('  - AI Ë´ÆË©¢:', order.aiConsultation ? 'Êúâ' : 'ÁÑ°');

                            // Ëß∏ÁôºË®≠Ë®àÁêÜÂøµÊî∂ÈõÜ
                            if (typeof collectDesignStories === 'function') {
                                collectDesignStories();
                            } else {
                                console.error('‚ùå collectDesignStories ÂáΩÊï∏‰∏çÂ≠òÂú®');
                            }
                        } else {
                            console.error('‚ùå ÁÑ°Ê≥ïËºâÂÖ•Ë®ÇÂñÆË≥áÊñô');
                            console.error('  - success:', data.success);
                            console.error('  - order:', data.order);
                            console.error('  - order?.items:', data.order?.items);
                            console.error('  - error:', data.error);
                            showNotification('ËºâÂÖ•Ë®ÇÂñÆË≥áÊñôÂ§±Êïó: ' + (data.error || 'Ë®ÇÂñÆË≥áÊñô‰∏çÂÆåÊï¥'), 'error');
                        }
                    } catch (error) {
                        console.error('‚ùå ËºâÂÖ•Ë®ÇÂñÆÊôÇÁôºÁîüÈåØË™§:', error);
                        console.error('  - Error name:', error.name);
                        console.error('  - Error message:', error.message);
                        console.error('  - Error stack:', error.stack);
                        showNotification('ËºâÂÖ•Ë®ÇÂñÆË≥áÊñôÂ§±Êïó: ' + error.message, 'error');
                    }
                }, 1500);

                return true;
            }

            // Ê™¢Ê∏¨‰ªòÊ¨æÂ§±Êïó
            if (paymentFailed && orderId) {
                console.log('‚ùå Ê™¢Ê∏¨Âà∞‰ªòÊ¨æÂ§±Êïó');
                showNotification('‰ªòÊ¨æÂ§±ÊïóÔºåË´ãÈáçÊñ∞ÂòóË©¶', 'error');
                return true;
            }

            console.log('‚ÑπÔ∏è Èùû‰ªòÊ¨æÊàêÂäüÈ†ÅÈù¢');
            return false;
        }

        /**
         * Êü•Ë©¢Ë®ÇÂñÆÁãÄÊÖãÔºàÁï∂È©óË≠âÂ§±ÊïóÊôÇ‰ΩøÁî®Ôºâ
         */
        async function queryOrderStatus(orderId) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/order/status/${orderId}`);
                const data = await response.json();

                if (data.success && data.paid) {
                    console.log('‚úÖ ÂæåÁ´ØÁ¢∫Ë™çË®ÇÂñÆÂ∑≤‰ªòÊ¨æ');
                    showNotification('‰ªòÊ¨æÊàêÂäüÔºÅÊ≠£Âú®ÁÇ∫ÊÇ®Ê∫ñÂÇôË®≠Ë®àË´ÆË©¢...', 'success');
                    setTimeout(() => {
                        if (typeof showAIIntroModal === 'function') {
                            showAIIntroModal();
                        }
                    }, 1500);
                } else {
                    console.log('‚ö†Ô∏è Ë®ÇÂñÆÂ∞öÊú™ÂÆåÊàê‰ªòÊ¨æ');
                    showNotification('Ë®ÇÂñÆËôïÁêÜ‰∏≠ÔºåË´ãÁ®çÂÄô...', 'info');
                }
            } catch (error) {
                console.error('‚ùå Êü•Ë©¢Ë®ÇÂñÆÁãÄÊÖãÂ§±Êïó:', error);
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÁ´ãÂç≥Ê™¢Ê∏¨‰ªòÊ¨æÁãÄÊÖã
        checkPaymentStatusImmediate();
        // ========== ‰ªòÊ¨æÊàêÂäüÊ™¢Ê∏¨ÁµêÊùü ==========

        window.addEventListener('DOMContentLoaded', function () {
            // Â¶ÇÊûúÊòØ‰ªòÊ¨æÊàêÂäüÂæåÔºå‰∏çÂü∑Ë°åÈÄôÊÆµÔºàÊúÉÁî± collectDesignStories Êé•ÊâãÔºâ
            if (window.isPostPayment) {
                console.log('‚ÑπÔ∏è ‰ªòÊ¨æÊàêÂäüÊµÅÁ®ãÔºåË∑≥ÈÅé AI Êé®Ëñ¶ËºâÂÖ•');
                return;
            }

            const aiDataStr = localStorage.getItem('duet_ai_consultation');

            if (aiDataStr) {
                const aiData = JSON.parse(aiDataStr);
                window.hasAIRecommendation = true;
                window.aiRecommendation = aiData.recommendedFonts;
                window.aiConversation = aiData.conversationHistory;
                window.aiLetters = aiData.selectedLetters;

                console.log('‚úÖ ËºâÂÖ• AI Êé®Ëñ¶Ë≥áÊñô:', aiData);

                // Ëá™ÂãïÂ°´ÂÖ•Â≠óÊØç
                setTimeout(() => {
                    const letter1Select = document.getElementById('letter1');
                    const letter2Select = document.getElementById('letter2');

                    if (aiData.selectedLetters) {
                        letter1Select.value = aiData.selectedLetters.letter1;
                        letter2Select.value = aiData.selectedLetters.letter2;
                        console.log('‚úÖ Â∑≤Â°´ÂÖ•Â≠óÊØç:', aiData.selectedLetters);
                    }

                    // Ëá™ÂãïÂãæÈÅ∏Êé®Ëñ¶Â≠óÈ´î
                    if (aiData.recommendedFonts) {
                        const allFonts = [
                            ...aiData.recommendedFonts.letter1,
                            ...aiData.recommendedFonts.letter2
                        ];

                        // ÂéªÈáç
                        const uniqueFonts = [...new Set(allFonts)];
                        console.log('‚úÖ Êé®Ëñ¶Â≠óÈ´î:', uniqueFonts);

                        // Ëá™ÂãïÂãæÈÅ∏ÈÄô‰∫õÂ≠óÈ´î
                        uniqueFonts.forEach(font => {
                            checkedFonts.add(font);
                        });

                        // Ëá™ÂãïÊâìÈñãÂ≠óÈ´îÈÅ∏ÊìáË¶ñÁ™ó
                        openFontSelector();

                        // Êõ¥Êñ∞Â≠óÈ´îÈÅ∏ÊìáË¶ñÁ™óÁöÑÂãæÈÅ∏ÁãÄÊÖã
                        setTimeout(() => {
                            updateFontDisplay();

                            // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
                            showAINotification();
                        }, 500);
                    }
                }, 1000);
            }

            const skipAI = localStorage.getItem('duet_skip_ai');
            if (!skipAI && !aiDataStr) {
                // Á≠âÂæÖ‰∏ªÁï´Èù¢ÂÆåÂÖ®ËºâÂÖ•ÔºàÂåÖÊã¨ 3D ÁêÉÈ´îÔºâÂæå 2 ÁßíÊâçÈ°ØÁ§∫
                function showAIAfterDelay() {
                    setTimeout(() => {
                        console.log('üîî 2 ÁßíÂª∂ÈÅ≤ÁµêÊùüÔºåÈ°ØÁ§∫ AI ‰ªãÁ¥π');
                        showAIIntroModal();
                    }, 2000);
                }

                // Ê™¢Êü•È†ÅÈù¢ÊòØÂê¶Â∑≤Á∂ìËºâÂÖ•ÂÆåÊàê
                if (document.readyState === 'complete') {
                    console.log('üîî È†ÅÈù¢Â∑≤ËºâÂÖ•ÂÆåÊàêÔºå2 ÁßíÂæåÈ°ØÁ§∫ AI ‰ªãÁ¥π');
                    showAIAfterDelay();
                } else {
                    window.addEventListener('load', () => {
                        console.log('üîî È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÔºå2 ÁßíÂæåÈ°ØÁ§∫ AI ‰ªãÁ¥π');
                        showAIAfterDelay();
                    });
                }
            }
        });
        // ========== AI Ë´ÆË©¢Êï¥ÂêàÁ®ãÂºèÁ¢ºÁµêÊùü ==========

        // === ÂæåÁ´Ø API Ë®≠ÂÆö ===
        // ===== ÈÖçÁΩÆÂçÄÂ°ä =====
        const TESTING_MODE = false;  // ‚ö†Ô∏è Ê∏¨Ë©¶Ê®°ÂºèÈóúÈñâÔºå‰ΩøÁî®ÁúüÂØ¶ÈáëÊµÅÔºàÁ∂†ÁïåÊ∏¨Ë©¶Á´ôÔºâ
        // BACKEND_URL Â∑≤Âú®ÂâçÈù¢ÂÆöÁæ©Ôºà‰æõ‰ªòÊ¨æÊ™¢Ê∏¨‰ΩøÁî®Ôºâ

        console.log('üîß Áï∂ÂâçÈÖçÁΩÆ:', {
            Ê∏¨Ë©¶Ê®°Âºè: TESTING_MODE ? '‚úÖ ÂïüÁî®' : '‚ùå ÈóúÈñâ',
            ÂæåÁ´ØURL: BACKEND_URL
        });

        console.log('üîß ÂæåÁ´Ø URL:', BACKEND_URL);

        // === Ê∏¨Ë©¶ÂæåÁ´ØÈÄ£Êé• ===
        async function testBackendConnection() {
            try {
                console.log('üîç Ê∏¨Ë©¶ÂæåÁ´ØÈÄ£Êé•...');
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ ÂæåÁ´ØÈÄ£Êé•ÊàêÂäü:', data);

                // È°ØÁ§∫ÊàêÂäüË®äÊÅØÔºàÈÅ∏Áî®Ôºâ
                if (data.engine === 'OpenSCAD') {
                    console.log('‚úÖ OpenSCAD ÂºïÊìéÂ∑≤Â∞±Á∑í');
                }

                return true;
            } catch (error) {
                console.error('‚ùå ÂæåÁ´ØÈÄ£Êé•Â§±Êïó:', error);
                console.error('Ë´ãÁ¢∫Ë™çÔºö');
                console.error('1. Á∂≤Ë∑ØÈÄ£Á∑öÊòØÂê¶Ê≠£Â∏∏');
                console.error('2. ÂæåÁ´Ø URL ÊòØÂê¶Ê≠£Á¢∫:', BACKEND_URL);
                return false;
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïÊ∏¨Ë©¶
        window.addEventListener('load', async () => {
            console.log('üì± È†ÅÈù¢Â∑≤ËºâÂÖ•ÔºåÂàùÂßãÂåñ...');

            // ÂÖàÂàùÂßãÂåñÂèØÁî®Â≠óÈ´îÊ∏ÖÂñÆ
            await initAvailableFonts();

            // ÁÑ∂ÂæåÊ∏¨Ë©¶ÂæåÁ´ØÈÄ£Êé•
            testBackendConnection();
        });

        // ============================================================
        // ‰ª•‰∏ãÊòØÂéüÂßãÁ®ãÂºèÁ¢º
        // ============================================================

        // ============================================================
        // ÂÖ®ÂüüÈÖçÁΩÆ
        // ============================================================
        
        // üéõÔ∏è Debug Ê®°ÂºèÔºàfalse = ÈóúÈñâÊâÄÊúâ Debug Ë®äÊÅØ‰ª•ÊèêÂçáÊÄßËÉΩÔºâ
        const DEBUG_MODE = false;
        
        // Debug ËºîÂä©ÂáΩÊï∏
        const debug = (...args) => { if (DEBUG_MODE) console.log(...args); };
        const debugWarn = (...args) => { if (DEBUG_MODE) console.warn(...args); };
        
        // ÂÖ®ÂüüËÆäÊï∏
        let scene, camera, renderer, controls, envMap;
        let mainMesh = null, bailMesh = null;
        let loadedFonts = {};
        let checkedFonts = new Set();
        let isReselect = false;  // Ê®ôË®òÊòØÂê¶ÁÇ∫ÈáçÊñ∞ÈÅ∏ÊìáÂ≠óÈ´î
        let cartItems = [];
        let savedVersions = [null, null];
        let slot1Scene, slot2Scene, slot1Renderer, slot2Renderer, slot1Camera, slot2Camera;
        let modelTopZ = 0;
        let modelCenter = new THREE.Vector3();

        // ÂÑ™ÊÉ†Á¢ºÁõ∏ÈóúËÆäÊï∏
        let appliedPromoCode = '';
        let promoDiscount = 0;
        let originalTotal = 0;

        // 120 Á®ÆÂ≠óÈ´îÊ∏ÖÂñÆÔºà‰æÜËá™ font-selector.htmÔºâ
        // ÂèØÁî®Â≠óÈ´îÊ∏ÖÂñÆÔºàÂæûÂ§ñÈÉ® JSON ËºâÂÖ•Ôºâ
        let availableFonts = [];

        // ÂæûÂ§ñÈÉ® JSON Ê™îÊ°àËºâÂÖ•Â≠óÈ´îÂ∫´
        async function loadFontsFromJSON() {
            try {
                const response = await fetch('fonts.json');
                const data = await response.json();
                return data.fonts || [];
            } catch (error) {
                console.error('‚ùå ËºâÂÖ•Â≠óÈ´îÂ∫´Â§±ÊïóÔºå‰ΩøÁî®ÂÖßÂª∫ÂàóË°®:', error);
                // Fallback: ‰ΩøÁî®ÂÖßÂª∫Â≠óÈ´îÂàóË°®
                return [
                    "Abel", "Abril Fatface", "Advent Pro", "Alegreya", "Alex Brush",
                    "Alfa Slab One", "Alice", "Allura", "Amatic SC", "Amiri",
                    "Anton", "Arapey", "Archivo", "Armata", "Artifika",
                    "Arvo", "Audiowide", "Average", "Baloo 2", "Bangers",
                    "Bebas Neue", "Belgrano", "Bentham", "Bitter", "Bree Serif",
                    "Bubblegum Sans", "Bungee", "Cabin", "Cantata One", "Caudex",
                    "Caveat", "Chivo", "Cinzel", "Comfortaa", "Commissioner",
                    "Cookie", "Copse", "Cormorant Garamond", "Courier Prime", "Coustard",
                    "Creepster", "Cutive Mono", "DM Serif Text", "Dancing Script", "Dosis",
                    "EB Garamond", "Eczar", "Encode Sans", "Fauna One", "Fira Code",
                    "Fira Sans", "Fjalla One", "Fugaz One", "Gelasio", "Gloria Hallelujah",
                    "Great Vibes", "Handlee", "Hind", "Holtwood One SC", "Inconsolata",
                    "Indie Flower", "Jost", "Kalam", "Kanit", "Karla",
                    "Lexend", "Lobster", "Merriweather", "Neuton", "Nunito",
                    "Old Standard TT", "Orbitron", "Oswald", "Outfit", "Pacifico",
                    "Passion One", "Pathway Gothic One", "Patrick Hand", "Paytone One", "Playfair Display",
                    "Poppins", "Prata", "Quicksand", "Righteous", "Rubik",
                    "Russo One", "Sacramento", "Secular One", "Shadows Into Light", "Share Tech Mono",
                    "Shrikhand", "Sniglet", "Space Grotesk", "Space Mono", "Spectral",
                    "Tangerine", "Titan One", "Varela Round", "Vollkorn", "Zilla Slab"
                ];
            }
        }

        // Â≠óÈ´îËºâÂÖ•ÂÆåÊàêÁöÑ PromiseÔºà‰æõÂÖ∂‰ªñÂú∞Êñπ awaitÔºâ
        let fontsLoadedResolve;
        const fontsLoadedPromise = new Promise(resolve => { fontsLoadedResolve = resolve; });

        // ÂàùÂßãÂåñÔºöËºâÂÖ•Â≠óÈ´îÂ∫´Ôºàfonts.jsonÔºâÔºå‰∏¶Âú®ËºâÂÖ•ÂÆåÊàêÂæåËß∏Áôº Google Fonts È†êËºâ
        (async function initializeFonts() {
            const loaded = await loadFontsFromJSON();
            console.log(`‚úÖ Â≠óÈ´îÂ∫´Â∑≤ËºâÂÖ•Ôºö${loaded.length} Á®ÆÂ≠óÈ´î`);
            availableFonts = loaded;
            if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            // ÈÄöÁü•ÂÖ∂‰ªñÁ≠âÂæÖÂ≠óÈ´îËºâÂÖ•ÁöÑÂú∞Êñπ
            if (fontsLoadedResolve) fontsLoadedResolve();
        })();

        // ÂàùÂßãÂåñÂèØÁî®Â≠óÈ´îÊ∏ÖÂñÆÔºö‰∏ÄÂæãÂæû fonts.json ËºâÂÖ•ÔºàÊñπ‰æøÂæåÁ∫åËÆäÊõ¥Â≠óÈ´îÊ∏ÖÂñÆÔºâ
        async function initAvailableFonts() {
            try {
                console.log('üîç Âæû fonts.json ËºâÂÖ•Â≠óÈ´îÊ∏ÖÂñÆ...');
                availableFonts = await loadFontsFromJSON();
                console.log(`‚úÖ ÂÖ±Êúâ ${availableFonts.length} Á®ÆÂ≠óÈ´îÂèØÁî®`);
                if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            } catch (error) {
                console.error('‚ùå ËºâÂÖ• fonts.json Â§±Êïó:', error);
                availableFonts = await loadFontsFromJSON().catch(() => []);
                if (typeof loadGoogleFonts === 'function') loadGoogleFonts();
            }
        }

        // ÊùêË≥™Ë®≠ÂÆö
        const MATERIALS = {
            gold18k: { color: 0xFFD700, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.3 },
            whitegold18k: { color: 0xE5E5E5, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.3 },
            rosegold18k: { color: 0xECC5B0, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 15.0 },
            silver925: { color: 0xC0C0C0, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 10.3 },
            brass: { color: 0xB5A642, metalness: 0.9, roughness: { glossy: 0.0, matte: 0.6 }, density: 8.5 },
            platinum: { color: 0xE5E5E5, metalness: 1.0, roughness: { glossy: 0.0, matte: 0.6 }, density: 21.4 }
        };

        // üßπ Á¢éÁâáÊ∏ÖÁêÜÁõ∏ÈóúËÆäÊï∏
        let modelNeedsCleanup = false;  // Ê®ôË®òÔºöË®ÇÂñÆÊòØÂê¶ÈúÄË¶ÅÊ∏ÖÁêÜÁ¢éÁâá
        let isCleanupInProgress = false; // Èò≤Ê≠¢ÈáçË§áÈªûÊìä


        // ÈõªÈççÈ°èËâ≤ÂÆöÁæ©
        const PLATING_COLORS = {
            none: null,  // ÁÑ°ÈõªÈççÔºå‰ΩøÁî®Âü∫Á§éÊùêË≥™È°èËâ≤
            gold18k: 0xFFD700,      // 18K ÈáëËâ≤
            whitegold18k: 0xE5E5E5, // 18K ÁôΩKÈáëËâ≤
            rosegold18k: 0xECC5B0   // 18K Áé´Áë∞ÈáëËâ≤
        };

        // ÂàùÂßãÂåñÂ†¥ÊôØÔºàZ-up Á≥ªÁµ±Ôºâ
        function initScene() {
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.up.set(0, 0, 1); // Z-up Á≥ªÁµ±
            // ÂæûÁâ©‰ª∂ÂâçÊñπÁ®çÂæÆÂÅèÂè≥‰∏äÔºå15Â∫¶‰øØËßíËßÄÁúã 45 Â∫¶Â§æËßí
            camera.position.set(60, -85, 18);  // ÊãâÈÅ†Èè°È†≠ÔºàÂéü: 50, -70, 15Ôºâ
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.getElementById('viewport').appendChild(renderer.domElement);
            // Êö¥Èú≤ renderer, scene, camera Áµ¶ÂÖ®Â±ÄÔºå‰æõ‰Ω©Êà¥Ê®°Êì¨‰ΩøÁî®
            window.renderer = renderer;
            window.scene = scene;
            window.camera = camera;

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);

            // ‚ö° ÂÑ™ÂåñÔºöÊèêÂçáÂÖâÁÖß‰∫ÆÂ∫¶ 20%
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);  // 1.25 ‚Üí 1.5 (+20%)
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.8);  // 1.5 ‚Üí 1.8 (+20%)
            directionalLight.position.set(5, 5, 10);
            scene.add(directionalLight);

            // ‚úÖ HDR ËºâÂÖ•ÂÇôÊè¥Ê©üÂà∂
            const hdrUrls = [
                'https://cdn.jsdelivr.net/gh/brendon-create/duet-frontend@main/assets/images/hdr/Jewelry_studio_c.hdr',  // ÂÑ™ÂÖàÔºöjsdelivr CDN
                'https://raw.githubusercontent.com/brendon-create/duet-frontend/main/assets/images/hdr/Jewelry_studio_c.hdr'  // ÂÇôÊè¥ÔºöGitHub Raw
            ];
            
            let currentHdrIndex = 0;
            let hdrLoadTimeout = null;
            const rgbeLoader = new RGBELoader();

            function loadHDRWithFallback() {
                if (currentHdrIndex >= hdrUrls.length) {
                    console.error('‚ùå ÊâÄÊúâ HDR ‰æÜÊ∫êÈÉΩÂ§±ÊïóÔºå‰ΩøÁî®ÁÑ° HDR Ê®°Âºè');
                    envMap = null;
                    showInitialSphere();
                    return;
                }

                const hdrUrl = hdrUrls[currentHdrIndex];
                const sourceName = currentHdrIndex === 0 ? 'jsdelivr CDN' : 'GitHub Raw';
                console.log(`üîÑ ÂòóË©¶ËºâÂÖ• HDR (${sourceName}):`, hdrUrl);

                // Ë®≠ÂÆö 5 ÁßíË∂ÖÊôÇ
                hdrLoadTimeout = setTimeout(() => {
                    console.warn(`‚è±Ô∏è HDR ËºâÂÖ•Ë∂ÖÊôÇ (${sourceName})ÔºåÂàáÊèõÂÇôÊè¥...`);
                    currentHdrIndex++;
                    loadHDRWithFallback();
                }, 5000);

                rgbeLoader.load(
                    hdrUrl,
                    (texture) => {
                        clearTimeout(hdrLoadTimeout);
                        texture.mapping = THREE.EquirectangularReflectionMapping;
                        envMap = texture;
                        scene.environment = envMap;
                        console.log(`‚úÖ HDR ËºâÂÖ•ÊàêÂäü (${sourceName})`);
                        showInitialSphere();
                    },
                    undefined,
                    (error) => {
                        clearTimeout(hdrLoadTimeout);
                        console.error(`‚ùå HDR ËºâÂÖ•Â§±Êïó (${sourceName}):`, error);
                        currentHdrIndex++;
                        loadHDRWithFallback();
                    }
                );
            }

            loadHDRWithFallback();

            window.addEventListener('resize', onResize);
            
            // ==========================================
            // üîß ÂàùÂßãÂåñÁî¢ÂìÅÊîùÂΩ±Ê®°ÁµÑ
            // ==========================================
            ProductPhotoStudio.init(scene, camera, renderer, controls);
        }

        function showInitialSphere() {
            const geometry = new THREE.SphereGeometry(7.5, 64, 64);
            const material = getMaterial('silver925', 'glossy', 'none');  // È†êË®≠Ôºö925ÈäÄÔºå‰∫ÆÈù¢ÔºåÁÑ°ÈõªÈçç
            mainMesh = new THREE.Mesh(geometry, material);
            scene.add(mainMesh);
            // Êö¥Èú≤ mainMesh Áµ¶ÂÖ®Â±ÄÔºå‰æõ‰Ω©Êà¥Ê®°Êì¨‰ΩøÁî®
            window.mainMesh = mainMesh;
            document.getElementById('loader').style.display = 'none';
        }

        function getMaterial(materialType, finish, plating = 'none') {
            const mat = MATERIALS[materialType];
            const roughness = mat.roughness[finish];

            // Ê±∫ÂÆöÊúÄÁµÇÈ°èËâ≤ÔºöÂ¶ÇÊûúÊúâÈõªÈççÔºå‰ΩøÁî®ÈõªÈççÈ°èËâ≤ÔºõÂê¶Ââá‰ΩøÁî®Âü∫Á§éÊùêË≥™È°èËâ≤
            const finalColor = PLATING_COLORS[plating] !== null
                ? PLATING_COLORS[plating]
                : mat.color;

            const materialConfig = {
                color: finalColor,
                metalness: mat.metalness,
                roughness: roughness,
                envMapIntensity: finish === 'glossy' ? 2.0 : 1.0
            };

            // Âè™Âú® envMap Â≠òÂú®ÊôÇÊâçÂä†ÂÖ•ÔºàÈò≤Ê≠¢ÈªëËâ≤ÁêÉÈ´îÔºâ
            if (envMap) {
                materialConfig.envMap = envMap;
            }

            return new THREE.MeshStandardMaterial(materialConfig);
        }

        // 3D Âª∫Ê®°ÔºàZ-up Á≥ªÁµ±ÔºöXY Ê∞¥Âπ≥Èù¢ÔºåZ Ëª∏Âêë‰∏äÔºâ
        async function generateModel() {
            // È°ØÁ§∫ÈáçÂª∫ÊèêÁ§∫
            let indicator = document.getElementById('model-rebuilding-indicator');
            if (indicator) indicator.style.display = 'block';

            const l1 = document.getElementById('letter1').value;
            const l2 = document.getElementById('letter2').value;

            // Ê™¢Êü•Â≠óÈ´îÊåâÈàïÊàñ‰∏ãÊãâÈÅ∏ÂñÆÊòØÂê¶ÊúâÈÅ∏ÊìáÁöÑÂ≠óÈ´î
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Btn = document.getElementById('font1-btn');
            const font2Btn = document.getElementById('font2-btn');

            const f1Name = font1Select ? font1Select.value : font1Btn.getAttribute('data-selected');
            const f2Name = font2Select ? font2Select.value : font2Btn.getAttribute('data-selected');

            console.log('generateModel called:', { l1, l2, f1Name, f2Name }); // Debug ‚Üí ‰øùÁïôÈÄôÂÄãÔºàÈóúÈçµË≥áË®äÔºâ

            if (!l1 || !l2 || !f1Name || !f2Name || f1Name === 'reselect' || f2Name === 'reselect') {
                debug('Missing parameters, showing sphere');
                if (!mainMesh || mainMesh.geometry.type !== 'SphereGeometry') {
                    showInitialSphere();
                }
                // Èö±ËóèÈáçÂª∫ÊèêÁ§∫
                if (indicator) indicator.style.display = 'none';
                return;
            }

            const targetHeight = parseInt(document.getElementById('size').value);

            // Êö´Â≠òËàäÁâ©‰ª∂ÔºåÁ≠âÊñ∞Áâ©‰ª∂ÂâµÂª∫ÂÆåÊàêÂæåÂÜçÁßªÈô§ÔºàÈÅøÂÖçÁï´Èù¢Á©∫ÁôΩÔºâ
            const oldMainMesh = mainMesh;
            const oldBailMesh = bailMesh;

            debug('Loading fonts...');
            // ËºâÂÖ•Â≠óÈ´î
            const f1 = await loadFont(f1Name);
            const f2 = await loadFont(f2Name);
            debug('Fonts loaded, generating geometry...');

            const evaluator = new Evaluator();
            const baseMat = new THREE.MeshStandardMaterial();

            // ‚úÖ ‰øÆÂæ©Êà™Êñ∑ÂïèÈ°åÔºöÂ¢ûÂ§ß depth ‰øÇÊï∏
            // ÂéüÂõ†Ôºöscale() ÊúÉÁ∏ÆÂ∞èÊâÄÊúâÊñπÂêëÔºåÂåÖÊã¨Ê∑±Â∫¶
            // ÂæåÁ´ØÁî® resize() Âè™Á∏ÆÊîæ XYÔºå‰øùÊåÅÂéüÂßãÊ∑±Â∫¶
            // ÂâçÁ´ØÈúÄË¶ÅÊõ¥Â§ßÁöÑ‰øÇÊï∏‰æÜË£úÂÑüÁ∏ÆÊîæ
            const depth = targetHeight * 18.0;  // üéõÔ∏è ÂÑ™ÂåñÔºöÂæû 20.0 ‚Üí 18.0ÔºàÊ∏õÂ∞ëÈ†ÇÈªûÊï∏Ôºâ
            const params = {
                font: null,
                size: 50,
                height: depth,
                curveSegments: 28,  // üéõÔ∏è ÂÑ™ÂåñÔºöÂæû 32 ‚Üí 28ÔºàÊ∏õÂ∞ë 12% Èù¢Êï∏ÔºåË¶ñË¶∫Â∑ÆÁï∞‰∏çÊòéÈ°ØÔºâ
                bevelEnabled: false,  // üîß ÈóúÈñâ bevel ‰ª•Á¢∫‰øùÂâçÂæåÁ´Ø‰∏ÄËá¥
                bevelThickness: 2.0,
                bevelSize: 0.8,
                bevelSegments: 16
            };

            // === Â≠óÊØç 1 (Ê≠£Èù¢)ÔºöÂ∞áÂ≠óÊØçÂπ≥Èù¢Âæû XY ËΩâÂà∞ XZÔºåÊì†Âá∫ÊñπÂêëÂæû Z ËΩâÂà∞ Y ===
            const geo1 = new TextGeometry(l1, { ...params, font: f1 });
            geo1.computeBoundingBox();
            const bbox1 = geo1.boundingBox;
            const actualHeight1 = bbox1.max.y - bbox1.min.y;
            const actualWidth1 = bbox1.max.x - bbox1.min.x;

            // üîç Debug: ÂéüÂßãÂ∞∫ÂØ∏Ôºàscale ‰πãÂâçÔºâ
            debug('Letter 1 ÂéüÂßã bbox:', bbox1);

            const scale1 = targetHeight / actualHeight1;
            debug('Letter 1 scale:', scale1);

            geo1.scale(scale1, scale1, scale1);
            geo1.center();

            // ‰øùÂ≠ò Letter 1 ÁöÑ BBox ‰ø°ÊÅØÔºàcenter ‰πãÂæåÔºårotate ‰πãÂâçÔºâ
            geo1.computeBoundingBox();
            const bbox1AfterScale = geo1.boundingBox;
            window.letter1BBox = {
                width: bbox1AfterScale.max.x - bbox1AfterScale.min.x,
                height: bbox1AfterScale.max.y - bbox1AfterScale.min.y,
                depth: bbox1AfterScale.max.z - bbox1AfterScale.min.z,
                offsetX: (bbox1AfterScale.max.x + bbox1AfterScale.min.x) / 2,
                offsetY: (bbox1AfterScale.max.y + bbox1AfterScale.min.y) / 2,
                offsetZ: (bbox1AfterScale.max.z + bbox1AfterScale.min.z) / 2
            };

            // === ‰ΩøÁî®ÂÖ®ÂüüËª∏ÊóãËΩâÔºàÊõ¥Ê∏ÖÊô∞„ÄÅÊòìÁ∂≠Ë≠∑Ôºâ===
            // Letter 1: XZ Âπ≥Èù¢ÔºåÊ≤ø Y Ëª∏ extrude
            // Geometry Ê≤íÊúâ rotateOnWorldAxisÔºåÈúÄË¶ÅÁî®ÊóãËΩâÁü©Èô£
            const rotationMatrix1 = new THREE.Matrix4();
            rotationMatrix1.makeRotationX(Math.PI / 2);
            geo1.applyMatrix4(rotationMatrix1);

            const brush1 = new Brush(geo1, baseMat);
            brush1.updateMatrixWorld();

            // === Â≠óÊØç 2 (ÂÅ¥Èù¢)ÔºöYZ Âπ≥Èù¢ÔºåÊ≤ø X Ëª∏ extrude ===
            const geo2 = new TextGeometry(l2, { ...params, font: f2 });
            geo2.computeBoundingBox();
            const bbox2 = geo2.boundingBox;
            const actualHeight2 = bbox2.max.y - bbox2.min.y;
            const actualWidth2 = bbox2.max.x - bbox2.min.x;

            // üîç Debug: ÂéüÂßãÂ∞∫ÂØ∏Ôºàscale ‰πãÂâçÔºâ
            debug('Letter 2 ÂéüÂßã bbox:', bbox2);

            const scale2 = targetHeight / actualHeight2;
            debug('Letter 2 scale:', scale2);

            geo2.scale(scale2, scale2, scale2);
            geo2.center();

            // ‰øùÂ≠ò Letter 2 ÁöÑ BBox ‰ø°ÊÅØÔºàcenter ‰πãÂæåÔºårotate ‰πãÂâçÔºâ
            geo2.computeBoundingBox();
            const bbox2AfterScale = geo2.boundingBox;
            window.letter2BBox = {
                width: bbox2AfterScale.max.x - bbox2AfterScale.min.x,
                height: bbox2AfterScale.max.y - bbox2AfterScale.min.y,
                depth: bbox2AfterScale.max.z - bbox2AfterScale.min.z,
                offsetX: (bbox2AfterScale.max.x + bbox2AfterScale.min.x) / 2,
                offsetY: (bbox2AfterScale.max.y + bbox2AfterScale.min.y) / 2,
                offsetZ: (bbox2AfterScale.max.z + bbox2AfterScale.min.z) / 2
            };

            // === ‰ΩøÁî®ÂÖ®ÂüüËª∏ÊóãËΩâÔºàÊõ¥Ê∏ÖÊô∞„ÄÅÊòìÁ∂≠Ë≠∑Ôºâ===
            // Letter 2: ÂÖàÁπû X Ëª∏ËΩâ 90 Â∫¶ÔºåÂÜçÁπû Z Ëª∏ËΩâ 90 Â∫¶
            const rotationMatrix2X = new THREE.Matrix4();
            rotationMatrix2X.makeRotationX(Math.PI / 2);
            geo2.applyMatrix4(rotationMatrix2X);

            const rotationMatrix2Z = new THREE.Matrix4();
            rotationMatrix2Z.makeRotationZ(Math.PI / 2);
            geo2.applyMatrix4(rotationMatrix2Z);

            const brush2 = new Brush(geo2, baseMat);
            brush2.updateMatrixWorld();

            debug('Calculating intersection...'); // Debug

            // üîç Debug: CSG ÂâçÊ™¢Êü•ÂÖ©ÂÄã Brush ÁöÑÂØ¶ÈöõÁØÑÂúç
            brush1.geometry.computeBoundingBox();
            brush2.geometry.computeBoundingBox();
            debug('üîç Brush1 (Letter1) BBox:', {
                min: brush1.geometry.boundingBox.min,
                max: brush1.geometry.boundingBox.max,
                size: {
                    x: (brush1.geometry.boundingBox.max.x - brush1.geometry.boundingBox.min.x).toFixed(2),
                    y: (brush1.geometry.boundingBox.max.y - brush1.geometry.boundingBox.min.y).toFixed(2),
                    z: (brush1.geometry.boundingBox.max.z - brush1.geometry.boundingBox.min.z).toFixed(2)
                }
            });
            debug('üîç Brush2 (Letter2) BBox:', {
                min: brush2.geometry.boundingBox.min,
                max: brush2.geometry.boundingBox.max,
                size: {
                    x: (brush2.geometry.boundingBox.max.x - brush2.geometry.boundingBox.min.x).toFixed(2),
                    y: (brush2.geometry.boundingBox.max.y - brush2.geometry.boundingBox.min.y).toFixed(2),
                    z: (brush2.geometry.boundingBox.max.z - brush2.geometry.boundingBox.min.z).toFixed(2)
                }
            });

            // Â∏ÉÊûó‰∫§ÈõÜÈÅãÁÆó
            let result = evaluator.evaluate(brush1, brush2, INTERSECTION);

            // üîç Debug: CSG ÂæåÊ™¢Êü•ÁµêÊûú
            result.geometry.computeBoundingBox();
            debug('üîç CSG Result BBox:', {
                min: result.geometry.boundingBox.min,
                max: result.geometry.boundingBox.max,
                size: {
                    x: (result.geometry.boundingBox.max.x - result.geometry.boundingBox.min.x).toFixed(2),
                    y: (result.geometry.boundingBox.max.y - result.geometry.boundingBox.min.y).toFixed(2),
                    z: (result.geometry.boundingBox.max.z - result.geometry.boundingBox.min.z).toFixed(2)
                }
            });

            if (result.geometry.attributes.position.count === 0) {
                debugWarn('‰∫§ÈõÜÁÇ∫Á©∫');
                return;
            }

            debug('Fixing geometry...'); // Debug
            // === ‰øÆÂæ©Âπæ‰ΩïÈ´î ===
            result.geometry = result.geometry.toNonIndexed();
            result.geometry.deleteAttribute('normal');
            result.geometry.computeVertexNormals();

            const offset = 0.001;
            const positions = result.geometry.attributes.position;
            const normals = result.geometry.attributes.normal;

            for (let i = 0; i < positions.count; i++) {
                const nx = normals.getX(i);
                const ny = normals.getY(i);
                const nz = normals.getZ(i);

                positions.setXYZ(
                    i,
                    positions.getX(i) + nx * offset,
                    positions.getY(i) + ny * offset,
                    positions.getZ(i) + nz * offset
                );
            }
            positions.needsUpdate = true;

            result.geometry.computeBoundingBox();
            const bbox = result.geometry.boundingBox;

            // ‚úÖ ÁßªÂãïÁâ©‰ª∂Âà∞ÂéüÈªûÔºàËß£Ê±∫Â∞èÁâ©‰ª∂Ë¢´Êà™Êñ∑ÂïèÈ°åÔºâ
            const center = bbox.getCenter(new THREE.Vector3());
            result.geometry.translate(-center.x, -center.y, -center.z);

            // ÈáçÊñ∞Ë®àÁÆó BBoxÔºàÁèæÂú®‰∏≠ÂøÉÊáâË©≤Âú®ÂéüÈªûÔºâ
            result.geometry.computeBoundingBox();
            const newBbox = result.geometry.boundingBox;
            modelTopZ = newBbox.max.z; // Êñ∞ÁöÑÈ´òÂ∫¶Ëª∏ÊòØ Z
            modelCenter.copy(newBbox.getCenter(new THREE.Vector3()));

            // Ëº∏Âá∫ÂØ¶ÈöõÂ∞∫ÂØ∏
            const modelWidth = newBbox.max.x - newBbox.min.x;
            const modelDepth = newBbox.max.y - newBbox.min.y;
            const modelHeight = newBbox.max.z - newBbox.min.z;

            // üîç Debug: ÂÆåÊï¥Âª∫Ê®°‰ø°ÊÅØ
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            debug('üìê ÂâçÁ´ØÊ∏¨Èáè - Letter 1 BBox (ÂÇ≥Áµ¶ÂæåÁ´Ø):', {
                width: window.letter1BBox.width.toFixed(3) + 'mm',
                height: window.letter1BBox.height.toFixed(3) + 'mm',
                depth: window.letter1BBox.depth.toFixed(3) + 'mm'
            });
            debug('üìê ÂâçÁ´ØÊ∏¨Èáè - Letter 2 BBox (ÂÇ≥Áµ¶ÂæåÁ´Ø):', {
                width: window.letter2BBox.width.toFixed(3) + 'mm',
                height: window.letter2BBox.height.toFixed(3) + 'mm',
                depth: window.letter2BBox.depth.toFixed(3) + 'mm'
            });
            debug('üîç Bevel ÂèÉÊï∏:', {
                bevelEnabled: params.bevelEnabled,
                bevelThickness: params.bevelThickness,
                bevelSize: params.bevelSize,
                bevelSegments: params.bevelSegments
            });
            debug('üìè ÂâçÁ´Ø Model ÊúÄÁµÇÂØ¶ÈöõÂ∞∫ÂØ∏ (CSG ‰∫§ÈõÜÂæå):');
            console.log('  ÂØ¨Â∫¶ (X):', modelWidth.toFixed(3), 'mm');
            console.log('  Ê∑±Â∫¶ (Y):', modelDepth.toFixed(3), 'mm');
            console.log('  È´òÂ∫¶ (Z):', modelHeight.toFixed(3), 'mm');
            console.log('  ‰∏≠ÂøÉÈªû: (',
                modelCenter.x.toFixed(3), ',',
                modelCenter.y.toFixed(3), ',',
                modelCenter.z.toFixed(3), ')');
            console.log('  BBox min: (',
                newBbox.min.x.toFixed(3), ',',
                newBbox.min.y.toFixed(3), ',',
                newBbox.min.z.toFixed(3), ')');
            console.log('  BBox max: (',
                newBbox.max.x.toFixed(3), ',',
                newBbox.max.y.toFixed(3), ',',
                newBbox.max.z.toFixed(3), ')');

            result.material = getMaterial(
                document.getElementById('material').value,
                document.getElementById('finish').value,
                document.getElementById('plating').value
            );

            mainMesh = result;
            scene.add(mainMesh);

            // Êñ∞Áâ©‰ª∂Â∑≤Ê∑ªÂä†ÔºåÁèæÂú®ÂèØ‰ª•ÂÆâÂÖ®ÁßªÈô§ËàäÁâ©‰ª∂
            if (oldMainMesh) {
                scene.remove(oldMainMesh);
                oldMainMesh.geometry?.dispose();
                oldMainMesh.material?.dispose();
            }
            if (oldBailMesh) {
                scene.remove(oldBailMesh);
                oldBailMesh.geometry?.dispose();
                oldBailMesh.material?.dispose();
            }

            debug('Model generated, creating bail...'); // Debug
            createBail();
            
            // ‚ö° ÂÑ™ÂåñÔºöÂª∂ÈÅ≤Ë®àÁÆóÈ´îÁ©çÈáçÈáèÔºà‰∏çÈòªÂ°ûÊ∏≤ÊüìÔºâ
            setTimeout(() => updateVolumeWeight(), 100);
            
            debug('Generation complete!'); // Debug

            // Èö±ËóèÈáçÂª∫ÊèêÁ§∫
            indicator = document.getElementById('model-rebuilding-indicator');
            if (indicator) indicator.style.display = 'none';

            // üßπ ÂïüÁî®Ê∏ÖÁêÜ toggle + ÈáçÁΩÆÁãÄÊÖã
            const cleanupToggle = document.getElementById('cleanup-toggle');
            const cleanupLabel = document.getElementById('cleanup-label');
            
            if (cleanupToggle) {
                cleanupToggle.disabled = false;  // ÂïüÁî® toggle
                cleanupToggle.checked = false;   // ÈáçÁΩÆÁÇ∫ OFF
            }
            
            if (cleanupLabel) {
                cleanupLabel.textContent = 'Ê∏ÖÁêÜ‰ΩúÂìÅÈõ∂Á¢éÈÉ®‰ª∂';  // ÈáçÁΩÆÊñáÂ≠ó
                cleanupLabel.style.color = '';  // ÈáçÁΩÆÈ°èËâ≤
            }
            
            modelNeedsCleanup = false;  // ÈáçÁΩÆÊ∏ÖÁêÜÁãÄÊÖã

            // Êõ¥Êñ∞‰Ω©Êà¥Ê®°Êì¨È†êË¶Ω
            if (window.updateWearingPreview) {
                setTimeout(() => {
                    console.log('üîÑ ÂïÜÂìÅÁîüÊàêÂÆåÊàêÔºåÊõ¥Êñ∞‰Ω©Êà¥Ê®°Êì¨');
                    window.updateWearingPreview();
                }, 300);
            }
            
            // ==========================================
            // üîß Êõ¥Êñ∞Áî¢ÂìÅÊîùÂΩ±Ê®°ÁµÑÁöÑ mesh ÂºïÁî®
            // ==========================================
            ProductPhotoStudio.setMeshes(mainMesh, bailMesh, gridHelper, axesHelper);
        }

        // üßπ Ê∏ÖÈô§Èõ∂Á¢éÈÉ®‰ª∂ÔºàÁî®Êñº Toggle ÈñãÈóúÔºâ
        async function cleanupFragments() {
            if (isCleanupInProgress) return;
            if (!mainMesh) {
                showToast('Ë´ãÂÖàÁîüÊàê‰ΩúÂìÅ');
                return;
            }

            isCleanupInProgress = true;
            const cleanupLabel = document.getElementById('cleanup-label');
            const cleanupToggle = document.getElementById('cleanup-toggle');
            
            // Êõ¥Êñ∞ label ÁãÄÊÖã
            if (cleanupLabel) {
                cleanupLabel.textContent = '‚è≥ Ê≠£Âú®Ê∏ÖÁêÜ...';
                cleanupLabel.style.color = '#4a90e2';
            }

            try {
                const t0 = Date.now();
                const timestamp = () => `[${new Date().toISOString().slice(11,23)}]`;
                const elapsed = () => `(+${((Date.now()-t0)/1000).toFixed(2)}s)`;
                
                console.log(`${timestamp()} üßπ ÈñãÂßãÊ∏ÖÁêÜÈõ∂Á¢éÈÉ®‰ª∂`);

                // 1. ÂèñÂæóÁï∂ÂâçÂèÉÊï∏ÔºàÂåÖÂê´Â¢úÈ†≠‰ΩçÁΩÆÔºâ
                // Ë®àÁÆóÂ¢úÈ†≠Áõ∏Â∞çÊñºÊ®°Âûã‰∏≠ÂøÉÁöÑ‰ΩçÁΩÆ
                const bailRelativeX = bailMesh ? (bailMesh.position.x - modelCenter.x) : 0;
                const bailRelativeY = bailMesh ? (bailMesh.position.y - modelCenter.y) : 0;
                const bailRelativeZ = bailMesh ? (bailMesh.position.z - modelCenter.z) : 0;
                const bailRot = bailMesh ? (bailMesh.rotation.z * 180 / Math.PI) : 0;
                
                const params = {
                    letter1: document.getElementById('letter1').value,
                    letter2: document.getElementById('letter2').value,
                    font1: document.getElementById('font1-btn')?.getAttribute('data-selected') || 'Alex Brush',
                    font2: document.getElementById('font2-btn')?.getAttribute('data-selected') || 'Alex Brush',
                    size: parseInt(document.getElementById('size').value),
                    bailRelativeX: bailRelativeX,
                    bailRelativeY: bailRelativeY,
                    bailRelativeZ: bailRelativeZ,
                    bailRotation: bailRot
                };
                console.log(`${timestamp()} üìã ÂèÉÊï∏Ê∫ñÂÇôÂÆåÊàê (Â¢úÈ†≠: x=${bailRelativeX.toFixed(2)}, y=${bailRelativeY.toFixed(2)}, z=${bailRelativeZ.toFixed(2)}, rot=${bailRot.toFixed(1)}¬∞) ${elapsed()}`);

                // 2. Ë´ãÊ±ÇÂæåÁ´ØÁîüÊàê‰πæÊ∑®ÁöÑ STL
                console.log(`${timestamp()} üì° ÁôºÈÄÅÂæåÁ´ØË´ãÊ±Ç... ${elapsed()}`);
                const response1 = await fetch('https://duet-backend-wlw8.onrender.com/api/request-preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                console.log(`${timestamp()} üì° ÂæåÁ´ØÂõûÊáâÊî∂Âà∞ ${elapsed()}`);

                if (!response1.ok) {
                    throw new Error(`ÂæåÁ´ØË´ãÊ±ÇÂ§±Êïó: ${response1.status}`);
                }

                console.log(`${timestamp()} üîì Ëß£Êûê JSON... ${elapsed()}`);
                const { token, expires_in } = await response1.json();
                console.log(`${timestamp()} ‚úÖ ÂèñÂæó token (ÊúâÊïàÊúü: ${expires_in}Áßí) ${elapsed()}`);

                // 3. Áî® token ‰∏ãËºâ STLÔºàÂ∏∂ÈáçË©¶Ê©üÂà∂Ôºâ
                console.log(`${timestamp()} üîΩ ÈñãÂßã‰∏ãËºâ STL... ${elapsed()}`);
                
                let response2;
                let arrayBuffer;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount <= maxRetries) {
                    try {
                        response2 = await fetch(`https://duet-backend-wlw8.onrender.com/api/get-preview/${token}`);
                        console.log(`${timestamp()} üîΩ STL ‰∏ãËºâÂõûÊáâÊî∂Âà∞ ${elapsed()}`);
                        
                        if (!response2.ok) {
                            const error = await response2.json();
                            throw new Error(error.error || '‰∏ãËºâÂ§±Êïó');
                        }

                        console.log(`${timestamp()} üì¶ ËÆÄÂèñ ArrayBuffer... ${elapsed()}`);
                        arrayBuffer = await response2.arrayBuffer();
                        console.log(`${timestamp()} ‚úÖ STL ‰∏ãËºâÂÆåÊàê (Â§ßÂ∞è: ${(arrayBuffer.byteLength/1024).toFixed(1)}KB) ${elapsed()}`);
                        
                        break; // ÊàêÂäüÔºåË∑≥Âá∫Ëø¥Âúà
                        
                    } catch (error) {
                        retryCount++;
                        if (retryCount > maxRetries) {
                            console.error(`${timestamp()} ‚ùå ‰∏ãËºâÂ§±ÊïóÔºàÂ∑≤ÈáçË©¶ ${maxRetries} Ê¨°Ôºâ: ${error.message}`);
                            throw new Error(`Á∂≤Ë∑ØÈÄ£Á∑öÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÂæåÈáçË©¶`);
                        }
                        console.warn(`${timestamp()} ‚ö†Ô∏è ‰∏ãËºâÂ§±ÊïóÔºåÈáçË©¶ ${retryCount}/${maxRetries}...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Á≠âÂæÖ 1 ÁßíÂæåÈáçË©¶
                    }
                }

                // 4. Áî® STLLoader Ëß£Êûê
                console.log(`${timestamp()} üîß STLLoader Ëß£Êûê‰∏≠... ${elapsed()}`);
                const loader = new STLLoader();
                const cleanGeometry = loader.parse(arrayBuffer);
                console.log(`${timestamp()} üîß Ë®àÁÆó normals... ${elapsed()}`);
                cleanGeometry.computeVertexNormals();
                console.log(`${timestamp()} ‚úÖ STL Ëß£ÊûêÂÆåÊàê ${elapsed()}`);

                // 5. ÊõøÊèõÂ†¥ÊôØ‰∏≠ÁöÑÊ®°Âûã
                console.log(`${timestamp()} üîÑ ÊõøÊèõÂ†¥ÊôØÊ®°Âûã... ${elapsed()}`);
                const oldGeometry = mainMesh.geometry;
                mainMesh.geometry = cleanGeometry;
                
                // Ê∏ÖÁêÜËàä geometry
                oldGeometry.dispose();
                
                // üîß Âº∑Âà∂ÁßªÂà∞ÂéüÈªûÔºàËàá generateModel ‰øùÊåÅ‰∏ÄËá¥Ôºâ
                cleanGeometry.computeBoundingBox();
                const cleanBbox = cleanGeometry.boundingBox;
                const cleanCenter = cleanBbox.getCenter(new THREE.Vector3());
                
                console.log(`${timestamp()} üìê Ê∏ÖÁêÜÂæåÁöÑÂéüÂßã‰∏≠ÂøÉ: (${cleanCenter.x.toFixed(3)}, ${cleanCenter.y.toFixed(3)}, ${cleanCenter.z.toFixed(3)}) ${elapsed()}`);
                
                // ÁßªÂà∞ÂéüÈªû
                cleanGeometry.translate(-cleanCenter.x, -cleanCenter.y, -cleanCenter.z);
                
                // ÈáçÊñ∞Ë®àÁÆó BBoxÔºàÁèæÂú®‰∏≠ÂøÉÊáâË©≤Âú®ÂéüÈªûÔºâ
                cleanGeometry.computeBoundingBox();
                const newBbox = cleanGeometry.boundingBox;
                modelTopZ = newBbox.max.z;
                modelCenter.set(0, 0, 0);  // Âº∑Âà∂Ë®≠ÁÇ∫ÂéüÈªûÔºàËàáÂæåÁ´Ø OpenSCAD ‰∏ÄËá¥Ôºâ
                
                console.log(`${timestamp()} üìê ÁßªÂà∞ÂéüÈªûÂæåÁöÑ‰∏≠ÂøÉ: (${modelCenter.x.toFixed(3)}, ${modelCenter.y.toFixed(3)}, ${modelCenter.z.toFixed(3)}) ${elapsed()}`);
                console.log(`${timestamp()} üìê Êñ∞ÁöÑ modelTopZ: ${modelTopZ.toFixed(3)} ${elapsed()}`);
                
                // ‚úÖ ‰øùÁïôËàäÂ¢úÈ†≠ÔºàÂæåÁ´Ø STL ‰∏çÂê´Â¢úÈ†≠Ôºå‰øùÊåÅÁî®Êà∂Ë™øÊï¥ÁöÑ‰ΩçÁΩÆÔºâ
                if (bailMesh) {
                    console.log(`${timestamp()} ‚úÖ ‰øùÁïôËàäÂ¢úÈ†≠Ôºà‰ΩçÁΩÆ: x=${bailMesh.position.x.toFixed(2)}, y=${bailMesh.position.y.toFixed(2)}, z=${bailMesh.position.z.toFixed(2)}, rot=${(bailMesh.rotation.z * 180 / Math.PI).toFixed(1)}¬∞Ôºâ${elapsed()}`);
                    
                    // üîß ÈáçÊñ∞Ë™øÊï¥Â¢úÈ†≠‰ΩçÁΩÆÔºàÁõ∏Â∞çÊñºÊñ∞ÁöÑÊ®°Âûã‰∏≠ÂøÉ = ÂéüÈªûÔºâ
                    updateBailPosition();
                    console.log(`${timestamp()} üîß Â¢úÈ†≠‰ΩçÁΩÆÂ∑≤Êõ¥Êñ∞: (${bailMesh.position.x.toFixed(2)}, ${bailMesh.position.y.toFixed(2)}, ${bailMesh.position.z.toFixed(2)}) ${elapsed()}`);
                }
                
                console.log(`${timestamp()} ‚úÖ Ê®°ÂûãÂ∑≤ÊõøÊèõ ${elapsed()}`);

                const totalTime = ((Date.now() - t0) / 1000).toFixed(1);
                console.log(`${timestamp()} ‚úÖ Ê∏ÖÁêÜÂÆåÊàê (Á∏ΩËÄóÊôÇ: ${totalTime}Áßí)`);

                // 6. Ë®≠ÂÆöÊ®ôË®òÔºöË®ÇÂñÆÈúÄË¶ÅÊ∏ÖÁêÜ
                modelNeedsCleanup = true;

                // Êõ¥Êñ∞ label È°ØÁ§∫
                if (cleanupLabel) {
                    cleanupLabel.textContent = 'Èõ∂Á¢éÈÉ®‰ª∂Â∑≤Ê∏ÖÁêÜ';
                    cleanupLabel.style.color = '#4caf50';
                }

                // Êõ¥Êñ∞È´îÁ©çÈáçÈáèÔºàÊ∏ÖÁêÜÂæåÂèØËÉΩÊîπËÆäÔºâ
                setTimeout(() => updateVolumeWeight(), 100);

            } catch (error) {
                console.error('‚ùå Ê∏ÖÁêÜÂ§±Êïó:', error);
                
                // Ê∏ÖÁêÜÂ§±ÊïóÊôÇÔºåÈóúÈñâ toggle
                if (cleanupToggle) {
                    cleanupToggle.checked = false;
                }
                
                if (cleanupLabel) {
                    cleanupLabel.textContent = 'Ê∏ÖÁêÜ‰ΩúÂìÅÈõ∂Á¢éÈÉ®‰ª∂';
                    cleanupLabel.style.color = '';
                }
                
                alert('Ê∏ÖÁêÜÂ§±ÊïóÔºö' + error.message);
                
            } finally {
                isCleanupInProgress = false;
            }
        }

        // Âæû opentype.js Â≠óÈ´îËΩâÊèõÁÇ∫ Three.js typeface Ê†ºÂºè
        function convertOpentypeToThreejs(opentypeFont, fontName) {
            const glyphs = {};
            const resolution = 1000;
            const scale = resolution / opentypeFont.unitsPerEm;

            // Áç≤ÂèñÊâÄÊúâÈúÄË¶ÅÁöÑÂ≠óÁ¨¶
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (const char of chars) {
                const glyph = opentypeFont.charToGlyph(char);
                if (!glyph || glyph.index === 0) continue;

                // ‰ΩøÁî®ÂéüÂßãÂñÆ‰ΩçÁç≤ÂèñË∑ØÂæëÔºåÁÑ∂ÂæåÊâãÂãïÁ∏ÆÊîæ
                const path = glyph.getPath(0, 0, opentypeFont.unitsPerEm);
                const commands = [];

                for (const cmd of path.commands) {
                    switch (cmd.type) {
                        case 'M':
                            commands.push({ type: 'm', args: [cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'L':
                            commands.push({ type: 'l', args: [cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'Q':
                            commands.push({ type: 'q', args: [cmd.x1 * scale, cmd.y1 * scale, cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'C':
                            commands.push({ type: 'b', args: [cmd.x1 * scale, cmd.y1 * scale, cmd.x2 * scale, cmd.y2 * scale, cmd.x * scale, cmd.y * scale] });
                            break;
                        case 'Z':
                            commands.push({ type: 'z', args: [] });
                            break;
                    }
                }

                // Â∞á commands ËΩâÊèõÁÇ∫ 'o' Ê†ºÂºèÔºàThree.js typeface Ê†ºÂºèÔºâ
                let o = '';
                for (const cmd of commands) {
                    o += cmd.type;
                    if (cmd.args.length > 0) {
                        o += ' ' + cmd.args.map(n => Math.round(n)).join(' ') + ' ';
                    }
                }

                glyphs[char] = {
                    ha: Math.round((glyph.advanceWidth || opentypeFont.unitsPerEm * 0.5) * scale),
                    x_min: Math.round((glyph.xMin || 0) * scale),
                    x_max: Math.round((glyph.xMax || glyph.advanceWidth || opentypeFont.unitsPerEm * 0.5) * scale),
                    o: o.trim()
                };
            }

            return {
                glyphs: glyphs,
                familyName: fontName,
                ascender: Math.round(opentypeFont.ascender * scale),
                descender: Math.round(opentypeFont.descender * scale),
                underlinePosition: Math.round((opentypeFont.tables.post?.underlinePosition || -100) * scale),
                underlineThickness: Math.round((opentypeFont.tables.post?.underlineThickness || 50) * scale),
                boundingBox: {
                    xMin: Math.round((opentypeFont.tables.head?.xMin || 0) * scale),
                    yMin: Math.round((opentypeFont.tables.head?.yMin || 0) * scale),
                    xMax: Math.round((opentypeFont.tables.head?.xMax || 1000) * scale),
                    yMax: Math.round((opentypeFont.tables.head?.yMax || 1000) * scale)
                },
                resolution: resolution,
                original_font_information: {
                    format: 0,
                    copyright: '',
                    fontFamily: fontName,
                    fontSubfamily: 'Regular',
                    uniqueID: fontName,
                    fullName: fontName,
                    version: '1.0',
                    postScriptName: fontName.replace(/ /g, '')
                }
            };
        }

        async function loadFont(fontName) {
            if (loadedFonts[fontName]) return loadedFonts[fontName];

            const loader = new FontLoader();

            console.log(`Loading font: ${fontName}`);

            // Â∞áÂ≠óÈ´îÂêçÁ®±ËΩâÊèõÁÇ∫ npm Â•ó‰ª∂ÂêçÁ®±Ê†ºÂºè
            // ‰æãÂ¶ÇÔºö'Playfair Display' -> 'playfair-display'
            const packageName = fontName.toLowerCase().replace(/ /g, '-');

            // ÂòóË©¶ÂæûÂ§öÂÄã‰æÜÊ∫êËºâÂÖ•
            const sources = [
                // 1. @compai/font-* Â•ó‰ª∂ (esm.sh CDN)
                `https://esm.sh/@compai/font-${packageName}/data/typefaces/normal-400.json`,
                // 2. components-ai/typefaces GitHub (jsDelivr)
                `https://cdn.jsdelivr.net/gh/components-ai/typefaces/packages/font-${packageName}/data/typefaces/normal-400.json`,
                // 3. 7dir/json-fonts GitHub
                `https://cdn.jsdelivr.net/gh/7dir/json-fonts/Roboto/${fontName.replace(/ /g, '_')}_Regular.json`,
                // 4. emreacar/google-fonts-as-json GitHub  
                `https://cdn.jsdelivr.net/gh/emreacar/google-fonts-as-json/fonts/${fontName.replace(/ /g, '%20')}/regular.json`,
            ];

            for (const url of sources) {
                try {
                    console.log(`Trying: ${url}`);
                    const response = await fetch(url);
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const json = await response.json();
                            // Ê™¢Êü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑ typeface Ê†ºÂºè
                            if (json.glyphs || json.data) {
                                const fontData = json.data || json;
                                const font = loader.parse(fontData);
                                loadedFonts[fontName] = font;
                                console.log(`‚úì Loaded ${fontName} from ${url}`);
                                return font;
                            }
                        }
                    }
                } catch (e) {
                    console.log(`‚úó Failed: ${url}`, e.message);
                }
            }

            // Â¶ÇÊûú CDN ÈÉΩÂ§±ÊïóÔºåÂòóË©¶Áî® opentype.js Âæû Google Fonts Ëß£Êûê
            try {
                const fontUrlName = fontName.replace(/ /g, '+');
                const cssUrl = `https://fonts.googleapis.com/css?family=${fontUrlName}`;

                const cssResponse = await fetch(cssUrl);
                if (cssResponse.ok) {
                    const cssText = await cssResponse.text();
                    const urlMatch = cssText.match(/url\((https:\/\/fonts\.gstatic\.com\/[^)]+)\)/);

                    if (urlMatch) {
                        const fontFileUrl = urlMatch[1];
                        console.log(`Trying Google Fonts: ${fontFileUrl}`);

                        const fontResponse = await fetch(fontFileUrl);
                        if (fontResponse.ok) {
                            const fontBuffer = await fontResponse.arrayBuffer();

                            try {
                                const opentypeFont = opentype.parse(fontBuffer);
                                const typefaceData = convertOpentypeToThreejs(opentypeFont, fontName);
                                const font = loader.parse(typefaceData);
                                loadedFonts[fontName] = font;
                                console.log(`‚úì Loaded ${fontName} via opentype.js`);
                                return font;
                            } catch (parseError) {
                                console.log(`‚úó Parse failed (likely woff2): ${parseError.message}`);
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn(`Failed Google Fonts: ${error.message}`);
            }

            // ÊúÄÁµÇÂÇôÁî®Ôºö‰ΩøÁî®È†êË®≠Â≠óÈ´î
            console.warn(`‚ö† Using Helvetiker for: ${fontName}`);
            return new Promise((resolve) => {
                loader.load(
                    'https://threejs.org/examples/fonts/helvetiker_regular.typeface.json',
                    (font) => resolve(font)
                );
            });
        }

        function createBail() {
            // ÂÖàÁßªÈô§ËàäÁöÑ bailMesh
            if (bailMesh) {
                scene.remove(bailMesh);
                bailMesh.geometry?.dispose();
                bailMesh.material?.dispose();
                bailMesh = null;
                // Êö¥Èú≤Áµ¶‰Ω©Êà¥Ê®°Êì¨ÔºàÁî®ÊñºÊà™ÂèñÂ¢úÈ£æÔºâ
                window.bailMesh = null;
            }

            if (!mainMesh) return;

            const innerRadius = 1.5;   // ÂÖßÁõ¥Âæë 3mm
            const tubeRadius = 0.35;   // ÁÆ°ÂçäÂæë 0.35mmÔºåÁõ¥Âæë 0.7mm
            const geometry = new THREE.TorusGeometry(innerRadius + tubeRadius, tubeRadius, 16, 32);

            // Â∞á Torus Âæû XY Âπ≥Èù¢ËΩâÂà∞ XZ Âπ≥Èù¢ (Á´ôÁ´ã)
            geometry.rotateX(Math.PI / 2);
            // ÁπûÊñ∞ÁöÑÈ´òÂ∫¶Ëª∏ Z ÊóãËΩâ 90 Â∫¶
            geometry.rotateZ(Math.PI / 2);

            const material = getMaterial(
                document.getElementById('material').value,
                document.getElementById('finish').value,
                document.getElementById('plating').value
            );
            bailMesh = new THREE.Mesh(geometry, material);
            scene.add(bailMesh);
            // Êö¥Èú≤Áµ¶‰Ω©Êà¥Ê®°Êì¨ÔºàÁî®ÊñºÊà™ÂèñÂ¢úÈ£æÔºâ
            window.bailMesh = bailMesh;

            updateBailPosition();
        }

        function updateBailPosition() {
            if (!bailMesh) return;
            const x = parseFloat(document.getElementById('bailX').value);
            // bailY Â∞çÊáâ UI ÁöÑ Position Y (Depth)
            const y_depth_adj = parseFloat(document.getElementById('bailY').value);
            // bailZ Â∞çÊáâ UI ÁöÑ Position Z (Height)
            const z_height_adj = parseFloat(document.getElementById('bailZ').value);
            const rotation = parseFloat(document.getElementById('bailRotation').value);

            const baseZ = modelTopZ + 2.0; // Âú® Z (È´òÂ∫¶) Ëª∏‰∏äÂÆö‰Ωç

            // Ë™øÊï¥ÔºöX ‰∏çËÆä, Y Ëª∏ÁÇ∫ modelCenter.y + Ê∑±Â∫¶Ë™øÊï¥, Z Ëª∏ÁÇ∫ baseZ + È´òÂ∫¶Ë™øÊï¥
            bailMesh.position.set(modelCenter.x + x, modelCenter.y + y_depth_adj, baseZ + z_height_adj);

            // ÊóãËΩâ‰ª• Z Ëª∏ÁÇ∫Ëª∏ÂøÉ
            bailMesh.rotation.z = (rotation * Math.PI) / 180;

            // üîç Debug: Â¢úÈ†≠‰ΩçÁΩÆ
            console.log('üîç Â¢úÈ†≠ÁµïÂ∞ç‰ΩçÁΩÆ:', {
                x: bailMesh.position.x.toFixed(3),
                y: bailMesh.position.y.toFixed(3),
                z: bailMesh.position.z.toFixed(3),
                rotation: rotation + '¬∞'
            });
            console.log('üîç Ê®°Âûã‰∏≠ÂøÉ:', {
                x: modelCenter.x.toFixed(3),
                y: modelCenter.y.toFixed(3),
                z: modelCenter.z.toFixed(3)
            });
            console.log('üîç Ê®°ÂûãÈ†ÇÈÉ® Z:', modelTopZ.toFixed(3));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }

        // Âè™Êõ¥Êñ∞ÊùêË≥™Ôºå‰∏çÈáçÂª∫Ê®°ÂûãÔºàÂç≥ÊôÇÂàáÊèõÔºÅÔºâ
        function updateMaterial() {
            if (!mainMesh || !bailMesh) return;

            const materialType = document.getElementById('material').value;
            const finish = document.getElementById('finish').value;
            const plating = document.getElementById('plating').value;
            const newMaterial = getMaterial(materialType, finish, plating);

            // Êõ¥Êèõ‰∏ªÈ´îÂíåÂ¢úÈ†≠ÁöÑÊùêË≥™
            mainMesh.material = newMaterial;
            bailMesh.material = newMaterial.clone();

            // Êõ¥Êñ∞ÈáçÈáèÈ°ØÁ§∫ÔºàÂØÜÂ∫¶ÊîπËÆä‰∫ÜÔºâ
            updateVolumeWeight();

            // Êõ¥Êñ∞ÂÉπÊ†ºÈ°ØÁ§∫
            updatePriceDisplay();
        }

        // Êõ¥Êñ∞ÂÉπÊ†ºÈ°ØÁ§∫
        function updatePriceDisplay() {
            const plating = document.getElementById('plating').value;

            // Âü∫Á§éÂÉπÊ†ºÔºö925ÈäÄ„ÄÅÈªÉÈäÖÈÉΩÊòØ 3850
            let price = 3850;

            // ÊúâÈõªÈççÔºà‰ªª‰ΩïÈõªÈççÔºâ+400
            if (plating && plating !== 'none') {
                price += 400;
            }

            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('price-display').textContent = `NT$ ${price.toLocaleString()}`;
        }

        function updateVolumeWeight() {
            if (!mainMesh || !mainMesh.geometry.attributes.position) {
                document.getElementById('volume-display').textContent = '- mm¬≥';
                document.getElementById('weight-display').textContent = '- g';
                return;
            }

            let volume = 0;
            const positions = mainMesh.geometry.attributes.position;
            const p1 = new THREE.Vector3();
            const p2 = new THREE.Vector3();
            const p3 = new THREE.Vector3();

            for (let i = 0; i < positions.count; i += 3) {
                p1.fromBufferAttribute(positions, i);
                p2.fromBufferAttribute(positions, i + 1);
                p3.fromBufferAttribute(positions, i + 2);
                volume += p1.dot(p2.cross(p3)) / 6.0;
            }
            volume = Math.abs(volume);

            const density = MATERIALS[document.getElementById('material').value].density;
            const weight = (volume * density) / 1000;

            document.getElementById('volume-display').textContent = `${volume.toFixed(2)} mm¬≥`;
            document.getElementById('weight-display').textContent = `${weight.toFixed(2)} g`;
        }

        // Â≠óÈ´îÈÅ∏ÊìáÂô®ÔºàÁ≠âÂæÖ fonts.json ËºâÂÖ•ÂÆåÊàêÂæåÊâçÂàùÂßãÂåñÔºâ
        async function initFontSelector() {
            // Á≠âÂæÖÂ≠óÈ´îËºâÂÖ•ÂÆåÊàê
            if (typeof fontsLoadedPromise !== 'undefined') {
                await fontsLoadedPromise;
            }

            const listContainer = document.getElementById('font-list-container');
            const displayArea = document.getElementById('font-display-area');

            // ‰ΩøÁî®Âæû fonts.json ËºâÂÖ•ÁöÑÂèØÁî®Â≠óÈ´îÊ∏ÖÂñÆ
            const fontsToDisplay = availableFonts.length > 0 ? availableFonts : [];

            fontsToDisplay.forEach((font) => {
                const item = document.createElement('div');
                item.className = 'font-list-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.font = font;

                const label = document.createElement('span');
                label.textContent = font;
                label.style.fontFamily = `"${font}", sans-serif`;

                item.appendChild(checkbox);
                item.appendChild(label);
                listContainer.appendChild(item);

                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        checkedFonts.add(font);
                    } else {
                        checkedFonts.delete(font);
                    }
                    updateFontDisplay();
                });

                item.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                const card = document.createElement('div');
                card.className = 'font-preview-card';
                card.dataset.font = font;

                const charDiv = document.createElement('div');
                charDiv.className = 'preview-char';
                charDiv.style.fontFamily = `"${font}", sans-serif`;
                // ‰ΩøÁî®Ëº∏ÂÖ•ÁöÑÂâçÂÖ©ÂÄãÂ≠óÊØçÔºåÈ†êË®≠ÁÇ∫ 'A'
                const charInput = document.getElementById('char-input');
                charDiv.textContent = charInput.value.substring(0, 2) || 'A';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'preview-name';
                nameDiv.textContent = font;

                card.appendChild(charDiv);
                card.appendChild(nameDiv);
                displayArea.appendChild(card);

                card.addEventListener('click', () => {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                });
            });

            document.getElementById('char-input').addEventListener('input', (e) => {
                // È°ØÁ§∫ÂâçÂÖ©ÂÄãÂ≠óÊØç
                const chars = e.target.value.substring(0, 2) || 'A';
                document.querySelectorAll('.preview-char').forEach(el => {
                    el.textContent = chars;
                });

                // ÂêåÊ≠•ÂõûÂ∑¶ÂÅ¥Â≠óÊØçÈÅ∏ÊìáÔºàÈõôÂêëÂêåÊ≠•Ôºâ
                if (chars.length >= 1) {
                    document.getElementById('letter1').value = chars[0] || 'A';
                }
                if (chars.length >= 2) {
                    document.getElementById('letter2').value = chars[1] || 'A';
                }
            });

            document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.font-list-item input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                    if (e.target.checked) {
                        checkedFonts.add(cb.dataset.font);
                    } else {
                        checkedFonts.delete(cb.dataset.font);
                    }
                });
                updateFontDisplay();
            });
        }

        function updateFontDisplay() {
            document.querySelectorAll('.font-preview-card').forEach(card => {
                const font = card.dataset.font;
                if (checkedFonts.has(font)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function openFontSelector() {
            // ËÆÄÂèñÁï∂ÂâçÂ≠óÊØç‰∏¶Ëá™ÂãïÂ°´ÂÖ•Â≠óÈ´îÈÅ∏ÊìáË¶ñÁ™ó
            const letter1 = document.getElementById('letter1').value;
            const letter2 = document.getElementById('letter2').value;
            const charInput = document.getElementById('char-input');
            charInput.value = letter1 + letter2;

            // Ëß∏Áôº input ‰∫ã‰ª∂ÔºåÊõ¥Êñ∞Â≠óÈ´îÈ†êË¶Ω
            charInput.dispatchEvent(new Event('input'));

            document.getElementById('font-selector-modal').classList.add('active');
        }

        function closeFontSelector() {
            document.getElementById('font-selector-modal').classList.remove('active');
        }

        // È†êËºâÂÖ•ÈÅ∏‰∏≠ÁöÑÂ≠óÈ´îÂà∞ cacheÔºàËÉåÊôØËºâÂÖ•Ôºâ
        async function preloadSelectedFonts(fontNames) {
            console.log(`üöÄ ÈñãÂßãÈ†êËºâÂÖ• ${fontNames.length} ÂÄãÂ≠óÈ´î...`);

            // È°ØÁ§∫ÈÄ≤Â∫¶ÊèêÁ§∫
            const statusDiv = document.getElementById('font-preload-status');
            const progressText = document.getElementById('preload-progress');
            const preloadText = document.getElementById('preload-text');

            statusDiv.style.display = 'block';
            preloadText.textContent = 'È†êËºâÂÖ•Â≠óÈ´î‰∏≠...';
            progressText.textContent = `0 / ${fontNames.length}`;

            const startTime = Date.now();
            let successCount = 0;

            // ‰∏¶Ë°åËºâÂÖ•ÊâÄÊúâÂ≠óÈ´îÔºà‰∏çÈòªÂ°û UIÔºâ
            const loadPromises = fontNames.map(async (fontName) => {
                try {
                    await loadFont(fontName);
                    successCount++;
                    progressText.textContent = `${successCount} / ${fontNames.length}`;
                    console.log(`‚úì È†êËºâÂÖ•ÊàêÂäü: ${fontName} (${successCount}/${fontNames.length})`);
                } catch (error) {
                    console.warn(`‚úó È†êËºâÂÖ•Â§±Êïó: ${fontName}`, error);
                }
            });

            // ‰∏çÁ≠âÂæÖÂÖ®ÈÉ®ÂÆåÊàêÔºåËÆìÂÆÉÂú®ËÉåÊôØÂü∑Ë°å
            Promise.all(loadPromises).then(() => {
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ Â≠óÈ´îÈ†êËºâÂÖ•ÂÆåÊàêÔºÅÊàêÂäü: ${successCount}/${fontNames.length}ÔºåËÄóÊôÇ: ${duration}Áßí`);

                // È°ØÁ§∫ÂÆåÊàêÁãÄÊÖã 2 ÁßíÂæåÈö±Ëóè
                preloadText.textContent = `‚úì ${successCount} ÂÄãÂ≠óÈ´îÂ∑≤Â∞±Á∑íÔºÅ`;
                progressText.textContent = `ÂàáÊèõÂ≠óÈ´îÂ∞áÊõ¥Âø´ÈÄü`;

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            });
        }

        // È°ØÁ§∫‰ΩéË™øÁöÑ Toast ÊèêÁ§∫
        function showToast(message, duration = 4000) {
            const toast = document.getElementById('custom-toast');
            const messageEl = toast.querySelector('.custom-toast-message');
            
            messageEl.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function confirmFontSelection() {
            if (checkedFonts.size === 0) {
                alert('Please select at least one font!');
                return;
            }

            const inputChars = document.getElementById('char-input').value.trim();
            if (inputChars.length < 2) {
                alert('Please enter 2 letters');
                return;
            }

            const letter1Select = document.getElementById('letter1');
            const letter2Select = document.getElementById('letter2');

            letter1Select.value = inputChars[0];
            letter2Select.value = inputChars[1];

            const selectedFonts = Array.from(checkedFonts);

            // Êõ¥Êñ∞Â≠óÈ´îÊåâÈàïÁÇ∫‰∏ãÊãâÈÅ∏ÂñÆ
            ['font1', 'font2'].forEach(target => {
                const btn = document.getElementById(`${target}-btn`);

                // Èö±ËóèÊåâÈàïÔºåÂâµÂª∫‰∏ãÊãâÈÅ∏ÂñÆ
                btn.style.display = 'none';

                // Ê™¢Êü•ÊòØÂê¶Â∑≤Êúâ‰∏ãÊãâÈÅ∏ÂñÆ
                let select = document.getElementById(`${target}-select`);
                if (!select) {
                    select = document.createElement('select');
                    select.id = `${target}-select`;
                    select.className = 'font-select-btn';
                    select.style.display = 'block';
                    select.style.cursor = 'pointer';
                    btn.parentNode.appendChild(select);
                } else {
                    select.style.display = 'block';
                }

                // Ê∏ÖÁ©∫‰∏¶Â°´ÂÖ•Â≠óÈ´îÈÅ∏È†Ö
                select.innerHTML = '';
                selectedFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    option.style.fontFamily = `"${font}", sans-serif`;
                    select.appendChild(option);
                });

                // Ê∑ªÂä† Re-select ÈÅ∏È†Ö
                const reselectOption = document.createElement('option');
                reselectOption.value = 'reselect';
                reselectOption.textContent = '‚Üª Re-select Fonts';
                select.appendChild(reselectOption);

                // Êô∫ËÉΩÈÅ∏ÊìáÈ†êË®≠Â≠óÈ´îÔºàÂÑ™ÂÖà‰ΩøÁî® AI Êé®Ëñ¶Ôºâ
                let defaultFont = selectedFonts[0];

                if (window.aiRecommendation) {
                    const recommendedForThisLetter = target === 'font1'
                        ? window.aiRecommendation.letter1
                        : window.aiRecommendation.letter2;

                    // Â¶ÇÊûúÊé®Ëñ¶Â≠óÈ´îÂú®Â∑≤ÈÅ∏Â≠óÈ´î‰∏≠Ôºå‰ΩøÁî®Á¨¨‰∏ÄÂÄãÊé®Ëñ¶
                    const firstRecommended = recommendedForThisLetter.find(f => selectedFonts.includes(f));
                    if (firstRecommended) {
                        defaultFont = firstRecommended;
                        console.log(`‚úÖ ${target} ‰ΩøÁî® AI Êé®Ëñ¶Â≠óÈ´î:`, defaultFont);
                    }
                }

                select.value = defaultFont;
                btn.setAttribute('data-selected', defaultFont);
                select.style.fontFamily = `"${defaultFont}", sans-serif`;
                
                // ‚úÖ Á´ãÂç≥ÂêåÊ≠•Âà∞ hidden input
                const hiddenInput = document.getElementById(target);
                if (hiddenInput) {
                    hiddenInput.value = defaultFont;
                }

                // Áõ£ËÅΩ‰∏ãÊãâÈÅ∏ÂñÆËÆäÊõ¥
                select.onchange = function () {
                    if (this.value === 'reselect') {
                        isReselect = true;  // Ë®≠ÂÆöÁÇ∫ÈáçÊñ∞ÈÅ∏Êìá
                        openFontSelector();
                        this.value = btn.getAttribute('data-selected') || selectedFonts[0];
                    } else {
                        btn.setAttribute('data-selected', this.value);
                        // Êõ¥Êñ∞‰∏ãÊãâÈÅ∏ÂñÆÊú¨Ë∫´ÁöÑÂ≠óÈ´îÊ®£Âºè
                        this.style.fontFamily = `"${this.value}", sans-serif`;
                        
                        // ‚úÖ ÂêåÊ≠•Âà∞ hidden input
                        const hiddenInput = document.getElementById(target);
                        if (hiddenInput) {
                            hiddenInput.value = this.value;
                        }
                        
                        // ‰∏çÂêåÊ≠•Êõ¥Êñ∞Âè¶‰∏ÄÂÄã‰∏ãÊãâÈÅ∏ÂñÆÔºåÂÖÅË®±Áç®Á´ãÈÅ∏Êìá
                        generateModel();
                    }
                };
            });

            closeFontSelector();

            // üöÄ È†êËºâÂÖ•ÊâÄÊúâÈÅ∏‰∏≠ÁöÑÂ≠óÈ´îÂà∞ cacheÔºàËÉåÊôØËºâÂÖ•Ôºâ
            preloadSelectedFonts(selectedFonts);

            // Ê†πÊìöÊòØÂê¶ÁÇ∫ÈáçÊñ∞ÈÅ∏ÊìáÊ±∫ÂÆöË°åÁÇ∫
            if (isReselect) {
                // ÈáçÊñ∞ÈÅ∏ÊìáÔºö‰∏çËá™ÂãïÁîüÊàêÔºåÈ°ØÁ§∫‰ΩéË™øÊèêÁ§∫
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn) {
                    generateBtn.style.animation = 'pulse 1s ease-in-out 3';
                    setTimeout(() => {
                        generateBtn.style.animation = '';
                    }, 3000);
                }
                
                // È°ØÁ§∫‰ΩéË™øÁöÑ Toast ÊèêÁ§∫
                showToast('Â≠óÈ´îÊ∏ÖÂñÆÂ∑≤Êõ¥Êñ∞ÔºåË´ãÂú®‰∏ãÊãâÈÅ∏ÂñÆ‰∏≠ÈÅ∏ÊìáÂ≠óÈ´îÂæåÁîüÊàêÊ®°Âûã');
                isReselect = false;  // ÈáçÁΩÆÊ®ôË®ò
            } else {
                // Á¨¨‰∏ÄÊ¨°ÈÅ∏ÊìáÔºöËá™ÂãïÁîüÊàêÊ®°ÂûãÔºà‰∏çÈ°ØÁ§∫ÊèêÁ§∫Ôºâ
                generateModel();
            }
        }

        // ÊßΩ‰ΩçÂäüËÉΩÔºàÁ∞°ÂåñÁâàÔºöÁ¥îÂÑ≤Â≠òÂíåÂè¨ÂõûÔºåÊ∑ªÂä†ÂêåÊ≠•ÊóãËΩâÔºâ
        function saveToSlot(slotIndex) {
            if (!mainMesh) return;

            const slotElement = document.querySelector(`[data-slot="${slotIndex + 1}"]`);
            slotElement.classList.remove('empty');

            // Áç≤ÂèñÁï∂ÂâçÂ≠óÈ´îÂêçÁ®±
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Name = font1Select ? font1Select.value : document.getElementById('font1-btn').getAttribute('data-selected');
            const font2Name = font2Select ? font2Select.value : document.getElementById('font2-btn').getAttribute('data-selected');

            // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖã
            savedVersions[slotIndex] = {
                letter1: document.getElementById('letter1').value,
                letter2: document.getElementById('letter2').value,
                font1: font1Name,
                font2: font2Name,
                material: document.getElementById('material').value,
                plating: document.getElementById('plating').value,
                finish: document.getElementById('finish').value,
                size: document.getElementById('size').value,
                bailX: document.getElementById('bailX').value,
                bailY: document.getElementById('bailY').value,
                bailZ: document.getElementById('bailZ').value,
                bailRotation: document.getElementById('bailRotation').value,
                mesh: mainMesh.clone(),
                bail: bailMesh ? bailMesh.clone() : null
            };

            // ÂâµÂª∫Á∏ÆÁï•Âúñ
            slotElement.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = 160;
            canvas.height = 160;
            slotElement.appendChild(canvas);

            const slotRenderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            slotRenderer.setSize(160, 160);
            slotRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            slotRenderer.outputColorSpace = THREE.SRGBColorSpace;

            const slotScene = new THREE.Scene();
            const slotCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            slotCamera.up.set(0, 0, 1); // Z-up Á≥ªÁµ±
            const dist = 50;
            const ratioX = 1.0;
            const ratioY = 0.4;
            const ratioZ = 1.0;
            const totalRatio = Math.sqrt(ratioX * ratioX + ratioY * ratioY + ratioZ * ratioZ);
            const scaleFactor = dist / totalRatio;
            const newRatioX = ratioZ;
            const newRatioY = -ratioX;
            slotCamera.position.set(
                newRatioX * scaleFactor,
                newRatioY * scaleFactor,
                ratioY * scaleFactor
            );
            slotCamera.lookAt(0, 0, 0);

            const light1 = new THREE.AmbientLight(0xffffff, 0.5);
            const light2 = new THREE.DirectionalLight(0xffffff, 1.0);
            light2.position.set(5, 5, 10);
            slotScene.add(light1);
            slotScene.add(light2);
            slotScene.environment = envMap;

            const meshClone = mainMesh.clone();
            slotScene.add(meshClone);
            if (bailMesh) {
                const bailClone = bailMesh.clone();
                slotScene.add(bailClone);
            }

            slotRenderer.render(slotScene, slotCamera);

            // ‰øùÂ≠òÂà∞ÂÖ®ÂüüËÆäÊï∏‰ª•‰æøÂêåÊ≠•ÊóãËΩâ
            if (slotIndex === 0) {
                slot1Renderer = slotRenderer;
                slot1Scene = slotScene;
                slot1Camera = slotCamera;
            } else {
                slot2Renderer = slotRenderer;
                slot2Scene = slotScene;
                slot2Camera = slotCamera;
            }

            const label = document.createElement('div');
            label.className = 'version-label';
            label.textContent = `SLOT ${slotIndex + 1}`;
            slotElement.appendChild(label);
        }

        function loadFromSlot(slotIndex) {
            const slotData = savedVersions[slotIndex];
            if (!slotData) return;

            // ËºâÂÖ•ÊßΩ‰ΩçÊï∏ÊìöÂà∞‰∏ªÁï´Èù¢
            document.getElementById('letter1').value = slotData.letter1;
            document.getElementById('letter2').value = slotData.letter2;
            document.getElementById('material').value = slotData.material;
            document.getElementById('plating').value = slotData.plating || 'none';  // ÂêëÂæåÁõ∏ÂÆπÔºöÂ¶ÇÊûúÊ≤íÊúâÈõªÈççË≥áÊñôÔºåÈ†êË®≠ÁÇ∫„ÄåÁÑ°„Äç
            document.getElementById('finish').value = slotData.finish;
            document.getElementById('size').value = slotData.size;
            document.getElementById('bailX').value = slotData.bailX;
            document.getElementById('bailY').value = slotData.bailY;
            document.getElementById('bailZ').value = slotData.bailZ;
            document.getElementById('bailRotation').value = slotData.bailRotation;

            // Êõ¥Êñ∞È°ØÁ§∫ÂÄº
            document.getElementById('bailX-val').textContent = slotData.bailX;
            document.getElementById('bailY-val').textContent = slotData.bailY;
            document.getElementById('bailZ-val').textContent = slotData.bailZ;
            document.getElementById('bailRotation-val').textContent = slotData.bailRotation + '¬∞';

            // Êõ¥Êñ∞Â≠óÈ´îÊåâÈàïÂíå‰∏ãÊãâÈÅ∏ÂñÆ
            const font1Btn = document.getElementById('font1-btn');
            const font2Btn = document.getElementById('font2-btn');
            font1Btn.setAttribute('data-selected', slotData.font1);
            font2Btn.setAttribute('data-selected', slotData.font2);

            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            if (font1Select) font1Select.value = slotData.font1;
            if (font2Select) font2Select.value = slotData.font2;

            // Ê∏ÖÈô§ËàäÊ®°Âûã
            if (mainMesh) {
                scene.remove(mainMesh);
                if (mainMesh.geometry) mainMesh.geometry.dispose();
                if (mainMesh.material) mainMesh.material.dispose();
            }
            if (bailMesh) {
                scene.remove(bailMesh);
                if (bailMesh.geometry) bailMesh.geometry.dispose();
                if (bailMesh.material) bailMesh.material.dispose();
            }

            // ËºâÂÖ•Êñ∞Ê®°ÂûãÔºà‰ΩøÁî®Ê∑±Êã∑Ë≤ùÔºâ
            mainMesh = slotData.mesh.clone();
            mainMesh.material = mainMesh.material.clone();
            scene.add(mainMesh);

            if (slotData.bail) {
                bailMesh = slotData.bail.clone();
                bailMesh.material = bailMesh.material.clone();
                scene.add(bailMesh);
            }

            updateVolumeWeight();
        }

        // Ë≥ºÁâ©Ëªä
        // üì∏ ÁîüÊàê‰∏âË¶ñÂúñÔºàÊ≠£Ë¶ñ„ÄÅÂÅ¥Ë¶ñ„ÄÅ‰øØË¶ñÔºâ
        function captureThreeViews() {
            const views = [];
            
            // ÂÑ≤Â≠òÂéüÂßãÁõ∏Ê©üÁãÄÊÖã
            const originalCamera = {
                position: camera.position.clone(),
                rotation: camera.rotation.clone()
            };
            
            // Ë®àÁÆóÊ®°ÂûãÁöÑ BBox ‰∏≠ÂøÉÂíåÂ§ßÂ∞è
            mainMesh.geometry.computeBoundingBox();
            const bbox = mainMesh.geometry.boundingBox;
            const center = bbox.getCenter(new THREE.Vector3());
            const size = bbox.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const distance = maxDim * 3;  // ÈÅ©Áï∂ÁöÑË∑ùÈõ¢
            
            // Ê≠£Ë¶ñÂúñ (Letter 1 Ê≠£Èù¢ - Âæû -Y ÁúãÂêë +YÔºåÁúãÂà∞ XZ Âπ≥Èù¢)
            camera.position.set(center.x, center.y - distance, center.z);
            camera.lookAt(center);
            controls.update();
            renderer.render(scene, camera);
            views.push({
                name: 'letter1_view',
                label: 'Front View (Letter 1)',
                dataURL: renderer.domElement.toDataURL('image/png')
            });
            
            // ÂÅ¥Ë¶ñÂúñ (Letter 2 Ê≠£Èù¢ - Âæû +X ÁúãÂêë -XÔºåÁúãÂà∞ YZ Âπ≥Èù¢)
            camera.position.set(center.x + distance, center.y, center.z);
            camera.lookAt(center);
            controls.update();
            renderer.render(scene, camera);
            views.push({
                name: 'letter2_view',
                label: 'Side View (Letter 2)',
                dataURL: renderer.domElement.toDataURL('image/png')
            });
            
            // ‰∏äË¶ñÂúñ (Âæû +Z ÁúãÂêë -ZÔºåÁúãÂà∞ XY Âπ≥Èù¢)
            camera.position.set(center.x, center.y, center.z + distance);
            camera.lookAt(center);
            controls.update();
            renderer.render(scene, camera);
            views.push({
                name: 'top_view',
                label: 'Top View',
                dataURL: renderer.domElement.toDataURL('image/png')
            });
            
            // ÊÅ¢Âæ©ÂéüÂßãË¶ñËßí
            camera.position.copy(originalCamera.position);
            camera.rotation.copy(originalCamera.rotation);
            controls.update();
            renderer.render(scene, camera);
            
            console.log('üì∏ ‰∏âË¶ñÂúñÂ∑≤ÁîüÊàêÔºàÊ≠£Ë¶ñ/ÂÅ¥Ë¶ñ/‰øØË¶ñÔºâ');
            return views;
        }

        function addToCart() {
            if (!mainMesh) return;

            // ‚úÖ ÈôêÂà∂Ë≥ºÁâ©ËªäÊúÄÂ§ö 3 ÂÄãÁâ©‰ª∂
            if (cartItems.length >= 3) {
                showToast('Ë≥ºÁâ©ËªäÊúÄÂ§öÂè™ËÉΩÂä†ÂÖ• 3 ÂÄãÂïÜÂìÅÔºåÂ¶ÇÈúÄË®ÇË≥ºÊõ¥Â§öË´ãÂàÜÊâπÁµêÂ∏≥');
                return;
            }
            
            // üì∏ ÁîüÊàê‰∏âË¶ñÂúñ
            const threeViews = captureThreeViews();

            // Áç≤ÂèñÁï∂ÂâçÈÅ∏ÊìáÁöÑÂ≠óÈ´îÂêçÁ®±
            const font1Select = document.getElementById('font1-select');
            const font2Select = document.getElementById('font2-select');
            const font1Name = font1Select ? font1Select.value : document.getElementById('font1-btn').getAttribute('data-selected');
            const font2Name = font2Select ? font2Select.value : document.getElementById('font2-btn').getAttribute('data-selected');

            // Ë®àÁÆóÂ¢úÈ†≠Áõ∏Â∞çÊñº‰∏ªÈ´î‰∏≠ÂøÉÁöÑÂêëÈáè
            const bailRelativeX = bailMesh ? (bailMesh.position.x - modelCenter.x) : 0;
            const bailRelativeY = bailMesh ? (bailMesh.position.y - modelCenter.y) : 0;
            const bailRelativeZ = bailMesh ? (bailMesh.position.z - modelCenter.z) : 0;
            const bailRot = bailMesh ? (bailMesh.rotation.z * 180 / Math.PI) : 0;

            // ‚úÖ ÁîüÊàêÁ∏ÆÁï•ÂúñÔºàÁî®ÊñºË≥ºÁâ©ËªäÈ†êË¶ΩÔºâ
            const thumbnailCanvas = document.createElement('canvas');
            thumbnailCanvas.width = 100;
            thumbnailCanvas.height = 100;
            const thumbnailRenderer = new THREE.WebGLRenderer({
                canvas: thumbnailCanvas,
                antialias: true,
                alpha: true
            });
            thumbnailRenderer.setSize(100, 100);
            thumbnailRenderer.toneMapping = THREE.ACESFilmicToneMapping;
            thumbnailRenderer.outputColorSpace = THREE.SRGBColorSpace;

            const thumbnailScene = new THREE.Scene();
            const thumbnailCamera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            thumbnailCamera.up.set(0, 0, 1);
            thumbnailCamera.position.set(20, -28, 6);
            thumbnailCamera.lookAt(0, 0, 0);

            // Ê∑ªÂä†ÁáàÂÖâ
            const light1 = new THREE.AmbientLight(0xffffff, 0.5);
            const light2 = new THREE.DirectionalLight(0xffffff, 1.0);
            light2.position.set(5, 5, 10);
            thumbnailScene.add(light1, light2);

            // Ë§áË£ΩÁï∂ÂâçÂ†¥ÊôØÁöÑÁâ©‰ª∂
            thumbnailScene.add(mainMesh.clone());
            if (bailMesh) thumbnailScene.add(bailMesh.clone());

            // Ê∏≤Êüì
            thumbnailRenderer.render(thumbnailScene, thumbnailCamera);
            const thumbnailDataURL = thumbnailCanvas.toDataURL('image/png');

            const item = {
                id: Date.now(),
                letter1: document.getElementById('letter1').value,
                letter2: document.getElementById('letter2').value,
                font1: font1Name,
                font2: font2Name,
                material: document.getElementById('material').value,
                plating: document.getElementById('plating').value,
                finish: document.getElementById('finish').value,
                size: parseInt(document.getElementById('size').value),  // ‚úÖ ËΩâÊèõÁÇ∫Êï¥Êï∏
                volume: document.getElementById('volume-display').textContent,
                weight: document.getElementById('weight-display').textContent,
                quantity: 1,
                // ÂãïÊÖãË®àÁÆóÂÉπÊ†º
                price: (() => {
                    const plating = document.getElementById('plating').value;
                    // Âü∫Á§éÂÉπÊ†ºÔºö925ÈäÄ„ÄÅÈªÉÈäÖÈÉΩÊòØ 3850
                    let basePrice = 3850;
                    // ÊúâÈõªÈççÔºà‰ªª‰ΩïÈõªÈççÔºâ+400
                    if (plating && plating !== 'none') {
                        basePrice += 400;
                    }
                    return basePrice;
                })(),
                // ÂÑ≤Â≠òÂ¢úÈ†≠Áõ∏Â∞çÂêëÈáè
                bailRelativeX: bailRelativeX,
                bailRelativeY: bailRelativeY,
                bailRelativeZ: bailRelativeZ,
                bailRotation: bailRot,
                // ÂÑ≤Â≠òÂ¢úÈ†≠ÁµïÂ∞çÂ∫ßÊ®ôÔºàÁî®ÊñºÂæåÁ´ØÁ≤æÁ¢∫ÂÆö‰ΩçÔºâ
                bailAbsoluteX: bailMesh ? bailMesh.position.x : 0,
                bailAbsoluteY: bailMesh ? bailMesh.position.y : 0,
                bailAbsoluteZ: bailMesh ? bailMesh.position.z : 0,
                // ÂÑ≤Â≠òÂ≠óÊØç BBox ‰ø°ÊÅØÔºàÁî®ÊñºÂæåÁ´ØÁ≤æÁ¢∫Âª∫Ê®°Ôºâ
                letter1BBox: window.letter1BBox || {},
                letter2BBox: window.letter2BBox || {},
                // ‚úÖ ÂÑ≤Â≠òË®≠Ë®àÁêÜÂøµ
                designStory: window.finalDesignStory || '',
                // ‚úÖ ÂÑ≤Â≠òÁ∏ÆÁï•ÂúñÔºàÁî®ÊñºË≥ºÁâ©ËªäÈ†êË¶ΩÔºâ
                thumbnail: thumbnailDataURL,
                // üßπ ÂÑ≤Â≠òÊòØÂê¶ÈúÄË¶ÅÊ∏ÖÁêÜÁ¢éÁâá
                cleanFragments: modelNeedsCleanup,
                // üì∏ ÂÑ≤Â≠ò‰∏âË¶ñÂúñÔºàÁî®Êñº Email ÈôÑ‰ª∂Ôºâ
                threeViews: threeViews
            };

            cartItems.push(item);
            openCart();
        }

        function openCart() {
            document.getElementById('cart-modal').classList.add('active');
            renderCart();
        }

        function closeCart() {
            document.getElementById('cart-modal').classList.remove('active');
        }

        function renderCart() {
            const container = document.getElementById('cart-items');

            if (cartItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.4); padding: 40px;">Your cart is empty</div>';
                document.getElementById('cart-total').textContent = 'NT$ 0';
                return;
            }

            container.innerHTML = '';
            let total = 0;

            cartItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';

                // ‚úÖ ‰ΩøÁî®ÂÑ≤Â≠òÁöÑÁ∏ÆÁï•Âúñ
                if (item.thumbnail) {
                    const img = document.createElement('img');
                    img.src = item.thumbnail;
                    img.className = 'cart-item-image';
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: contain; background: transparent;';
                    div.appendChild(img);
                } else {
                    // ÂÇôÁî®ÔºöÈ°ØÁ§∫‰Ωî‰ΩçÁ¨¶
                    const placeholder = document.createElement('div');
                    placeholder.className = 'cart-item-image';
                    placeholder.style.cssText = 'width: 100px; height: 100px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 40px;';
                    placeholder.textContent = item.letter1 + item.letter2;
                    div.appendChild(placeholder);
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'cart-item-info';
                const platingText = item.plating === 'none' ? 'ÁÑ°ÈõªÈçç' : item.plating;
                const finishText = item.finish === 'glossy' ? '‰∫ÆÈù¢' : 'ÈúßÈù¢';
                infoDiv.innerHTML = `
                    <h3>DUET "${item.letter1}${item.letter2}"</h3>
                    <div class="cart-item-details">
                        "${item.letter1}" in font "${item.font1}"<br>
                        "${item.letter2}" in font "${item.font2}"<br>
                        ÊùêË≥™: ${item.material} | ÈõªÈçç: ${platingText} | Ë≥™Âú∞: ${finishText}<br>
                        Â∞∫ÂØ∏: ${item.size}mm | ÈáçÈáè: ${item.weight}
                    </div>
                `;
                div.appendChild(infoDiv);

                const priceDiv = document.createElement('div');
                priceDiv.className = 'cart-item-price';
                priceDiv.textContent = `NT$ ${(item.price * item.quantity).toLocaleString()}`;
                div.appendChild(priceDiv);

                const quantityDiv = document.createElement('div');
                quantityDiv.className = 'cart-item-quantity';

                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.className = 'quantity-input';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.setAttribute('data-index', index);
                quantityInput.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value) || 1;
                    if (value > 0) {
                        cartItems[index].quantity = value;
                        renderCart();
                    }
                });

                const quantityBtns = document.createElement('div');
                quantityBtns.className = 'quantity-btns';

                const upBtn = document.createElement('button');
                upBtn.className = 'qty-btn';
                upBtn.textContent = '‚ñ≤';
                upBtn.onclick = () => {
                    cartItems[index].quantity++;
                    renderCart();
                };

                const downBtn = document.createElement('button');
                downBtn.className = 'qty-btn';
                downBtn.textContent = '‚ñº';
                downBtn.onclick = () => {
                    if (cartItems[index].quantity > 1) {
                        cartItems[index].quantity--;
                        renderCart();
                    }
                };

                quantityBtns.appendChild(upBtn);
                quantityBtns.appendChild(downBtn);

                quantityDiv.appendChild(quantityInput);
                quantityDiv.appendChild(quantityBtns);
                div.appendChild(quantityDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = () => {
                    cartItems.splice(index, 1);
                    renderCart();
                };
                div.appendChild(deleteBtn);

                container.appendChild(div);
                total += item.price * item.quantity;
            });

            // ÂÑ≤Â≠òÂéüÂßãÁ∏ΩÈáëÈ°ç
            originalTotal = total;

            // Ë®àÁÆóÊäòÊâ£ÂæåÈáëÈ°ç
            const finalTotal = Math.max(0, originalTotal - promoDiscount);

            // Êõ¥Êñ∞È°ØÁ§∫
            updateTotalDisplay(originalTotal, promoDiscount, finalTotal);
        }

        // ============================================================
        // ÂÑ™ÊÉ†Á¢ºÂäüËÉΩ
        // ============================================================

        function updateTotalDisplay(original, discount, final) {
            const totalElement = document.getElementById('cart-total');

            if (discount > 0) {
                // ÊúâÂÑ™ÊÉ†Á¢ºÊôÇÈ°ØÁ§∫Ë©≥Á¥∞Ë≥áË®ä
                totalElement.innerHTML = `
                    <div style="text-align: right;">
                        <div style="font-size: 16px; color: rgba(255,255,255,0.6); text-decoration: line-through; margin-bottom: 5px;">
                            NT$ ${original.toLocaleString()}
                        </div>
                        <div style="font-size: 16px; color: #4CAF50; margin-bottom: 5px;">
                            ÂÑ™ÊÉ†ÊäòÊâ£ -NT$ ${discount.toLocaleString()}
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #d4af37;">
                            NT$ ${final.toLocaleString()}
                        </div>
                    </div>
                `;
            } else {
                // Ê≤íÊúâÂÑ™ÊÉ†Á¢ºÊôÇÊ≠£Â∏∏È°ØÁ§∫
                totalElement.textContent = `NT$ ${final.toLocaleString()}`;
            }
        }

        async function applyPromoCode() {
            const promoInput = document.getElementById('promo-code-input');
            const promoCode = promoInput.value.trim().toUpperCase();
            const promoMessage = document.getElementById('promo-message');
            const applyBtn = document.getElementById('apply-promo-btn');

            console.log('üé´ ÈñãÂßãÂ•óÁî®ÂÑ™ÊÉ†Á¢º:', promoCode);
            console.log('üìä Áï∂ÂâçË≥ºÁâ©ËªäÁ∏ΩÈáëÈ°ç:', originalTotal);

            // Ê∏ÖÈô§‰πãÂâçÁöÑË®äÊÅØ
            promoMessage.innerHTML = '';

            if (!promoCode) {
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÂÑ™ÊÉ†Á¢º</span>';
                return;
            }

            if (cartItems.length === 0) {
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</span>';
                return;
            }

            // È°ØÁ§∫ËºâÂÖ•‰∏≠
            applyBtn.disabled = true;
            applyBtn.textContent = 'È©óË≠â‰∏≠...';

            try {
                console.log('üåê ÂëºÂè´ÂæåÁ´Ø API:', `${BACKEND_URL}/api/validate-promo`);

                // ÂëºÂè´ÂæåÁ´ØÈ©óË≠â API
                const response = await fetch(`${BACKEND_URL}/api/validate-promo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        promoCode: promoCode,
                        total: originalTotal
                    })
                });

                console.log('üì° API ÂõûÊáâÁãÄÊÖã:', response.status);

                const result = await response.json();
                console.log('üì¶ API ÂõûÊáâÂÖßÂÆπ:', result);

                if (result.valid) {
                    // ÂÑ™ÊÉ†Á¢ºÊúâÊïà
                    appliedPromoCode = promoCode;
                    promoDiscount = result.discount;

                    console.log('‚úÖ ÂÑ™ÊÉ†Á¢ºÊúâÊïà!');
                    console.log('üí∞ ÊäòÊâ£ÈáëÈ°ç:', promoDiscount);
                    console.log('üíµ ÊúÄÁµÇÈáëÈ°ç:', originalTotal - promoDiscount);

                    promoMessage.innerHTML = `
                        <div style="color: #4CAF50; display: flex; align-items: center; justify-content: space-between;">
                            <span>‚úÖ ${result.description}</span>
                            <button onclick="removePromoCode()" style="background: none; border: none; color: #ff6b6b; cursor: pointer; font-size: 14px;">
                                ÁßªÈô§
                            </button>
                        </div>
                    `;

                    // Á¶ÅÁî®Ëº∏ÂÖ•Ê°Ü
                    promoInput.disabled = true;
                    applyBtn.disabled = true;
                    applyBtn.textContent = 'Â∑≤Â•óÁî®';

                    // Êõ¥Êñ∞È°ØÁ§∫
                    renderCart();

                    console.log('üéâ ÂÑ™ÊÉ†Á¢ºÂ•óÁî®ÂÆåÊàêÔºåÁï´Èù¢Â∑≤Êõ¥Êñ∞');

                } else {
                    // ÂÑ™ÊÉ†Á¢ºÁÑ°Êïà
                    console.warn('‚ùå ÂÑ™ÊÉ†Á¢ºÁÑ°Êïà:', result.error);
                    promoMessage.innerHTML = `<span style="color: #ff6b6b;">‚ùå ${result.error}</span>`;
                    appliedPromoCode = '';
                    promoDiscount = 0;
                    renderCart();
                }

            } catch (error) {
                console.error('‚ùå ÂÑ™ÊÉ†Á¢ºÈ©óË≠âÈåØË™§:', error);
                promoMessage.innerHTML = '<span style="color: #ff6b6b;">‚ùå È©óË≠âÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶</span>';
                appliedPromoCode = '';
                promoDiscount = 0;
            } finally {
                // ÈáçÁΩÆÊåâÈàï
                applyBtn.disabled = false;
                applyBtn.textContent = 'Â•óÁî®';
            }
        }

        function removePromoCode() {
            appliedPromoCode = '';
            promoDiscount = 0;

            const promoInput = document.getElementById('promo-code-input');
            const promoMessage = document.getElementById('promo-message');
            const applyBtn = document.getElementById('apply-promo-btn');

            promoInput.value = '';
            promoInput.disabled = false;
            applyBtn.disabled = false;
            applyBtn.textContent = 'Â•óÁî®';
            promoMessage.innerHTML = '';

            renderCart();
            console.log('üóëÔ∏è ÂÑ™ÊÉ†Á¢ºÂ∑≤ÁßªÈô§');
        }

        function calculateCartTotal() {
            return originalTotal - promoDiscount;
        }

        async function testModeCheckout() {
            console.log('üß™ Ê∏¨Ë©¶Ê®°ÂºèÔºöÊ®°Êì¨ÊîØ‰ªòÊàêÂäü');

            const mockOrderId = 'TEST_' + Date.now();
            const mockUserInfo = {
                name: 'Ê∏¨Ë©¶Áî®Êà∂',
                email: 'brendon@brendonchen.com',
                phone: '0912345678'
            };

            try {
                console.log('üì§ ÁôºÈÄÅÊ∏¨Ë©¶Ë®ÇÂñÆÂà∞ÂæåÁ´Ø...');

                // ‚úÖ ÊéíÈô§ mesh Âíå bailÔºà3D Áâ©‰ª∂ÔºâÔºåÂè™ÁôºÈÄÅÂøÖË¶ÅË≥áÊñô
                const itemsWithBBox = cartItems.map(item => {
                    // Ëß£ÊßãÊéíÈô§ mesh Âíå bail
                    const { mesh, bail, ...itemData } = item;

                    return {
                        ...itemData,
                        // ‚úÖ Á¢∫‰øùÊâÄÊúâÊï∏ÂÄºÊ¨Ñ‰ΩçÈÉΩÊòØÊï∏Â≠óÈ°ûÂûã
                        size: typeof item.size === 'string' ? parseInt(item.size) : item.size,
                        quantity: typeof item.quantity === 'string' ? parseInt(item.quantity) : item.quantity,
                        price: typeof item.price === 'string' ? parseFloat(item.price) : item.price,
                        bailAbsoluteX: typeof item.bailAbsoluteX === 'string' ? parseFloat(item.bailAbsoluteX) : (item.bailAbsoluteX || 0),
                        bailAbsoluteY: typeof item.bailAbsoluteY === 'string' ? parseFloat(item.bailAbsoluteY) : (item.bailAbsoluteY || 0),
                        bailAbsoluteZ: typeof item.bailAbsoluteZ === 'string' ? parseFloat(item.bailAbsoluteZ) : (item.bailAbsoluteZ || 0),
                        bailRelativeX: typeof item.bailRelativeX === 'string' ? parseFloat(item.bailRelativeX) : (item.bailRelativeX || 0),
                        bailRelativeY: typeof item.bailRelativeY === 'string' ? parseFloat(item.bailRelativeY) : (item.bailRelativeY || 0),
                        bailRelativeZ: typeof item.bailRelativeZ === 'string' ? parseFloat(item.bailRelativeZ) : (item.bailRelativeZ || 0),
                        bailRotation: typeof item.bailRotation === 'string' ? parseFloat(item.bailRotation) : (item.bailRotation || 0),
                        letter1BBox: item.letter1BBox || { width: 10, height: 12, depth: 5, offsetX: 0, offsetY: 0, offsetZ: 0 },
                        letter2BBox: item.letter2BBox || { width: 10, height: 12, depth: 5, offsetX: 0, offsetY: 0, offsetZ: 0 }
                    };
                });

                console.log('üì¶ Ë®ÇÂñÆË≥áÊñô:', { orderId: mockOrderId, items: itemsWithBBox, total: calculateCartTotal() });

                const response = await fetch(`${BACKEND_URL}/api/test-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: mockOrderId,
                        items: itemsWithBBox,
                        userInfo: mockUserInfo,
                        total: originalTotal,           // ÂÇ≥ÈÄÅÂéüÂßãÈáëÈ°ç
                        promoCode: appliedPromoCode,    // ÂÇ≥ÈÄÅÂÑ™ÊÉ†Á¢º
                        testMode: true
                    })
                });

                console.log('üì• Êî∂Âà∞ÂõûÊáâ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå ÂæåÁ´ØÈåØË™§:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('‚úÖ ÂæåÁ´ØÂõûÊáâ:', result);

                if (result.success) {
                    cartItems = [];
                    renderCart();
                    closeCart();
                    showSuccessModal();
                    console.log('‚úÖ Ê∏¨Ë©¶Ë®ÇÂñÆÂÆåÊàêÔºÅ');
                } else {
                    alert('‚ùå Ê∏¨Ë©¶Â§±ÊïóÔºö' + (result.error || 'Êú™Áü•ÈåØË™§'));
                }

            } catch (error) {
                console.error('‚ùå Ê∏¨Ë©¶Ê®°ÂºèÈåØË™§:', error);
                alert('‚ùå ÈÄ£Êé•ÂæåÁ´ØÂ§±ÊïóÔºö\n\n' + error.message + '\n\nË´ãÊü•Áúã Console ‰∫ÜËß£Ë©≥ÊÉÖ');
            }
        }

        // ============================================================
        // Ë®≠Ë®àÁêÜÂøµÊî∂ÈõÜÊµÅÁ®ãÔºàÊñ∞Â¢ûÂà∞ duet-frontendÔºâ
        // ‰ΩçÁΩÆÔºöÂú® showSuccessModal() ‰πãÂæå
        // ============================================================

        // ‰øÆÊîπ showSuccessModal ÂáΩÊï∏
        function showSuccessModal() {
            // ÁßªÈô§ËàäÁöÑÂΩàÁ™ó
            const oldModal = document.getElementById('success-modal');
            if (oldModal) {
                oldModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'success-modal';
            modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999;
    `;

            const content = document.createElement('div');
            content.style.cssText = `
        max-width: 360px;
        padding: 30px 35px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px) saturate(150%);
        -webkit-backdrop-filter: blur(20px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
        text-align: center;
    `;

            content.innerHTML = `
        <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 20px; font-weight: 500; letter-spacing: 0.5px;">
            ÁµêÂ∏≥ÂÆåÊàê
        </h3>
        <p style="margin: 0 0 24px 0; color: rgba(255, 255, 255, 0.7); font-size: 14px; line-height: 1.5;">
            ÊÑüË¨ùÊÇ®ÁöÑË®ÇË≥º<br>Á¢∫Ë™ç‰ø°Â∑≤ÁôºÈÄÅËá≥‰ø°ÁÆ±
        </p>
    `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // 3 ÁßíÂæåÈóúÈñâ‰∏¶ÈñãÂßãÊî∂ÈõÜË®≠Ë®àÁêÜÂøµ
            setTimeout(() => {
                modal.remove();
                collectDesignStories();
            }, 3000);
        }

        // ÂéªÈáçÈÇèËºØ
        function getUniqueDesignCombinations(items) {
            const combinations = new Map();

            items.forEach(item => {
                const key = `${item.letter1}-${item.font1}-${item.letter2}-${item.font2}`;

                if (!combinations.has(key)) {
                    combinations.set(key, {
                        letters: { letter1: item.letter1, letter2: item.letter2 },
                        fonts: { font1: item.font1, font2: item.font2 },
                        itemIds: [item.id],
                        thumbnail: item.thumbnail
                    });
                } else {
                    combinations.get(key).itemIds.push(item.id);
                }
            });

            return Array.from(combinations.values());
        }

        // ‰∏ªÊµÅÁ®ãÔºöÊî∂ÈõÜË®≠Ë®àÁêÜÂøµ
        async function collectDesignStories() {
            // ‰ΩøÁî® window.cartItemsÔºà‰ªòÊ¨æÂæåÂæûÂæåÁ´ØËºâÂÖ•ÁöÑÔºâ
            const items = window.cartItems || [];

            if (items.length === 0) {
                console.error('‚ùå Ê≤íÊúâË≥ºÁâ©ËªäË≥áÊñô');
                showNotification('ÁÑ°Ê≥ïËºâÂÖ•Ë®ÇÂñÆÂïÜÂìÅ', 'error');
                return;
            }

            const combinations = getUniqueDesignCombinations(items);

            console.log(`üìù ÈúÄË¶ÅÊî∂ÈõÜ ${combinations.length} ÂÄãË®≠Ë®àÁêÜÂøµ`);

            const concepts = [];

            // ÈÄê‰∏ÄË©¢ÂïèÂ≠óÈ´îÂéüÂõ†‰∏¶ÁîüÊàêË®≠Ë®àÁêÜÂøµ
            for (let i = 0; i < combinations.length; i++) {
                const fontReason = await askFontReason(combinations[i], i, combinations.length);

                if (fontReason) {
                    // È°ØÁ§∫Ë®≠Ë®àÁêÜÂøµÁîüÊàêÊèêÁ§∫
                    showDesignStoryGeneratingIndicator();

                    const designStory = await generateDesignStory(combinations[i], fontReason);

                    // Èö±ËóèÊèêÁ§∫
                    hideDesignStoryGeneratingIndicator();

                    if (designStory) {
                        concepts.push({
                            letters: combinations[i].letters,
                            fonts: combinations[i].fonts,
                            itemIds: combinations[i].itemIds,
                            thumbnail: combinations[i].thumbnail,
                            designStory: designStory
                        });
                    }
                }
            }

            // ÂÑ≤Â≠òÂà∞ localStorage
            localStorage.setItem('duet_design_concepts', JSON.stringify({
                orderId: window.lastOrderId || 'DUET' + Date.now(),
                concepts: concepts
            }));

            // È°ØÁ§∫Ë®≠Ë®àÁêÜÂøµÊòé‰ø°ÁâáÂç°ÁâáÔºà‰∏çË∑≥ËΩâÔºâ
            if (concepts.length > 0) {
                showDesignStoryCard(concepts[0].designStory);
            } else {
                console.error('‚ùå Ê≤íÊúâË®≠Ë®àÁêÜÂøµÂèØÈ°ØÁ§∫');
            }
        }

        // È°ØÁ§∫Ë®≠Ë®àÁêÜÂøµÊòé‰ø°ÁâáÂç°Áâá
        // È°ØÁ§∫Ë®≠Ë®àÁêÜÂøµÁîüÊàêÊèêÁ§∫
        function showDesignStoryGeneratingIndicator() {
            // ÂâµÂª∫ÂÖ®Ëû¢ÂπïÈÅÆÁΩ©
            const overlay = document.createElement('div');
            overlay.id = 'design-story-generating-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            overlay.innerHTML = `
                <div style="
                    text-align: center;
                    color: rgba(212, 175, 55, 0.9);
                    font-size: 14px;
                ">
                    <div style="font-size: 32px; margin-bottom: 15px;">‚úçÔ∏è</div>
                    <div>Ê≠£Âú®ÁÇ∫ÊÇ®Êí∞ÂØ´Ë®≠Ë®àÁêÜÂøµ<span class="dots-animation"></span></div>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        // Èö±ËóèË®≠Ë®àÁêÜÂøµÁîüÊàêÊèêÁ§∫
        function hideDesignStoryGeneratingIndicator() {
            const overlay = document.getElementById('design-story-generating-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showDesignStoryCard(designStory) {
            const modal = document.getElementById('design-story-modal');
            const content = document.getElementById('story-content');

            // Â∞áË®≠Ë®àÁêÜÂøµÊñáÂ≠óËΩâÊèõÁÇ∫ HTMLÔºà‰øùÁïôÊèõË°åÔºâ
            const formattedStory = designStory.replace(/\n/g, '<br>');
            content.innerHTML = formattedStory;

            // ÂàùÂßãÂåñÊôÇ‰πüÂÑ≤Â≠òË®≠Ë®àÁêÜÂøµ
            window.finalDesignStory = designStory;

            // È°ØÁ§∫ Modal
            modal.style.display = 'flex';

            console.log('‚úÖ Ë®≠Ë®àÁêÜÂøµÂç°ÁâáÂ∑≤È°ØÁ§∫');
        }

        // Ë©¢ÂïèÂ≠óÈ´îÂéüÂõ†
        function askFontReason(combination, index, total) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.id = 'font-reason-modal';
                modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

                modal.innerHTML = `
            <div style="background: #1a1a2e; padding: 40px; border-radius: 20px;
                        max-width: 600px; width: 90%;">
                
                <div style="text-align: center; color: rgba(255,255,255,0.5); 
                            font-size: 13px; margin-bottom: 20px;">
                    ${index + 1} / ${total}
                </div>
                
                <h2 style="color: #d4af37; text-align: center; margin-bottom: 30px;">
                    ‚ú® ÂàÜ‰∫´ÊÇ®ÁöÑË®≠Ë®àÁêÜÂøµ
                </h2>
                
                <!-- Â≠óÈ´îÈ†êË¶Ω -->
                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; 
                                border-radius: 16px; text-align: center; flex: 1;">
                        <div style="font-size: 72px; font-family: '${combination.fonts.font1}', serif; 
                                    color: #d4af37; margin-bottom: 15px;">
                            ${combination.letters.letter1}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">
                            Â≠óÊØç "${combination.letters.letter1}"
                        </div>
                        <div style="color: #d4af37; font-size: 12px;">
                            ${combination.fonts.font1}
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 30px; 
                                border-radius: 16px; text-align: center; flex: 1;">
                        <div style="font-size: 72px; font-family: '${combination.fonts.font2}', serif; 
                                    color: #d4af37; margin-bottom: 15px;">
                            ${combination.letters.letter2}
                        </div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">
                            Â≠óÊØç "${combination.letters.letter2}"
                        </div>
                        <div style="color: #d4af37; font-size: 12px;">
                            ${combination.fonts.font2}
                        </div>
                    </div>
                </div>
                
                <!-- AI ÂïèÈ°å -->
                <div style="background: rgba(212,175,55,0.1); padding: 20px; 
                            border-radius: 12px; margin-bottom: 20px;
                            border-left: 3px solid #d4af37;">
                    <div style="color: rgba(255,255,255,0.9); font-size: 15px; line-height: 1.6;">
                        ÂèØ‰ª•ÂàÜ‰∫´‰∏Ä‰∏ãÈÅ∏ÊìáÈÄôÂÖ©ÂÄãÂ≠óÈ´îÁöÑÂéüÂõ†ÂóéÔºü
                    </div>
                </div>
                
                <textarea id="font-reason-input" 
                          placeholder="ÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï..."
                          style="width: 100%; height: 120px; padding: 15px; 
                                 background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
                                 color: white; border-radius: 12px; font-size: 14px; resize: vertical;
                                 font-family: inherit; margin-bottom: 20px;"></textarea>
                
                <div style="display: flex; gap: 12px;">
                    <button id="submit-reason-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #d4af37, #aa8a2e);
                                   color: #000; border: none; border-radius: 12px; font-size: 14px; font-weight: 600;
                                   cursor: pointer;">
                        ÈÄÅÂá∫
                    </button>
                    <button id="skip-reason-btn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08);
                                   border: 1px solid rgba(255,255,255,0.2); color: #fff; border-radius: 12px;
                                   font-size: 14px; font-weight: 600; cursor: pointer;">
                        Ë∑≥ÈÅé
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(modal);

                // ÈÄÅÂá∫ÊåâÈàï
                document.getElementById('submit-reason-btn').onclick = () => {
                    const reason = document.getElementById('font-reason-input').value.trim();

                    if (!reason) {
                        alert('Ë´ãÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï');
                        return;
                    }

                    modal.remove();
                    resolve(reason);
                };

                // Ë∑≥ÈÅéÊåâÈàï
                document.getElementById('skip-reason-btn').onclick = () => {
                    modal.remove();
                    resolve('');  // Á©∫Â≠ó‰∏≤‰ª£Ë°®Ë∑≥ÈÅé
                };
            });
        }

        // ÂëºÂè´ÂæåÁ´ØÁîüÊàêË®≠Ë®àÁêÜÂøµ
        async function generateDesignStory(combination, fontReason) {
            try {
                // ÂÑ™ÂÖà‰ΩøÁî®‰ªòÊ¨æÂæåÂæûÂæåÁ´ØËºâÂÖ•ÁöÑ AI Ë´ÆË©¢Ë≥áÊñô
                let aiData = window.aiConsultationData;

                // Â¶ÇÊûúÊ≤íÊúâÔºà‰æãÂ¶ÇÊ∏¨Ë©¶Ê®°ÂºèÔºâÔºåÊâçÂæû localStorage ÂèñÂæó
                if (!aiData) {
                    const aiDataStr = localStorage.getItem('duet_ai_consultation');
                    if (aiDataStr) {
                        aiData = JSON.parse(aiDataStr);
                    }
                }

                if (!aiData) {
                    console.warn('‚ö†Ô∏è ÁÑ° AI Ë´ÆË©¢Ë≥áÊñôÔºå‰ΩøÁî®È†êË®≠Ê†ºÂºè');
                    return `ÈÄôÂÄã DUET ‰ΩúÂìÅ‰∫§Áπî‰∫Ü ${combination.letters.letter1} Âíå ${combination.letters.letter2} ÂÖ©ÂÄãÂ≠óÊØç„ÄÇ\n\n${fontReason}`;
                }

                const conversationSummary = aiData.conversationSummary || aiData;

                const response = await fetch(`${BACKEND_URL}/api/design-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationSummary: conversationSummary,
                        selectedFonts: {
                            letter1: combination.letters.letter1,
                            font1: combination.fonts.font1,
                            letter2: combination.letters.letter2,
                            font2: combination.fonts.font2
                        },
                        fontReason: fontReason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ Ë®≠Ë®àÁêÜÂøµÁîüÊàêÊàêÂäü');
                    let story = result.designStory;

                    // Ê∏ÖÁêÜ JSON Ê®ôË®òÂíåÂ§öÈ§òÂÖßÂÆπ
                    story = story
                        .replace(/```json\s*/gi, '')
                        .replace(/```\s*/g, '')
                        .replace(/^\s*{\s*"designStory":\s*"/i, '')
                        .replace(/"\s*}\s*$/i, '')
                        .replace(/^["'\s]+|["'\s]+$/g, '')
                        .trim();

                    // ÂâçÁ´ØÂÆâÂÖ®Á∂≤ÔºöÁ¢∫‰øù‰∏çË∂ÖÈÅé 250 Â≠ó
                    if (story.length > 250) {
                        console.warn('‚ö†Ô∏è Ë®≠Ë®àÁêÜÂøµË∂ÖÈÅé 250 Â≠óÔºåËá™ÂãïÊà™Êñ∑');
                        story = story.substring(0, 247) + '...';
                    }

                    return story;
                } else {
                    console.error('‚ùå Ë®≠Ë®àÁêÜÂøµÁîüÊàêÂ§±Êïó:', result.error);
                    // ÂõûÂÇ≥È†êË®≠Ê†ºÂºè
                    return `ÈÄôÂÄã DUET ‰ΩúÂìÅ‰∫§Áπî‰∫Ü ${combination.letters.letter1} Âíå ${combination.letters.letter2} ÂÖ©ÂÄãÂ≠óÊØç„ÄÇ\n\n${fontReason}`;
                }

            } catch (error) {
                console.error('‚ùå Ë®≠Ë®àÁêÜÂøµÁîüÊàêÈåØË™§:', error);
                // ÂõûÂÇ≥È†êË®≠Ê†ºÂºè
                return `ÈÄôÂÄã DUET ‰ΩúÂìÅ‰∫§Áπî‰∫Ü ${combination.letters.letter1} Âíå ${combination.letters.letter2} ÂÖ©ÂÄãÂ≠óÊØç„ÄÇ\n\n${fontReason}`;
            }
        }

        // Â∞á lastOrderId Ë®≠ÁÇ∫ÂÖ®ÂüüËÆäÊï∏ÔºàÂú® processPayment ‰∏≠Ë®≠ÂÆöÔºâ
        window.lastOrderId = null;

        // ‰∏ªÁµêÂ∏≥ÂáΩÊï∏ÔºàÊ†πÊìöÊ∏¨Ë©¶Ê®°ÂºèÊ±∫ÂÆöÊµÅÁ®ãÔºâ
        function checkout() {
            // Ê™¢Êü•ÊòØÂê¶ÊúâÁ∂ìÈÅé AI Ë´ÆË©¢
            const aiDataStr = localStorage.getItem('duet_ai_consultation');
            const hasAIConsultation = aiDataStr && aiDataStr !== 'null';

            if (hasAIConsultation) {
                // È°ØÁ§∫ÊèêÈÜíÂΩàÁ™ó
                showCheckoutReminder();
            } else {
                // Ê≤íÊúâ AI Ë´ÆË©¢ÔºåÁõ¥Êé•ÁµêÂ∏≥
                if (TESTING_MODE) {
                    testModeCheckout();
                } else {
                    processPayment();
                }
            }
        }

        // È°ØÁ§∫ÁµêÂ∏≥ÊèêÈÜíÂΩàÁ™ó
        function showCheckoutReminder() {
            const modal = document.getElementById('checkout-reminder-modal');
            modal.style.display = 'flex';

            // Á∂ÅÂÆöÊåâÈàï‰∫ã‰ª∂ÔºàÂè™Á∂ÅÂÆö‰∏ÄÊ¨°Ôºâ
            const btn = document.getElementById('proceed-to-checkout-btn');
            btn.onclick = function () {
                modal.style.display = 'none';
                if (TESTING_MODE) {
                    testModeCheckout();
                } else {
                    processPayment();
                }
            };
        }

        // Ê≠£Â∏∏ÊîØ‰ªòÊµÅÁ®ã
        async function processPayment() {
            console.log('üí≥ ÈñãÂßãÊîØ‰ªòÊµÅÁ®ã...');

            // Êî∂ÈõÜÁî®Êà∂Ë≥áË®ä
            console.log('üìù Á≠âÂæÖÁî®Êà∂Â°´ÂØ´Ë≥áË®ä...');
            const userInfo = await getUserInfo();
            console.log('‚úÖ Áî®Êà∂Ë≥áË®äÊî∂ÈõÜÂÆåÊàê:', userInfo ? 'ÊàêÂäü' : 'Â∑≤ÂèñÊ∂à');

            if (!userInfo) {
                console.warn('‚ö†Ô∏è Áî®Êà∂ÂèñÊ∂àÂ°´ÂØ´Ë≥áË®ä');
                return; // Áî®Êà∂ÂèñÊ∂à
            }

            const orderId = 'DUET' + Date.now();
            console.log('üî¢ Ë®ÇÂñÆID:', orderId);
            console.log('üì¶ Ë≥ºÁâ©ËªäÂïÜÂìÅ:', cartItems);
            console.log('üí∞ ÂéüÂßãÈáëÈ°ç:', originalTotal);
            console.log('üé´ ÂÑ™ÊÉ†Á¢º:', appliedPromoCode || 'ÁÑ°');

            try {
                // ÂèñÂæó AI Ë´ÆË©¢Ë≥áÊñôÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                const aiDataStr = localStorage.getItem('duet_ai_consultation');
                const aiData = aiDataStr ? JSON.parse(aiDataStr) : null;

                // ÂëºÂè´ÂæåÁ´ØÂàùÂßãÂåñÊîØ‰ªò
                console.log('üåê ÂëºÂè´ÂæåÁ´Ø API:', `${BACKEND_URL}/api/checkout`);
                console.log('üí∞ DEBUG - originalTotal:', originalTotal, 'type:', typeof originalTotal);
                console.log('üé´ DEBUG - appliedPromoCode:', appliedPromoCode);

                // Á¢∫‰øù total ÊòØÊï∏Â≠ó
                const totalAmount = Number(originalTotal);
                if (isNaN(totalAmount) || totalAmount < 1) {
                    alert('‚ùå Ë®ÇÂñÆÈáëÈ°çÈåØË™§ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÂæåÂÜçË©¶');
                    return;
                }

                const response = await fetch(`${BACKEND_URL}/api/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        items: cartItems,
                        userInfo: userInfo,
                        total: totalAmount,             // Á¢∫‰øùÊòØÊï∏Â≠ó
                        promoCode: appliedPromoCode,    // ÂÇ≥ÈÄÅÂÑ™ÊÉ†Á¢º
                        aiConsultation: aiData,         // ‚úÖ Êñ∞Â¢ûÔºöAI Ë´ÆË©¢Ë≥áÊñô
                        returnUrl: window.location.origin + '/payment-success.html'
                    })
                });

                console.log('üì° API ÂõûÊáâÁãÄÊÖã:', response.status);
                const result = await response.json();
                console.log('üì¶ API ÂõûÊáâÂÖßÂÆπ:', result);

                if (result.success) {
                    console.log('‚úÖ ÁµêÂ∏≥ÊàêÂäü');

                    // ‚úÖ Ê™¢Êü•ÊòØÂê¶ÁÇ∫ VIP ÂÖçË≤ªË®ÇÂñÆ
                    if (result.vipFree) {
                        console.log('üéÅ VIP ÂÖçË≤ªË®ÇÂñÆÂ∑≤Á¢∫Ë™ç');
                        
                        // Ê†πÊìöÊòØÂê¶Êúâ AI consultation Ê±∫ÂÆöË∑≥ËΩâ
                        if (result.hasAiConsultation) {
                            // Êúâ AI consultationÔºöË∑≥ËΩâÂà∞ design-studio ÁπºÁ∫åÂ°´ÂØ´Ë®≠Ë®àÁêÜÂøµ
                            showNotification('VIP ÂÖçË≤ªË®ÇÂñÆÂ∑≤Á¢∫Ë™çÔºÅÊ≠£Âú®ÁÇ∫ÊÇ®Ê∫ñÂÇôË´ÆË©¢ÊúçÂãô...', 'success');
                            setTimeout(() => {
                                window.location.href = `https://duet.brendonchen.com/design-studio?payment_success=true&order=${result.orderId}`;
                            }, 2000);  // ÊîπÊàê 2 ÁßíÔºåËÆìÁî®Êà∂ÁúãÂà∞ÈÄöÁü•
                        } else {
                            // Ê≤íÊúâ AI consultationÔºöÈ°ØÁ§∫ÊÑüË¨ùË®äÊÅØÂæåË∑≥ËΩâÂõûÈ¶ñÈ†Å
                            showNotification('Ë®ÇÂñÆÂ∑≤Á¢∫Ë™çÔºÅÊÑüË¨ùÊÇ®ÁöÑË®ÇË≥º', 'success');
                            setTimeout(() => {
                                window.location.href = 'https://www.brendonchen.com';
                            }, 2000);
                        }
                        return; // ‚úÖ ÈáçË¶ÅÔºöÁõ¥Êé•ËøîÂõûÔºå‰∏çÂü∑Ë°åÂæåÈù¢ÁöÑ‰ª£Á¢º
                    }

                    // Ê≠£Â∏∏‰ªòÊ¨æÊµÅÁ®ã
                    console.log('Ê∫ñÂÇôÈ°ØÁ§∫Á∂†ÁïåË°®ÂñÆ');

                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁâπÊÆäÈáëÈ°çÁãÄÊ≥ÅÔºàÂÑ™ÊÉ†Âæå ‚â§ 0Ôºâ
                    if (result.specialAmountCase) {
                        console.log('‚ö†Ô∏è ÁâπÊÆäÁãÄÊ≥ÅÔºöÂÑ™ÊÉ†ÂæåÈáëÈ°çÁÇ∫ 0ÔºåÈúÄÁî®Êà∂Á¢∫Ë™ç');

                        // È°ØÁ§∫Ë™™ÊòéÂΩàÁ™ó
                        const confirmed = await showSpecialAmountModal(result.originalTotal, result.discount);

                        if (!confirmed) {
                            console.log('‚ùå Áî®Êà∂ÂèñÊ∂àÁµêÂ∏≥');
                            return;
                        }
                    }

                    // È°ØÁ§∫Á∂†ÁïåÊîØ‰ªòË°®ÂñÆ
                    displayPaymentForm(result.paymentFormHTML);
                } else {
                    console.error('‚ùå ÁµêÂ∏≥Â§±Êïó:', result.error);
                    alert('‚ùå ÁµêÂ∏≥Â§±ÊïóÔºö' + result.error);
                }

            } catch (error) {
                console.error('‚ùå ÊîØ‰ªòÈåØË™§:', error);
                console.error('ÈåØË™§Ë©≥ÊÉÖ:', {
                    message: error.message,
                    stack: error.stack
                });
                alert('‚ùå ÊîØ‰ªòÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö' + error.message);
            }
        }

        // Êî∂ÈõÜÁî®Êà∂Ë≥áË®ä
        async function getUserInfo() {
            return new Promise((resolve) => {
                // ÂâµÂª∫Ë°®ÂñÆ modal
                const modal = document.createElement('div');
                modal.id = 'user-info-modal';
                modal.className = 'modal active';
                // Ë®≠ÂÆö z-index Á¢∫‰øùË°®ÂñÆÂú®ÊúÄ‰∏äÂ±§
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px !important; width: 90%; max-height: 90vh; overflow-y: auto; background: #1a1a2e; padding: 50px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                        <h2 style="margin-bottom: 20px; color: #d4af37;">Â°´ÂØ´Ë®ÇË≥ºË≥áË®ä</h2>
                        ${appliedPromoCode ? `
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #4CAF50; font-size: 14px;">
                                <span>‚úÖ</span>
                                <span>Â∑≤Â•óÁî®ÂÑ™ÊÉ†Á¢ºÔºö<strong>${appliedPromoCode}</strong></span>
                            </div>
                            <div style="margin-top: 5px; font-size: 13px; color: rgba(255,255,255,0.6);">
                                ÊäòÊâ£ NT$ ${promoDiscount.toLocaleString()}
                            </div>
                        </div>
                        ` : ''}
                        <form id="user-info-form">
                            <!-- Ë≥ºË≤∑‰∫∫Ë≥áË®ä -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">Ë≥ºË≤∑‰∫∫Ë≥áË®ä</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Ë≥ºË≤∑‰∫∫ÂßìÂêç *</label>
                                    <input type="text" id="buyer-name" required 
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Email *</label>
                                    <input type="email" id="buyer-email" required
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">ÊâãÊ©üËôüÁ¢º *</label>
                                    <input type="tel" id="buyer-phone" required pattern="[0-9]{10}"
                                           placeholder="0912345678"
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                            </div>
                            
                            <!-- Êî∂‰ª∂‰∫∫Ë≥áË®ä -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">Êî∂‰ª∂‰∫∫Ë≥áË®ä</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                        <input type="checkbox" id="same-as-buyer" 
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleRecipientFields(this.checked)">
                                        <label for="same-as-buyer" style="cursor: pointer; font-size: 13px; color: rgba(255,255,255,0.7);">
                                            ÂêåË≥ºË≤∑‰∫∫
                                        </label>
                                    </div>
                                    
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Êî∂‰ª∂‰∫∫ÂßìÂêç *</label>
                                    <input type="text" id="recipient-name" required 
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Êî∂‰ª∂‰∫∫ÊâãÊ©ü *</label>
                                    <input type="tel" id="recipient-phone" required pattern="[0-9]{10}"
                                           placeholder="0912345678"
                                           style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                            </div>
                            
                            <!-- Êî∂Ë≤®Âú∞ÂùÄ -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">Êî∂Ë≤®Âú∞ÂùÄ</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">ÈÉµÈÅûÂçÄËôü</label>
                                    <input type="text" id="postal-code" pattern="[0-9]{3,5}"
                                           placeholder="‰æãÔºö100"
                                           style="width: 120px; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                  background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Êî∂Ë≤®Âú∞ÂùÄ *</label>
                                    <textarea id="shipping-address" required rows="3"
                                              placeholder="Ë´ãÂ°´ÂØ´ÂÆåÊï¥Êî∂Ë≤®Âú∞ÂùÄÔºàÁ∏£Â∏Ç„ÄÅÈÑâÈéÆÂçÄ„ÄÅË∑ØË°óÂ∑∑ÂºÑËôüÔºâ"
                                              style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                     background: rgba(255,255,255,0.1); color: white; border-radius: 5px; 
                                                     resize: vertical; font-family: inherit;"></textarea>
                                </div>
                            </div>
                            
                            <!-- ÁôºÁ•®Ë≥áË®ä -->
                            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <h3 style="color: #d4af37; font-size: 16px; margin-bottom: 15px;">ÁôºÁ•®Ë≥áË®ä</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="invoice-type" value="personal" checked
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleInvoiceFields(false)">
                                        <span style="color: rgba(255,255,255,0.8);">ÂÄã‰∫∫ÁôºÁ•®Ôºà‰∫åËÅØÂºèÔºâ</span>
                                    </label>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="radio" name="invoice-type" value="company"
                                               style="width: 16px; height: 16px; cursor: pointer;"
                                               onchange="toggleInvoiceFields(true)">
                                        <span style="color: rgba(255,255,255,0.8);">ÂÖ¨Âè∏ÁôºÁ•®Ôºà‰∏âËÅØÂºèÔºâ</span>
                                    </label>
                                </div>
                                
                                <div id="company-invoice-fields" style="display: none;">
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">Áµ±‰∏ÄÁ∑®Ëôü *</label>
                                        <input type="text" id="company-tax-id" pattern="[0-9]{8}"
                                               placeholder="8‰ΩçÊï∏Â≠ó"
                                               style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">ÂÖ¨Âè∏Êä¨È†≠ *</label>
                                        <input type="text" id="company-name"
                                               placeholder="ÂÖ¨Âè∏ÂêçÁ®±"
                                               style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                      background: rgba(255,255,255,0.1); color: white; border-radius: 5px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ÂÇôË®ª -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; color: rgba(255,255,255,0.8);">ÂÇôË®ª</label>
                                <textarea id="order-note" rows="3"
                                          placeholder="Êúâ‰ªª‰ΩïÁâπÊÆäÈúÄÊ±ÇÊàñÂÇôË®ªÔºåË´ãÂú®Ê≠§Â°´ÂØ´"
                                          style="width: 100%; padding: 10px; border: 1px solid rgba(255,255,255,0.2); 
                                                 background: rgba(255,255,255,0.1); color: white; border-radius: 5px; 
                                                 resize: vertical; font-family: inherit;"></textarea>
                            </div>
                            
                            <!-- ÈáëÈ°çÊëòË¶Å -->
                            <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 10px;">Ë®ÇÂñÆÈáëÈ°çÔºö</div>
                                ${promoDiscount > 0 ? `
                                <div style="display: flex; justify-content: space-between; font-size: 14px; color: rgba(255,255,255,0.5); text-decoration: line-through; margin-bottom: 5px;">
                                    <span>ÂéüÂÉπ</span>
                                    <span>NT$ ${originalTotal.toLocaleString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 14px; color: #4CAF50; margin-bottom: 5px;">
                                    <span>ÂÑ™ÊÉ†ÊäòÊâ£</span>
                                    <span>-NT$ ${promoDiscount.toLocaleString()}</span>
                                </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; color: #d4af37; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <span>Êáâ‰ªòÈáëÈ°ç</span>
                                    <span>NT$ ${calculateCartTotal().toLocaleString()}</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn" style="flex: 1;">
                                    ÁπºÁ∫å‰ªòÊ¨æ
                                </button>
                                <button type="button" class="btn" style="flex: 1; background: rgba(255,255,255,0.1);" 
                                        onclick="document.getElementById('user-info-modal').remove();">
                                    ÂèñÊ∂à
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // „ÄåÂêåË≥ºË≤∑‰∫∫„Äçcheckbox ËôïÁêÜ
                window.toggleRecipientFields = function (isSame) {
                    if (isSame) {
                        document.getElementById('recipient-name').value = document.getElementById('buyer-name').value;
                        document.getElementById('recipient-phone').value = document.getElementById('buyer-phone').value;
                        document.getElementById('recipient-name').disabled = true;
                        document.getElementById('recipient-phone').disabled = true;
                    } else {
                        document.getElementById('recipient-name').disabled = false;
                        document.getElementById('recipient-phone').disabled = false;
                    }
                };

                // Ë≥ºË≤∑‰∫∫Ê¨Ñ‰ΩçËÆäÂåñÊôÇËá™ÂãïÂêåÊ≠•ÔºàÂ¶ÇÊûúÂ∑≤ÂãæÈÅ∏Ôºâ
                ['buyer-name', 'buyer-phone'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        if (document.getElementById('same-as-buyer').checked) {
                            toggleRecipientFields(true);
                        }
                    });
                });

                // ÁôºÁ•®È°ûÂûãÂàáÊèõËôïÁêÜ
                window.toggleInvoiceFields = function (isCompany) {
                    const fields = document.getElementById('company-invoice-fields');
                    const taxId = document.getElementById('company-tax-id');
                    const companyName = document.getElementById('company-name');

                    if (isCompany) {
                        fields.style.display = 'block';
                        taxId.required = true;
                        companyName.required = true;
                    } else {
                        fields.style.display = 'none';
                        taxId.required = false;
                        companyName.required = false;
                    }
                };

                // ËôïÁêÜË°®ÂñÆÊèê‰∫§
                document.getElementById('user-info-form').addEventListener('submit', (e) => {
                    e.preventDefault();

                    const invoiceType = document.querySelector('input[name="invoice-type"]:checked').value;

                    const userInfo = {
                        // Ë≥ºË≤∑‰∫∫Ë≥áË®ä
                        buyerName: document.getElementById('buyer-name').value.trim(),
                        buyerEmail: document.getElementById('buyer-email').value.trim(),
                        buyerPhone: document.getElementById('buyer-phone').value.trim(),

                        // Êî∂‰ª∂‰∫∫Ë≥áË®ä
                        recipientName: document.getElementById('recipient-name').value.trim(),
                        recipientPhone: document.getElementById('recipient-phone').value.trim(),

                        // Êî∂Ë≤®Âú∞ÂùÄ
                        postalCode: document.getElementById('postal-code').value.trim(),
                        shippingAddress: document.getElementById('shipping-address').value.trim(),

                        // ÁôºÁ•®Ë≥áË®ä
                        invoiceType: invoiceType,
                        companyTaxId: invoiceType === 'company' ? document.getElementById('company-tax-id').value.trim() : '',
                        companyName: invoiceType === 'company' ? document.getElementById('company-name').value.trim() : '',

                        // ÂÇôË®ª
                        note: document.getElementById('order-note').value.trim(),

                        // ÁÇ∫‰∫ÜÂêëÂæåÂÖºÂÆπÔºå‰øùÁïôËàäÁöÑÊ¨Ñ‰ΩçÂêçÁ®±
                        name: document.getElementById('recipient-name').value.trim(),
                        email: document.getElementById('buyer-email').value.trim(),
                        phone: document.getElementById('recipient-phone').value.trim(),
                        address: document.getElementById('shipping-address').value.trim()
                    };

                    // ‚úÖ ‰∏çÁßªÈô§ modalÔºåÊîπÊàêÈö±ËóèË°®ÂñÆ‰∏¶È°ØÁ§∫ loading
                    modal.querySelector('.modal-content').style.display = 'none';
                    
                    // È°ØÁ§∫ loading ÊèêÁ§∫
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: rgba(255,255,255,0.9);
                    `;
                    loadingDiv.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                        <div style="font-size: 16px; font-weight: 500;">Ê≠£Âú®ËôïÁêÜË®ÇÂñÆ...</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.6); margin-top: 10px;">Ë´ãÁ®çÂÄôÔºåÂç≥Â∞áË∑≥ËΩâËá≥‰ªòÊ¨æÈ†ÅÈù¢</div>
                    `;
                    modal.appendChild(loadingDiv);
                    
                    // ÂÑ≤Â≠ò modal ÂºïÁî®Ôºå‰æõÂæåÁ∫åÁßªÈô§
                    window.userInfoModal = modal;
                    
                    resolve(userInfo);
                });
            });
        }

        // È°ØÁ§∫Á∂†ÁïåÊîØ‰ªòË°®ÂñÆ
        // ‰ªòÊ¨æÂÆåÊàêË®äÊÅØÂΩàÁ™ó
        function showPaymentCompleteModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(20px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            modal.innerHTML = `
                <div style="
                    background: rgba(255, 255, 255, 0.08);
                    backdrop-filter: blur(40px) saturate(180%);
                    -webkit-backdrop-filter: blur(40px) saturate(180%);
                    border: 1px solid rgba(255, 255, 255, 0.18);
                    border-radius: 24px;
                    padding: 40px;
                    width: 420px;
                    text-align: center;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                ">
                    <div style="font-size: 64px; margin-bottom: 24px;">‚úì</div>
                    <h2 style="
                        color: rgba(255, 255, 255, 0.95);
                        margin: 0 0 20px 0;
                        font-size: 22px;
                        font-weight: 500;
                        letter-spacing: 0.5px;
                    ">Ë®ÇÂñÆÂ∑≤ÂÆåÊàê</h2>
                    <p style="
                        color: rgba(255, 255, 255, 0.7);
                        font-size: 14px;
                        line-height: 1.8;
                        margin: 0 0 28px 0;
                    ">
                        ÊÇ®ÁöÑË®≠Ë®àÂ∑≤ÂÆåÊàêÔºåÂ∞áÂæàÂø´Êî∂Âà∞Ë®ÇÂñÆÁ¢∫Ë™ç‰ø°<br>
                        Áï´Èù¢Âç≥Â∞áÂ∞éÂºïËá≥ DUET ÁöÑÊØçÂìÅÁâå BCAG Ë®≠Ë®àÂ∏´Ë®ÇË£ΩÁè†ÂØ∂È¶ñÈ†Å
                    </p>
                    <div style="
                        color: rgba(212, 175, 55, 0.8);
                        font-size: 13px;
                        font-weight: 500;
                    ">3 ÁßíÂæåËá™ÂãïË∑≥ËΩâ...</div>
                </div>
            `;

            document.body.appendChild(modal);

            // 3 ÁßíÂæåË∑≥ËΩâ
            setTimeout(() => {
                window.location.href = 'https://www.brendonchen.com';
            }, 3000);
        }

        // ÁâπÊÆäÈáëÈ°çË™™ÊòéÂΩàÁ™óÔºàÂÑ™ÊÉ†Âæå ‚â§ 0 ÂÖÉÔºâ
        // ÁâπÊÆäÈáëÈ°çË™™ÊòéÂΩàÁ™óÔºàLiquid Glass È¢®Ê†ºÔºâ
        function showSpecialAmountModal(originalTotal, discount) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(20px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                modal.innerHTML = `
                    <div style="
                        background: rgba(255, 255, 255, 0.08);
                        backdrop-filter: blur(40px) saturate(180%);
                        -webkit-backdrop-filter: blur(40px) saturate(180%);
                        border: 1px solid rgba(255, 255, 255, 0.18);
                        border-radius: 24px;
                        padding: 32px 36px;
                        width: 380px;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                    ">
                        <h3 style="
                            color: rgba(255, 255, 255, 0.95);
                            margin: 0 0 22px 0;
                            font-size: 17px;
                            font-weight: 500;
                            letter-spacing: 0.3px;
                        ">ÂÑ™ÊÉ†ÊäòÊäµË™™Êòé</h3>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.2);
                            backdrop-filter: blur(10px);
                            border: 1px solid rgba(255, 255, 255, 0.08);
                            border-radius: 14px;
                            padding: 16px 18px;
                            margin-bottom: 18px;
                        ">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: rgba(255, 255, 255, 0.55); font-size: 13px;">ÂéüÂÉπ</span>
                                <span style="color: rgba(255, 255, 255, 0.4); font-size: 13px; text-decoration: line-through;">NT$ ${originalTotal.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: rgba(255, 255, 255, 0.55); font-size: 13px;">ÊäòÊâ£</span>
                                <span style="color: rgba(76, 175, 80, 0.85); font-size: 13px; font-weight: 500;">-NT$ ${discount.toLocaleString()}</span>
                            </div>
                            <div style="
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                                margin: 10px 0 0 0;
                                padding-top: 10px;
                            ">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: rgba(255, 255, 255, 0.75); font-size: 14px;">Êáâ‰ªòÈáëÈ°ç</span>
                                    <span style="color: rgba(255, 255, 255, 0.95); font-size: 14px; font-weight: 600;">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <p style="
                            color: rgba(255, 255, 255, 0.6);
                            font-size: 12px;
                            line-height: 1.6;
                            margin: 0 0 22px 0;
                        ">
                            ÂÑ™ÊÉ†ÊäòÊäµÂæåÈáëÈ°çÁÇ∫ 0 ÂÖÉ„ÄÇÁî±ÊñºÈáëÊµÅÁ≥ªÁµ±Ë¶ÅÊ±ÇÊúÄ‰Ωé‰∫§ÊòìÈáëÈ°çÁÇ∫ NT$ 1ÔºåÊÇ®Âè™ÈúÄÊîØ‰ªò <span style="color: rgba(212, 175, 55, 0.9);">NT$ 1</span> Âç≥ÂèØÂÆåÊàêË®ÇÂñÆ„ÄÇ
                        </p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="cancel-special-btn" style="
                                flex: 1;
                                padding: 11px 18px;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.15);
                                color: rgba(255, 255, 255, 0.7);
                                border-radius: 12px;
                                font-size: 14px;
                                cursor: pointer;
                                transition: all 0.3s;
                                backdrop-filter: blur(10px);
                            ">
                                ÂèñÊ∂à
                            </button>
                            <button id="confirm-special-btn" style="
                                flex: 1.2;
                                padding: 11px 18px;
                                background: rgba(212, 175, 55, 0.2);
                                border: 1px solid rgba(212, 175, 55, 0.4);
                                color: rgba(212, 175, 55, 0.95);
                                border-radius: 12px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.3s;
                                backdrop-filter: blur(10px);
                                white-space: nowrap;
                            ">
                                Á¢∫ÂÆö‰ªòÊ¨æ
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                document.getElementById('confirm-special-btn').onclick = () => {
                    modal.remove();
                    resolve(true);
                };

                document.getElementById('cancel-special-btn').onclick = () => {
                    modal.remove();
                    resolve(false);
                };

                // Hover ÊïàÊûú
                const confirmBtn = document.getElementById('confirm-special-btn');
                confirmBtn.onmouseover = () => {
                    confirmBtn.style.background = 'rgba(212, 175, 55, 0.3)';
                    confirmBtn.style.borderColor = 'rgba(212, 175, 55, 0.6)';
                };
                confirmBtn.onmouseout = () => {
                    confirmBtn.style.background = 'rgba(212, 175, 55, 0.2)';
                    confirmBtn.style.borderColor = 'rgba(212, 175, 55, 0.4)';
                };

                const cancelBtn = document.getElementById('cancel-special-btn');
                cancelBtn.onmouseover = () => {
                    cancelBtn.style.background = 'rgba(255, 255, 255, 0.08)';
                };
                cancelBtn.onmouseout = () => {
                    cancelBtn.style.background = 'rgba(255, 255, 255, 0.05)';
                };
            });
        }

        // È°ØÁ§∫Á∂†ÁïåÊîØ‰ªòË°®ÂñÆ
        function displayPaymentForm(formHTML) {
            // ‚úÖ ÁßªÈô§ user-info-modalÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (window.userInfoModal) {
                window.userInfoModal.remove();
                window.userInfoModal = null;
            }
            
            // ÂâµÂª∫ÈÅÆÁΩ©Â±§
            const overlay = document.createElement('div');
            overlay.id = 'payment-overlay';
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0,0,0,0.9); z-index: 10000; 
                            display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 15px; 
                                max-width: 500px; text-align: center;">
                        <h2 style="color: #333; margin-bottom: 15px;">Ë∑≥ËΩâËá≥Á∂†ÁïåÊîØ‰ªò...</h2>
                        <p style="color: #666; margin-bottom: 20px;">Ë´ãÁ®çÂÄôÔºåÊ≠£Âú®ÁÇ∫ÊÇ®Â∞éÂêëÊîØ‰ªòÈ†ÅÈù¢</p>
                        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; 
                                    border-top: 5px solid #3498db; border-radius: 50%; 
                                    animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        ${formHTML}
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);

            // Ëá™ÂãïÊèê‰∫§Ë°®ÂñÆ
            setTimeout(() => {
                const form = overlay.querySelector('form');
                if (form) {
                    console.log('üîÑ Ëá™ÂãïÊèê‰∫§Á∂†ÁïåË°®ÂñÆ...');
                    // ‚úÖ ÈóúÈçµ‰øÆÊîπÔºöË∑≥Âá∫ Wix iframe
                    form.target = '_top';
                    form.submit();
                }
            }, 1500);
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩ
        function setupEventListeners() {
            // ÂàùÂßãÂåñÂ≠óÊØçÈÅ∏ÂñÆ
            const letter1 = document.getElementById('letter1');
            const letter2 = document.getElementById('letter2');

            for (let i = 65; i <= 90; i++) {
                letter1.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
                letter2.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
            }
            for (let i = 97; i <= 122; i++) {
                letter1.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
                letter2.add(new Option(String.fromCharCode(i), String.fromCharCode(i)));
            }

            document.getElementById('font1-btn').addEventListener('click', openFontSelector);
            document.getElementById('font2-btn').addEventListener('click', openFontSelector);
            document.getElementById('close-modal').addEventListener('click', closeFontSelector);
            document.getElementById('confirm-btn').addEventListener('click', confirmFontSelection);

            // ÁµêÊßãÂèÉÊï∏ÊîπËÆä ‚Üí ÈáçÂª∫Ê®°Âûã
            ['letter1', 'letter2', 'size'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    // Â¶ÇÊûúÂ≠óÈ´îÈÅ∏ÊìáË¶ñÁ™óÈñãËëóÔºåÂêåÊ≠•Â≠óÊØçÂà∞Ë¶ñÁ™ó
                    const modal = document.getElementById('font-selector-modal');
                    if (modal.classList.contains('active')) {
                        const letter1 = document.getElementById('letter1').value;
                        const letter2 = document.getElementById('letter2').value;
                        const charInput = document.getElementById('char-input');
                        charInput.value = letter1 + letter2;
                        charInput.dispatchEvent(new Event('input'));
                    }

                    generateModel();
                });
            });

            // ÊùêË≥™ÂèÉÊï∏ÊîπËÆä ‚Üí Âè™Êõ¥Êñ∞ÊùêË≥™Ôºå‰∏çÈáçÂª∫Ê®°ÂûãÔºàÂç≥ÊôÇÔºÅÔºâ
            ['material', 'finish', 'plating'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    updateMaterial();
                });
            });

            ['bailX', 'bailY', 'bailZ', 'bailRotation'].forEach(id => {
                const slider = document.getElementById(id);
                slider.addEventListener('input', (e) => {
                    const suffix = id === 'bailRotation' ? '¬∞' : '';
                    document.getElementById(`${id}-val`).textContent = e.target.value + suffix;
                    // Âè™Êõ¥Êñ∞‰ΩçÁΩÆÔºå‰∏çÈáçÊñ∞ÂâµÂª∫
                    updateBailPosition();
                });
            });

            document.getElementById('save-slot-1').addEventListener('click', () => saveToSlot(0));
            document.getElementById('save-slot-2').addEventListener('click', () => saveToSlot(1));

            // Slot ÈªûÊìäÂè¨Âõû
            document.querySelector('[data-slot="1"]').addEventListener('click', () => {
                if (savedVersions[0]) loadFromSlot(0);
            });
            document.querySelector('[data-slot="2"]').addEventListener('click', () => {
                if (savedVersions[1]) loadFromSlot(1);
            });
            document.getElementById('addToCartBtn').addEventListener('click', (e) => {
                // Â¶ÇÊûúÈªûÊìäÁöÑÊòØ View Cart ÂçÄÂüüÔºåÂè™ÊâìÈñãË≥ºÁâ©Ëªä
                if (e.target.id === 'viewCartBtn' || e.target.closest('#viewCartBtn')) {
                    openCart();
                } else {
                    // Âê¶ÂâáÊòØ Add to Cart
                    addToCart();
                }
            });
            document.getElementById('continue-shopping').addEventListener('click', closeCart);
            document.getElementById('checkout').addEventListener('click', checkout);

            // Ë®≠Ë®àÁêÜÂøµÂç°ÁâáÂàáÊèõÈÇèËºØ
            const cardStyles = [
                { name: 'Á∂ìÂÖ∏È¢®Ê†º', bg: '#f5f5dc', border: '3px solid #d4af37', color: '#2d2d2d' },
                { name: 'Áèæ‰ª£È¢®Ê†º', bg: '#2d2d2d', border: '2px solid #c0c0c0', color: '#ffffff' },
                { name: 'Êµ™Êº´È¢®Ê†º', bg: '#fff5f5', border: '3px solid #dda0a0', color: '#2d2d2d' }
            ];
            let currentCardStyle = 0;

            function updateCardStyle() {
                const card = document.getElementById('story-card');
                const styleName = document.getElementById('card-style-name');
                const style = cardStyles[currentCardStyle];

                card.style.background = style.bg;
                card.style.border = style.border;
                card.style.color = style.color;
                styleName.textContent = style.name;

                // Êõ¥Êñ∞ÂÖßÂÆπÂçÄÂüüÈ°èËâ≤
                document.getElementById('story-content').style.color = style.color;
            }

            document.getElementById('prev-card-style').addEventListener('click', () => {
                currentCardStyle = (currentCardStyle - 1 + cardStyles.length) % cardStyles.length;
                updateCardStyle();
            });

            document.getElementById('next-card-style').addEventListener('click', () => {
                currentCardStyle = (currentCardStyle + 1) % cardStyles.length;
                updateCardStyle();
            });

            document.getElementById('confirm-story-card').addEventListener('click', () => {
                // Áç≤ÂèñÁ∑®ËºØÂæåÁöÑË®≠Ë®àÁêÜÂøµ
                const editedStory = document.getElementById('story-content').textContent;

                // ÂÑ≤Â≠òÂà∞ÂÖ®Â±ÄËÆäÊï∏Ôºà‰æõÂæåÁ∫åË®ÇÂñÆ‰ΩøÁî®Ôºâ
                window.finalDesignStory = editedStory;

                console.log('‚úÖ Ë®≠Ë®àÁêÜÂøµÂ∑≤Á¢∫Ë™ç:', editedStory);

                // ÈóúÈñâ Modal
                document.getElementById('design-story-modal').style.display = 'none';

                // ‚úÖ Ë®≠Ë®àÁêÜÂøµÁ¢∫Ë™çÂæåÔºåÈ°ØÁ§∫ÂÆåÊàêË®äÊÅØ‰∏¶Ë∑≥ËΩâ
                console.log('‚úÖ Ë®≠Ë®àÁêÜÂøµÊµÅÁ®ãÂÆåÊàêÔºåÈ°ØÁ§∫ÊÑüË¨ùË®äÊÅØ');
                showPaymentCompleteModal();
            });

            // ÂàùÂßãÂåñÂç°ÁâáÊ®£Âºè
            updateCardStyle();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // ÂêåÊ≠• Slot Áõ∏Ê©ü‰ΩçÁΩÆÂíåÊ∏≤Êüì
            if (slot1Camera && slot1Renderer && slot1Scene) {
                slot1Camera.position.copy(camera.position).multiplyScalar(0.5); // Á∏ÆÊîæË∑ùÈõ¢
                slot1Camera.lookAt(0, 0, 0);
                slot1Renderer.render(slot1Scene, slot1Camera);
            }
            if (slot2Camera && slot2Renderer && slot2Scene) {
                slot2Camera.position.copy(camera.position).multiplyScalar(0.5); // Á∏ÆÊîæË∑ùÈõ¢
                slot2Camera.lookAt(0, 0, 0);
                slot2Renderer.render(slot2Scene, slot2Camera);
            }

            renderer.render(scene, camera);
        }

        // ÂïüÂãï
        initScene();
        initFontSelector();
        setupEventListeners();
        animate();

        // ÂàùÂßãÂåñÂÉπÊ†ºÈ°ØÁ§∫
        updatePriceDisplay();

        // Êö¥Èú≤ÈóúÈçµÂáΩÊï∏Âà∞ÂÖ®Â±ÄÔºàÁ¢∫‰øù HTML onclick ÂèØ‰ª•Ë®™ÂïèÔºâ
        window.applyPromoCode = applyPromoCode;
        window.removePromoCode = removePromoCode;
        window.checkout = checkout;

        // Ê∏¨Ë©¶Ë®≠Ë®àÁêÜÂøµÂç°ÁâáÈ°ØÁ§∫
        window.testDesignStoryCard = function () {
            const modal = document.getElementById('design-story-modal');
            const content = document.getElementById('story-content');

            // Ê∏¨Ë©¶ÂÖßÂÆπ
            content.innerHTML = `
                ÈÄôÊòØ‰∏ÄÂÄãÈóúÊñº„ÄåL„ÄçËàá„ÄåJ„ÄçÁöÑÊïÖ‰∫ã„ÄÇ<br><br>
                
                Â≠óÊØç„ÄåL„ÄçÈÅ∏Áî®‰∫ÜÂÑ™ÈõÖÁöÑ Playfair Display Â≠óÈ´îÔºå<br>
                Ë±°ÂæµËëóÊ∫´Êüî‰∏≠Â∏∂ËëóÂäõÈáèÁöÑÂ†ÖÂÆö„ÄÇ<br><br>
                
                Â≠óÊØç„ÄåJ„ÄçÂâáÊé°Áî® Dancing Script ÊâãÂØ´È´îÔºå<br>
                Â±ïÁèæÂá∫Ëá™Áî±Â•îÊîæÁöÑÊµ™Êº´ÊÉÖÊá∑„ÄÇ<br><br>
                
                ÂÖ©ÂÄãÂ≠óÊØç‰∫§ÁπîÂú®‰∏ÄËµ∑Ôºå<br>
                Â¶ÇÂêåÂÖ©È°ÜÂøÉÈùàÁõ∏‰∫í‰æùÂÅéÔºå<br>
                ÂÖ±ÂêåË≠úÂØ´Â±¨Êñº‰Ω†ÂÄëÁöÑÁç®ÁâπÁØáÁ´†„ÄÇ
            `;

            modal.style.display = 'flex';
            console.log('‚úÖ Ë®≠Ë®àÁêÜÂøµÂç°ÁâáÂ∑≤È°ØÁ§∫');
        };

        console.log('‚úÖ ÂÖ®Â±ÄÂáΩÊï∏Â∑≤Êö¥Èú≤:', {
            applyPromoCode: typeof window.applyPromoCode,
            removePromoCode: typeof window.removePromoCode,
            checkout: typeof window.checkout,
            testDesignStoryCard: typeof window.testDesignStoryCard
        });

        // ËºâÂÖ• Google Fonts - ÂàÜÊâπËºâÂÖ•ÂèØÁî®Â≠óÈ´îÔºà‰ΩøÁî® availableFontsÔºâ
        function loadGoogleFonts() {
            if (!availableFonts || availableFonts.length === 0) return;
            const batchSize = 50;
            for (let i = 0; i < availableFonts.length; i += batchSize) {
                const batch = availableFonts.slice(i, i + batchSize);
                const link = document.createElement('link');
                link.href = 'https://fonts.googleapis.com/css2?family=' + batch.map(f => f.replace(/ /g, '+')).join('&family=') + '&display=swap';
                link.rel = 'stylesheet';
                document.head.appendChild(link);
            }
        }

        // üß™ Ê∏¨Ë©¶Áî®ÔºöÁõ¥Êé•‰∏ãËºâ STLÔºàÁ¢∫‰øù DOM ËºâÂÖ•ÂæåÁ∂ÅÂÆöÔºâ
        window.addEventListener('DOMContentLoaded', () => {
            // ==========================================
            // üîß ÊéßÂà∂ÈñãÁôºËÄÖÂäüËÉΩÊåâÈàïÈ°ØÁ§∫
            // ==========================================
            DevFeatures.toggleElement('downloadStlBtn');
            
            // üßπ Á∂ÅÂÆöÊ∏ÖÁêÜ Toggle ÈñãÈóú
            const cleanupToggle = document.getElementById('cleanup-toggle');
            const confirmOverlay = document.getElementById('cleanup-confirm-overlay');
            const confirmBtn = document.getElementById('cleanup-confirm-btn');
            const cancelBtn = document.getElementById('cleanup-cancel-btn');
            
            if (cleanupToggle && confirmOverlay && confirmBtn && cancelBtn) {
                // Toggle ÈªûÊìäÊôÇÈ°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
                cleanupToggle.addEventListener('change', function(e) {
                    if (this.checked) {
                        // ÈñãÂïü toggle ÊôÇÔºåÈ°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
                        confirmOverlay.style.display = 'flex';
                        setTimeout(() => confirmOverlay.classList.add('show'), 10);
                    }
                });
                
                // Á¢∫Ë™çÊåâÈàï
                confirmBtn.addEventListener('click', () => {
                    // ÈóúÈñâÂ∞çË©±Ê°Ü
                    confirmOverlay.classList.remove('show');
                    setTimeout(() => confirmOverlay.style.display = 'none', 300);
                    
                    // Âü∑Ë°åÊ∏ÖÁêÜ
                    cleanupFragments();
                });
                
                // ÂèñÊ∂àÊåâÈàï
                cancelBtn.addEventListener('click', () => {
                    // ÈóúÈñâÂ∞çË©±Ê°Ü
                    confirmOverlay.classList.remove('show');
                    setTimeout(() => confirmOverlay.style.display = 'none', 300);
                    
                    // ÂèñÊ∂à toggle
                    cleanupToggle.checked = false;
                });
                
                // ÈªûÊìäÈÅÆÁΩ©‰πüÈóúÈñâ
                confirmOverlay.addEventListener('click', (e) => {
                    if (e.target === confirmOverlay) {
                        confirmOverlay.classList.remove('show');
                        setTimeout(() => confirmOverlay.style.display = 'none', 300);
                        cleanupToggle.checked = false;
                    }
                });
            }

            const downloadBtn = document.getElementById('downloadStlBtn');
            
            if (!downloadBtn) {
                console.error('‚ùå Êâæ‰∏çÂà∞‰∏ãËºâ STL ÊåâÈàï');
                return;
            }
            
            downloadBtn.addEventListener('click', async () => {
                console.log('üß™ ÈªûÊìä‰∏ãËºâ STL ÊåâÈàï');
                
                // Step 1: ÂØÜÁ¢ºÈ©óË≠â
                const password = prompt('Ë´ãËº∏ÂÖ•Ê∏¨Ë©¶ÂØÜÁ¢ºÔºö');
                if (!password) {
                    console.log('‚ùå Êú™Ëº∏ÂÖ•ÂØÜÁ¢º');
                    return;
                }

                console.log('üîê È©óË≠âÂØÜÁ¢º‰∏≠...');
                
                // È©óË≠âÂØÜÁ¢ºÔºà‰ΩøÁî®ÊäòÊâ£Á¢º Google SheetsÔºâ
                const isValid = await verifyTestPassword(password);
                if (!isValid) {
                    alert('‚ùå ÂØÜÁ¢ºÈåØË™§');
                    return;
                }

            // Step 2: Ê™¢Êü•ÊòØÂê¶ÊúâÁîüÊàêÊ®°Âûã
            const letter1 = document.getElementById('letter1').value;
            const letter2 = document.getElementById('letter2').value;
            const font1 = document.getElementById('font1-select')?.value || 
                         document.getElementById('font1-btn')?.getAttribute('data-selected');
            const font2 = document.getElementById('font2-select')?.value || 
                         document.getElementById('font2-btn')?.getAttribute('data-selected');

            if (!letter1 || !letter2 || !font1 || !font2 || font1 === 'reselect' || font2 === 'reselect') {
                showToast('Ë´ãÂÖàÈÅ∏ÊìáÂ≠óÊØçÂíåÂ≠óÈ´î‰∏¶ÁîüÊàê 3D Ê®°Âûã');
                return;
            }

            // Step 3: Ê∫ñÂÇôÂèÉÊï∏
            // ‰ΩøÁî®ÂÖ®ÂüüÁöÑ modelCenterÔºàÂíåÂä†ÂÖ•Ë≥ºÁâ©Ëªä‰∏ÄÊ®£Ôºâ
            console.log('üîç Ê®°Âûã‰∏≠ÂøÉ: x=' + modelCenter.x.toFixed(3) + ', y=' + modelCenter.y.toFixed(3) + ', z=' + modelCenter.z.toFixed(3));
            
            if (bailMesh) {
                console.log('üîç Â¢úÈ†≠ÁµïÂ∞ç‰ΩçÁΩÆ: x=' + bailMesh.position.x.toFixed(3) + ', y=' + bailMesh.position.y.toFixed(3) + ', z=' + bailMesh.position.z.toFixed(3));
            }
            
            const bailRelativeX = bailMesh ? (bailMesh.position.x - modelCenter.x) : 0;
            const bailRelativeY = bailMesh ? (bailMesh.position.y - modelCenter.y) : 0;
            const bailRelativeZ = bailMesh ? (bailMesh.position.z - modelCenter.z) : 0;
            const bailRot = bailMesh ? (bailMesh.rotation.z * 180 / Math.PI) : 0;
            
            console.log('üîç Â¢úÈ†≠Áõ∏Â∞ç‰ΩçÁΩÆ: x=' + bailRelativeX.toFixed(3) + ', y=' + bailRelativeY.toFixed(3) + ', z=' + bailRelativeZ.toFixed(3) + ', rotation=' + bailRot.toFixed(1) + '¬∞');
            
            const params = {
                letter1: letter1,
                letter2: letter2,
                font1: font1,
                font2: font2,
                size: parseInt(document.getElementById('size').value),
                bailRelativeX: bailRelativeX,
                bailRelativeY: bailRelativeY,
                bailRelativeZ: bailRelativeZ,
                bailRotation: bailRot
            };

            console.log('üì§ Ë´ãÊ±Ç STL:', JSON.stringify(params, null, 2));
            console.log('üîç Â¢úÈ†≠‰ΩçÁΩÆ:', { bailRelativeX, bailRelativeY, bailRelativeZ, bailRot });

            // Step 4: ÂëºÂè´ÂæåÁ´ØÔºàÂ∏∂ÈáçË©¶Ê©üÂà∂Ôºâ
            console.log('üåê ÂëºÂè´ÂæåÁ´Ø:', `${BACKEND_URL}/api/generate-stl`);
            
            let retryCount = 0;
            const maxRetries = 2;
            
            while (retryCount <= maxRetries) {
                try {
                    if (retryCount > 0) {
                        console.log(`üîÑ ÈáçË©¶Á¨¨ ${retryCount} Ê¨°...`);
                        // Á≠âÂæÖ 2 ÁßíÂæåÈáçË©¶
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    const response = await fetch(`${BACKEND_URL}/api/generate-stl`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    });

                    console.log('üì° ÂæåÁ´ØÂõûÊáâÁãÄÊÖã:', response.status);

                    if (!response.ok) {
                        if (response.status === 502 && retryCount < maxRetries) {
                            console.warn('‚ö†Ô∏è ÂæåÁ´ØÊö´ÊôÇÁÑ°Ê≥ïÂõûÊáâ (502)ÔºåÂ∞áÈáçË©¶...');
                            retryCount++;
                            continue; // ÈáçË©¶
                        }
                        
                        const errorText = await response.text();
                        console.error('‚ùå ÂæåÁ´ØÈåØË™§:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    // Step 5: ‰∏ãËºâ STL
                    console.log('üíæ ÈñãÂßã‰∏ãËºâ STL...');
                    const blob = await response.blob();
                    console.log('üì¶ Blob Â§ßÂ∞è:', blob.size, 'bytes');
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `DUET_${letter1}${letter2}_${font1.replace(/ /g, '_')}_${font2.replace(/ /g, '_')}.stl`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    console.log('‚úÖ STL ‰∏ãËºâÂÆåÊàê');
                    showToast('‚úÖ STL Ê™îÊ°àÂ∑≤‰∏ãËºâ');
                    break; // ÊàêÂäüÔºåË∑≥Âá∫ÈáçË©¶Ëø¥Âúà

                } catch (error) {
                    if (retryCount < maxRetries && (error.message.includes('502') || error.message.includes('Load failed'))) {
                        console.warn('‚ö†Ô∏è Ë´ãÊ±ÇÂ§±ÊïóÔºåÂ∞áÈáçË©¶...', error.message);
                        retryCount++;
                        continue; // ÈáçË©¶
                    }
                    
                    // ÈáçË©¶Ê¨°Êï∏Áî®ÂÆåÊàñÂÖ∂‰ªñÈåØË™§
                    console.error('‚ùå STL ÁîüÊàêÂ§±Êïó:', error);
                    alert(`‚ùå STL ÁîüÊàêÂ§±Êïó: ${error.message}\n\nÂª∫Ë≠∞ÔºöË´ãÁ®çÂæåÂÜçË©¶ÔºåÊàñËÅØÁπ´ÂÆ¢Êúç`);
                    break;
                }
            }
        });
        
        }); // ÁµêÊùü DOMContentLoaded

        // È©óË≠âÊ∏¨Ë©¶ÂØÜÁ¢ºÔºà‰ΩøÁî®ÂæåÁ´ØÊäòÊâ£Á¢º APIÔºâ
        async function verifyTestPassword(password) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/validate-promo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        promoCode: password.trim().toUpperCase(),
                        total: 1000  // Èö®‰æø‰∏ÄÂÄãÈáëÈ°çÔºåÂè™ÊòØË¶ÅÈ©óË≠âÁ¢ºÊòØÂê¶Â≠òÂú®
                    })
                });

                const data = await response.json();
                console.log('üîë ÂØÜÁ¢ºÈ©óË≠âÁµêÊûú:', data);
                
                // Â¶ÇÊûúÊòØÊúâÊïàÁöÑÊäòÊâ£Á¢ºÔºåÂ∞±ÂÖÅË®±‰∏ãËºâ
                return data.valid === true;
            } catch (error) {
                console.error('‚ùå ÂØÜÁ¢ºÈ©óË≠âÂ§±Êïó:', error);
                return false;
            }
        }
    </script>
    <!-- ‰Ω©Êà¥Ê®°Êì¨È†êË¶ΩÊ®°ÁµÑ - Temporarily Disabled -->
    <!-- <script src="wearing-preview.js"></script> -->
    <!-- üßπ Ê∏ÖÁêÜÁ¢∫Ë™çÂ∞çË©±Ê°Ü -->
    <div class="cleanup-confirm-overlay" id="cleanup-confirm-overlay">
        <div class="cleanup-confirm-dialog">
            <div class="cleanup-confirm-title">Ê∏ÖÁêÜÈõ∂Á¢éÈÉ®‰ª∂</div>
            <div class="cleanup-confirm-message">
                Ê≠§ÂäüËÉΩÈÅãÁÆóÁ¥ÑÈúÄ 3-5 ÂàÜÈêòÔºåÁÇ∫ÈÅøÂÖçÊµ™Ë≤ªÊÇ®ÁöÑÊôÇÈñìÔºåË´ãÂÖàÁ¢∫Ë™ç‰ΩúÂìÅ‰∏≠ÊúâËàá‰∏ªÈ´îÂàÜÈõ¢ÁöÑÈõ∂Á¢éÁâ©‰ª∂ÔºåÊâçÈúÄÈñãÂïüÊ≠§ÂäüËÉΩ„ÄÇ
            </div>
            <div class="cleanup-confirm-buttons">
                <button class="cleanup-confirm-btn cancel" id="cleanup-cancel-btn">ÂèñÊ∂à</button>
                <button class="cleanup-confirm-btn confirm" id="cleanup-confirm-btn">Á¢∫Ë™ç</button>
            </div>
        </div>
    </div>

    <!-- Ëá™Ë®ÇÊèêÁ§∫Ôºà‰ΩéË™øÈ¢®Ê†ºÔºâ -->
    <div id="custom-toast" class="custom-toast">
        <div class="custom-toast-content">
            <span class="custom-toast-icon">‚ú®</span>
            <span class="custom-toast-message"></span>
        </div>
    </div>

</body>

</html>